<<<<<<< HEAD
{"version":3,"sources":["../src/wampy.js"],"names":[],"mappings":"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","file":"wampy.js","sourcesContent":["/**\n * Project: wampy.js\n *\n * https://github.com/KSDaemon/wampy.js\n *\n * A lightweight client-side implementation of\n * WAMP (The WebSocket Application Messaging Protocol v2)\n * http://wamp.ws\n *\n * Provides asynchronous RPC/PubSub over WebSocket.\n *\n * Copyright 2014 KSDaemon. Licensed under the MIT License.\n * See @license text at http://www.opensource.org/licenses/mit-license.php\n *\n */\n\nimport { WAMP_MSG_SPEC, WAMP_ERROR_MSG, isNode } from './constants';\nimport { getWebSocket, isBinaryTypeAllowed } from './utils';\nimport { JsonSerializer } from './serializers/JsonSerializer';\n\n/**\n * WAMP Client Class\n */\nclass Wampy {\n\n    /**\n     * Wampy constructor\n     * @param {string} [url]\n     * @param {Object} [options]\n     */\n    constructor (url, options) {\n\n        /**\n         * Wampy version\n         * @type {string}\n         * @private\n         */\n        this.version = 'v6.0.0';\n\n        /**\n         * WS Url\n         * @type {string}\n         * @private\n         */\n        this._url = (typeof url === 'string') ? url : null;\n\n        /**\n         * WS protocols\n         * @type {Array}\n         * @private\n         */\n        this._protocols = ['wamp.2.json'];\n\n        /**\n         * WAMP features, supported by Wampy\n         * @type {object}\n         * @private\n         */\n        this._wamp_features = {\n            agent: 'Wampy.js ' + this.version,\n            roles: {\n                publisher: {\n                    features: {\n                        subscriber_blackwhite_listing: true,\n                        publisher_exclusion: true,\n                        publisher_identification: true\n                    }\n                },\n                subscriber: {},\n                caller: {\n                    features: {\n                        caller_identification: true,\n                        progressive_call_results: true,\n                        call_canceling: true,\n                        call_timeout: true\n                    }\n                },\n                callee: {\n                    features: {\n                        caller_identification: true\n                    }\n                }\n            }\n        };\n\n        /**\n         * Internal cache for object lifetime\n         * @type {Object}\n         * @private\n         */\n        this._cache = {\n            /**\n             * WAMP Session ID\n             * @type {string}\n             */\n            sessionId: null,\n\n            /**\n             * WAMP Session scope requests ID\n             * @type {int}\n             */\n            reqId: 0,\n\n            /**\n             * Server WAMP roles and features\n             */\n            server_wamp_features: { roles: {} },\n\n            /**\n             * Are we in state of saying goodbye\n             * @type {boolean}\n             */\n            isSayingGoodbye: false,\n\n            /**\n             * Status of last operation\n             */\n            opStatus: { code: 0, description: 'Success!', reqId: 0 },\n\n            /**\n             * Timer for reconnection\n             * @type {null}\n             */\n            timer: null,\n\n            /**\n             * Reconnection attempts\n             * @type {number}\n             */\n            reconnectingAttempts: 0\n        };\n\n        /**\n         * WebSocket object\n         * @type {Object}\n         * @private\n         */\n        this._ws = null;\n\n        /**\n         * Internal queue for websocket requests, for case of disconnect\n         * @type {Array}\n         * @private\n         */\n        this._wsQueue = [];\n\n        /**\n         * Internal queue for wamp requests\n         * @type {object}\n         * @private\n         */\n        this._requests = {};\n\n        /**\n         * Stored RPC\n         * @type {object}\n         * @private\n         */\n        this._calls = {};\n\n        /**\n         * Stored Pub/Sub\n         * @type {object}\n         * @private\n         */\n        this._subscriptions = {};\n\n        /**\n         * Stored Pub/Sub topics\n         * @type {Array}\n         * @private\n         */\n        this._subsTopics = new Set();\n\n        /**\n         * Stored RPC Registrations\n         * @type {object}\n         * @private\n         */\n        this._rpcRegs = {};\n\n        /**\n         * Stored RPC names\n         * @type {Array}\n         * @private\n         */\n        this._rpcNames = new Set();\n\n        /**\n         * Options hash-table\n         * @type {Object}\n         * @private\n         */\n        this._options = {\n            /**\n             * Logging\n             * @type {boolean}\n             */\n            debug: false,\n\n            /**\n             * Reconnecting flag\n             * @type {boolean}\n             */\n            autoReconnect: true,\n\n            /**\n             * Reconnecting interval (in ms)\n             * @type {number}\n             */\n            reconnectInterval: 2 * 1000,\n\n            /**\n             * Maximum reconnection retries\n             * @type {number}\n             */\n            maxRetries: 25,\n\n            /**\n             * WAMP Realm to join\n             * @type {string}\n             */\n            realm: null,\n\n            /**\n             * Custom attributes to send to router on hello\n             * @type {object}\n             */\n            helloCustomDetails: null,\n\n            /**\n             * Authentication id to use in challenge\n             * @type {string}\n             */\n            authid: null,\n\n            /**\n             * Supported authentication methods\n             * @type {array}\n             */\n            authmethods: [],\n\n            /**\n             * onChallenge callback\n             * @type {function}\n             */\n            onChallenge: null,\n\n            /**\n             * onConnect callback\n             * @type {function}\n             */\n            onConnect: null,\n\n            /**\n             * onClose callback\n             * @type {function}\n             */\n            onClose: null,\n\n            /**\n             * onError callback\n             * @type {function}\n             */\n            onError: null,\n\n            /**\n             * onReconnect callback\n             * @type {function}\n             */\n            onReconnect: null,\n\n            /**\n             * onReconnectSuccess callback\n             * @type {function}\n             */\n            onReconnectSuccess: null,\n\n            /**\n             * User provided WebSocket class\n             * @type {function}\n             */\n            ws: null,\n\n            /**\n             * User provided msgpack class\n             * @type {object}\n             */\n            serializer: new JsonSerializer()\n        };\n\n        if (this._isPlainObject(options)) {\n            this._options = this._merge(this._options, options);\n        } else if (this._isPlainObject(url)) {\n            this._options = this._merge(this._options, url);\n        }\n\n        if (this._url) {\n            this.connect();\n        }\n\n    }\n\n    /* Internal utils methods */\n    /**\n     * Internal logger\n     * @private\n     */\n    _log () {\n        if (this._options.debug) {\n            console.log(arguments);\n        }\n    }\n\n    /**\n     * Get the new unique request id\n     * @returns {number}\n     * @private\n     */\n    _getReqId () {\n        return ++this._cache.reqId;\n    }\n\n    /**\n     * Merge argument objects into one\n     * @returns {Object}\n     * @private\n     */\n    _merge () {\n        const obj = {}, l = arguments.length;\n        let i, attr;\n\n        for (i = 0; i < l; i++) {\n            for (attr in arguments[i]) {\n                obj[attr] = arguments[i][attr];\n            }\n        }\n\n        return obj;\n    }\n\n    /**\n     * Check if value is array\n     * @param obj\n     * @returns {boolean}\n     * @private\n     */\n    _isArray (obj) {\n        return (!!obj) && (Array.isArray(obj));\n    }\n\n    /**\n     * Check if value is object literal\n     * @param obj\n     * @returns {boolean}\n     * @private\n     */\n    _isPlainObject (obj) {\n        return (!!obj) && (obj.constructor === Object);\n    }\n\n    /**\n     * Fix websocket protocols based on options\n     * @private\n     */\n    _setWsProtocols () {\n        if (!(this._options.serializer instanceof JsonSerializer)) {\n            this._protocols.unshift('wamp.2.' + this._options.serializer.protocol);\n        }\n    }\n\n    /**\n     * Prerequisite checks for any wampy api call\n     * @param {string} topicURI\n     * @param {string} role\n     * @param {object} callbacks\n     * @returns {boolean}\n     * @private\n     */\n    _preReqChecks (topicURI, role, callbacks) {\n        let flag = true;\n\n        if (this._cache.sessionId && !this._cache.server_wamp_features.roles[role]) {\n            this._cache.opStatus = WAMP_ERROR_MSG['NO_' + role.toUpperCase()];\n            flag = false;\n        }\n\n        if (topicURI && !this._validateURI(topicURI)) {\n            this._cache.opStatus = WAMP_ERROR_MSG.URI_ERROR;\n            flag = false;\n        }\n\n        if (flag) {\n            return true;\n        }\n\n        if (this._isPlainObject(callbacks) && callbacks.onError) {\n            callbacks.onError({ error: this._cache.opStatus.description });\n        }\n\n        return false;\n    }\n\n    /**\n     * Validate uri\n     * @param {string} uri\n     * @returns {boolean}\n     * @private\n     */\n    _validateURI (uri) {\n        const re = /^([0-9a-zA-Z_]+\\.)*([0-9a-zA-Z_]+)$/;\n        return !(!re.test(uri) || uri.indexOf('wamp') === 0);\n    }\n\n    /**\n     * Encode WAMP message\n     * @param {Array} msg\n     * @returns {*}\n     * @private\n     */\n    _encode (msg) {\n        try {\n            return this._options.serializer.encode(msg);\n        } catch (e) {\n            throw new Error('[wampy] encoding exception!');\n        }\n    }\n\n    /**\n     * Decode WAMP message\n     * @param  msg\n     * @returns {array}\n     * @private\n     */\n    _decode (msg) {\n        try {\n            return this._options.serializer.decode(msg);\n        } catch (e) {\n            throw new Error('[wampy] decoding exception!');\n        }\n    }\n\n    /**\n     * Send encoded message to server\n     * @param {Array} msg\n     * @private\n     */\n    _send (msg) {\n        if (msg) {\n            this._wsQueue.push(this._encode(msg));\n        }\n\n        if (this._ws && this._ws.readyState === 1 && this._cache.sessionId) {\n            while (this._wsQueue.length) {\n                this._ws.send(this._wsQueue.shift());\n            }\n        }\n    }\n\n    /**\n     * Reset internal state and cache\n     * @private\n     */\n    _resetState () {\n        this._wsQueue = [];\n        this._subscriptions = {};\n        this._subsTopics = new Set();\n        this._requests = {};\n        this._calls = {};\n        this._rpcRegs = {};\n        this._rpcNames = new Set();\n\n        // Just keep attrs that are have to be present\n        this._cache = {\n            reqId: 0,\n            reconnectingAttempts: 0\n        };\n    }\n\n    /**\n     * Initialize internal websocket callbacks\n     * @private\n     */\n    _initWsCallbacks () {\n        if (this._ws) {\n            this._ws.onopen = () => {\n                this._wsOnOpen();\n            };\n            this._ws.onclose = event => {\n                this._wsOnClose(event);\n            };\n            this._ws.onmessage = event => {\n                this._wsOnMessage(event);\n            };\n            this._ws.onerror = error => {\n                this._wsOnError(error);\n            };\n        }\n    }\n\n    /**\n     * Internal websocket on open callback\n     * @private\n     */\n    _wsOnOpen () {\n        const options = this._merge(this._options.helloCustomDetails, this._wamp_features),\n            serverProtocol = this._ws.protocol ? this._ws.protocol.split('.')[2] : '';\n\n        if (this._options.authid) {\n            options.authmethods = this._options.authmethods;\n            options.authid = this._options.authid;\n        }\n\n        this._log('[wampy] websocket connected');\n\n        if (this._options.serializer.protocol !== serverProtocol) {\n            // Server have chosen not our preferred protocol\n\n            // Falling back to json if possible\n            if (serverProtocol === 'json') {\n                this._options.serializer = new JsonSerializer();\n            } else {\n                this._cache.opStatus = WAMP_ERROR_MSG.NO_SERIALIZER_AVAILABLE;\n                return this;\n            }\n\n        }\n\n        const type = this._options.serializer.binaryType;\n\n        if (!isBinaryTypeAllowed(type)) {\n            this._cache.opStatus = WAMP_ERROR_MSG.INVALID_SERIALIZER_TYPE;\n            return this;\n        }\n\n        this._ws.binatyType = type;\n\n        // WAMP SPEC: [HELLO, Realm|uri, Details|dict]\n        // Sending directly 'cause it's a hello msg and no sessionId check is needed\n        this._ws.send(this._encode([WAMP_MSG_SPEC.HELLO, this._options.realm, options]));\n    }\n\n    /**\n     * Internal websocket on close callback\n     * @param {object} event\n     * @private\n     */\n    _wsOnClose (event) {\n        const root = isNode ? global : window;\n        this._log('[wampy] websocket disconnected. Info: ', event);\n\n        // Automatic reconnection\n        if ((this._cache.sessionId || this._cache.reconnectingAttempts) &&\n            this._options.autoReconnect && this._cache.reconnectingAttempts < this._options.maxRetries && !this._cache.isSayingGoodbye) {\n            this._cache.sessionId = null;\n            this._cache.timer = root.setTimeout(\n                () => {\n                    this._wsReconnect();\n                },\n                this._options.reconnectInterval\n            );\n        } else {\n            // No reconnection needed or reached max retries count\n            if (this._options.onClose) {\n                this._options.onClose();\n            }\n\n            this._resetState();\n            this._ws = null;\n        }\n    }\n\n    /**\n     * Internal websocket on event callback\n     * @param {object} event\n     * @private\n     */\n    _wsOnMessage (event) {\n        let data, id, i, msg, p, self = this;\n\n        this._log('[wampy] websocket message received', event.data);\n\n        data = this._decode(event.data);\n\n        switch (data[0]) {\n            case WAMP_MSG_SPEC.WELCOME:\n                // WAMP SPEC: [WELCOME, Session|id, Details|dict]\n\n                this._cache.sessionId = data[1];\n                this._cache.server_wamp_features = data[2];\n\n                if (this._cache.reconnectingAttempts) {\n                    // There was reconnection\n\n                    this._cache.reconnectingAttempts = 0;\n\n                    if (this._options.onReconnectSuccess) {\n                        this._options.onReconnectSuccess();\n                    }\n\n                    // Let's renew all previous state\n                    this._renewSubscriptions();\n                    this._renewRegistrations();\n\n                } else {\n                    // Firing onConnect event on real connection to WAMP server\n                    if (this._options.onConnect) {\n                        this._options.onConnect();\n                    }\n                }\n\n                // Send local queue if there is something out there\n                this._send();\n\n                break;\n            case WAMP_MSG_SPEC.ABORT:\n                // WAMP SPEC: [ABORT, Details|dict, Reason|uri]\n                if (this._options.onError) {\n                    this._options.onError({ error: data[2], details: data[1] });\n                }\n                this._ws.close();\n                break;\n            case WAMP_MSG_SPEC.CHALLENGE:\n                // WAMP SPEC: [CHALLENGE, AuthMethod|string, Extra|dict]\n\n                if (this._options.authid && typeof this._options.onChallenge === 'function') {\n\n                    p = new Promise((resolve, reject) => {\n                        resolve(this._options.onChallenge(data[1], data[2]));\n                    });\n\n                    p.then((key) => {\n\n                        // Sending directly 'cause it's a challenge msg and no sessionId check is needed\n                        this._ws.send(this._encode([WAMP_MSG_SPEC.AUTHENTICATE, key, {}]));\n\n                    }).catch(e => {\n                        this._ws.send(this._encode([\n                            WAMP_MSG_SPEC.ABORT,\n                            { message: 'Exception in onChallenge handler raised!' },\n                            'wamp.error.cannot_authenticate'\n                        ]));\n                        if (this._options.onError) {\n                            this._options.onError({ error: WAMP_ERROR_MSG.CRA_EXCEPTION.description });\n                        }\n                        this._ws.close();\n                        this._cache.opStatus = WAMP_ERROR_MSG.CRA_EXCEPTION;\n                    });\n\n                } else {\n\n                    this._ws.send(this._encode([\n                        WAMP_MSG_SPEC.ABORT,\n                        { message: WAMP_ERROR_MSG.NO_CRA_CB_OR_ID.description },\n                        'wamp.error.cannot_authenticate'\n                    ]));\n                    if (this._options.onError) {\n                        this._options.onError({ error: WAMP_ERROR_MSG.NO_CRA_CB_OR_ID.description });\n                    }\n                    this._ws.close();\n                    this._cache.opStatus = WAMP_ERROR_MSG.NO_CRA_CB_OR_ID;\n\n                }\n                break;\n            case WAMP_MSG_SPEC.GOODBYE:\n                // WAMP SPEC: [GOODBYE, Details|dict, Reason|uri]\n                if (!this._cache.isSayingGoodbye) {    // get goodbye, initiated by server\n                    this._cache.isSayingGoodbye = true;\n                    this._send([WAMP_MSG_SPEC.GOODBYE, {}, 'wamp.error.goodbye_and_out']);\n                }\n                this._cache.sessionId = null;\n                this._ws.close();\n                break;\n            case WAMP_MSG_SPEC.ERROR:\n                // WAMP SPEC: [ERROR, REQUEST.Type|int, REQUEST.Request|id, Details|dict,\n                //             Error|uri, (Arguments|list, ArgumentsKw|dict)]\n                switch (data[1]) {\n                    case WAMP_MSG_SPEC.SUBSCRIBE:\n                    case WAMP_MSG_SPEC.UNSUBSCRIBE:\n                    case WAMP_MSG_SPEC.PUBLISH:\n                    case WAMP_MSG_SPEC.REGISTER:\n                    case WAMP_MSG_SPEC.UNREGISTER:\n\n                        this._requests[data[2]] && this._requests[data[2]].callbacks.onError &&\n                        this._requests[data[2]].callbacks.onError({\n                            error: data[4],\n                            details: data[3],\n                            argsList: data[5],\n                            argsDict: data[6]\n                        });\n                        delete this._requests[data[2]];\n\n                        break;\n                    case WAMP_MSG_SPEC.INVOCATION:\n                        break;\n                    case WAMP_MSG_SPEC.CALL:\n\n                        // WAMP SPEC: [ERROR, CALL, CALL.Request|id, Details|dict,\n                        //             Error|uri, Arguments|list, ArgumentsKw|dict]\n                        this._calls[data[2]] && this._calls[data[2]].onError &&\n                        this._calls[data[2]].onError({\n                            error   : data[4],\n                            details : data[3],\n                            argsList: data[5],\n                            argsDict: data[6]\n                        });\n                        delete this._calls[data[2]];\n\n                        break;\n                    default:\n                        this._log('[wampy] Received non-compliant WAMP ERROR message');\n                        break;\n                }\n                break;\n            case WAMP_MSG_SPEC.SUBSCRIBED:\n                // WAMP SPEC: [SUBSCRIBED, SUBSCRIBE.Request|id, Subscription|id]\n                if (this._requests[data[1]]) {\n                    this._subscriptions[this._requests[data[1]].topic] = this._subscriptions[data[2]] = {\n                        id: data[2],\n                        callbacks: [this._requests[data[1]].callbacks.onEvent]\n                    };\n\n                    this._subsTopics.add(this._requests[data[1]].topic);\n\n                    if (this._requests[data[1]].callbacks.onSuccess) {\n                        this._requests[data[1]].callbacks.onSuccess();\n                    }\n\n                    delete this._requests[data[1]];\n\n                }\n                break;\n            case WAMP_MSG_SPEC.UNSUBSCRIBED:\n                // WAMP SPEC: [UNSUBSCRIBED, UNSUBSCRIBE.Request|id]\n                if (this._requests[data[1]]) {\n                    id = this._subscriptions[this._requests[data[1]].topic].id;\n                    delete this._subscriptions[this._requests[data[1]].topic];\n                    delete this._subscriptions[id];\n\n                    if (this._subsTopics.has(this._requests[data[1]].topic)) {\n                        this._subsTopics.delete(this._requests[data[1]].topic);\n                    }\n\n                    if (this._requests[data[1]].callbacks.onSuccess) {\n                        this._requests[data[1]].callbacks.onSuccess();\n                    }\n\n                    delete this._requests[data[1]];\n                }\n                break;\n            case WAMP_MSG_SPEC.PUBLISHED:\n                // WAMP SPEC: [PUBLISHED, PUBLISH.Request|id, Publication|id]\n                if (this._requests[data[1]]) {\n                    if (this._requests[data[1]].callbacks && this._requests[data[1]].callbacks.onSuccess) {\n                        this._requests[data[1]].callbacks.onSuccess();\n                    }\n\n                    delete this._requests[data[1]];\n\n                }\n                break;\n            case WAMP_MSG_SPEC.EVENT:\n                if (this._subscriptions[data[1]]) {\n\n                    // WAMP SPEC: [EVENT, SUBSCRIBED.Subscription|id, PUBLISHED.Publication|id,\n                    //             Details|dict, PUBLISH.Arguments|list, PUBLISH.ArgumentKw|dict]\n\n                    i = this._subscriptions[data[1]].callbacks.length;\n                    while (i--) {\n                        this._subscriptions[data[1]].callbacks[i]({\n                            details : data[3],\n                            argsList: data[4],\n                            argsDict: data[5]\n                        });\n                    }\n\n                }\n                break;\n            case WAMP_MSG_SPEC.RESULT:\n                if (this._calls[data[1]]) {\n\n                    // WAMP SPEC: [RESULT, CALL.Request|id, Details|dict,\n                    //             YIELD.Arguments|list, YIELD.ArgumentsKw|dict]\n\n                    this._calls[data[1]].onSuccess({\n                        details : data[2],\n                        argsList: data[3],\n                        argsDict: data[4]\n                    });\n                    if (!(data[2].progress && data[2].progress === true)) {\n                        // We receive final result (progressive or not)\n                        delete this._calls[data[1]];\n                    }\n\n                }\n                break;\n            // case WAMP_MSG_SPEC.REGISTER:\n            //     // WAMP SPEC:\n            //     break;\n            case WAMP_MSG_SPEC.REGISTERED:\n                // WAMP SPEC: [REGISTERED, REGISTER.Request|id, Registration|id]\n                if (this._requests[data[1]]) {\n                    this._rpcRegs[this._requests[data[1]].topic] = this._rpcRegs[data[2]] = {\n                        id: data[2],\n                        callbacks: [this._requests[data[1]].callbacks.rpc]\n                    };\n\n                    this._rpcNames.add(this._requests[data[1]].topic);\n\n                    if (this._requests[data[1]].callbacks && this._requests[data[1]].callbacks.onSuccess) {\n                        this._requests[data[1]].callbacks.onSuccess();\n                    }\n\n                    delete this._requests[data[1]];\n\n                }\n                break;\n            // case WAMP_MSG_SPEC.UNREGISTER:\n            //     // WAMP SPEC:\n            //     break;\n            case WAMP_MSG_SPEC.UNREGISTERED:\n                // WAMP SPEC: [UNREGISTERED, UNREGISTER.Request|id]\n                if (this._requests[data[1]]) {\n                    id = this._rpcRegs[this._requests[data[1]].topic].id;\n                    delete this._rpcRegs[this._requests[data[1]].topic];\n                    delete this._rpcRegs[id];\n\n                    if (this._rpcNames.has(this._requests[data[1]].topic)) {\n                        this._rpcNames.delete(this._requests[data[1]].topic);\n                    }\n\n                    if (this._requests[data[1]].callbacks && this._requests[data[1]].callbacks.onSuccess) {\n                        this._requests[data[1]].callbacks.onSuccess();\n                    }\n\n                    delete this._requests[data[1]];\n                }\n                break;\n            case WAMP_MSG_SPEC.INVOCATION:\n                if (this._rpcRegs[data[2]]) {\n\n                    // WAMP SPEC: [INVOCATION, Request|id, REGISTERED.Registration|id,\n                    //             Details|dict, CALL.Arguments|list, CALL.ArgumentsKw|dict]\n\n                    let invoke_result_handler = function (results) {\n                            // WAMP SPEC: [YIELD, INVOCATION.Request|id, Options|dict, (Arguments|list, ArgumentsKw|dict)]\n                            let msg = [WAMP_MSG_SPEC.YIELD, data[1], {}];\n\n                            if (self._isPlainObject(results)) {\n\n                                if (self._isPlainObject(results.options)) {\n                                    msg[2] = results.options;\n                                }\n\n                                if (self._isArray(results.argsList)) {\n                                    msg.push(results.argsList);\n                                } else if (typeof (results.argsList) !== 'undefined') {\n                                    msg.push([results.argsList]);\n                                }\n\n                                if (self._isPlainObject(results.argsDict)) {\n                                    if (msg.length === 3) {\n                                        msg.push([]);\n                                    }\n                                    msg.push(results.argsDict);\n                                }\n                            } else {\n                                msg = [WAMP_MSG_SPEC.YIELD, data[1], {}];\n                            }\n                            self._send(msg);\n                        },\n                        invoke_error_handler = function (e) {\n                            let msg = [WAMP_MSG_SPEC.ERROR, WAMP_MSG_SPEC.INVOCATION,\n                                data[1], e.details || {}, e.error || 'wamp.error.invocation_exception'];\n\n                            if (e.argsList && self._isArray(e.argsList)) {\n                                msg.push(e.argsList);\n                            }\n\n                            if (e.argsDict && self._isPlainObject(e.argsDict)) {\n                                if (msg.length === 5) {\n                                    msg.push([]);\n                                }\n                                msg.push(e.argsDict);\n                            }\n                            self._send(msg);\n                        };\n\n                    p = new Promise((resolve, reject) => {\n                        resolve(this._rpcRegs[data[2]].callbacks[0]({\n                            details : data[3],\n                            argsList: data[4],\n                            argsDict: data[5],\n                            result_handler: invoke_result_handler,\n                            error_handler: invoke_error_handler\n                        }));\n                    });\n\n                    p.then((results) => {\n                        invoke_result_handler(results);\n                    }).catch(e => {\n                        invoke_error_handler(e);\n                    });\n\n                } else {\n                    // WAMP SPEC: [ERROR, INVOCATION, INVOCATION.Request|id, Details|dict, Error|uri]\n                    this._send([WAMP_MSG_SPEC.ERROR, WAMP_MSG_SPEC.INVOCATION,\n                        data[1], {}, 'wamp.error.no_such_procedure']);\n                    this._cache.opStatus = WAMP_ERROR_MSG.NON_EXIST_RPC_INVOCATION;\n                }\n\n                break;\n            // case WAMP_MSG_SPEC.INTERRUPT:\n            //     // WAMP SPEC:\n            //     break;\n            // case WAMP_MSG_SPEC.YIELD:\n            //     // WAMP SPEC:\n            //     break;\n            default:\n                this._log('[wampy] Received non-compliant WAMP message');\n                break;\n        }\n    }\n\n    /**\n     * Internal websocket on error callback\n     * @param {object} error\n     * @private\n     */\n    _wsOnError (error) {\n        this._log('[wampy] websocket error');\n\n        if (this._options.onError) {\n            this._options.onError({ error: error });\n        }\n    }\n\n    /**\n     * Reconnect to server in case of websocket error\n     * @private\n     */\n    _wsReconnect () {\n        this._log('[wampy] websocket reconnecting...');\n\n        if (this._options.onReconnect) {\n            this._options.onReconnect();\n        }\n\n        this._cache.reconnectingAttempts++;\n        this._ws = getWebSocket(this._url, this._protocols, this._options.ws);\n        this._initWsCallbacks();\n    }\n\n    /**\n     * Resubscribe to topics in case of communication error\n     * @private\n     */\n    _renewSubscriptions () {\n        let i;\n        const subs = this._subscriptions,\n            st = this._subsTopics;\n\n        this._subscriptions = {};\n        this._subsTopics = new Set();\n\n        for (let topic of st) {\n            i = subs[topic].callbacks.length;\n            while (i--) {\n                this.subscribe(topic, subs[topic].callbacks[i]);\n            }\n        }\n    }\n\n    /**\n     * Reregister RPCs in case of communication error\n     * @private\n     */\n    _renewRegistrations () {\n        const rpcs = this._rpcRegs,\n            rn = this._rpcNames;\n\n        this._rpcRegs = {};\n        this._rpcNames = new Set();\n\n        for (let rpcName of rn) {\n            this.register(rpcName, { rpc: rpcs[rpcName].callbacks[0] });\n        }\n    }\n\n    /* Wampy public API */\n\n    /**\n     * Get or set Wampy options\n     *\n     * To get options - call without parameters\n     * To set options - pass hash-table with options values\n     *\n     * @param {object} [opts]\n     * @returns {*}\n     */\n    options (opts) {\n        if (typeof (opts) === 'undefined') {\n            return this._options;\n        } else if (this._isPlainObject(opts)) {\n            this._options = this._merge(this._options, opts);\n            return this;\n        }\n    }\n\n    /**\n     * Get the status of last operation\n     *\n     * @returns {object} with 2 fields: code, description\n     *      code: 0 - if operation was successful\n     *      code > 0 - if error occurred\n     *      description contains details about error\n     *      reqId: last send request ID\n     */\n    getOpStatus () {\n        return this._cache.opStatus;\n    }\n\n    /**\n     * Get the WAMP Session ID\n     *\n     * @returns {string} Session ID\n     */\n    getSessionId () {\n        return this._cache.sessionId;\n    }\n\n    /**\n     * Connect to server\n     * @param {string} [url] New url (optional)\n     * @returns {Wampy}\n     */\n    connect (url) {\n        if (url) {\n            this._url = url;\n        }\n\n        if (this._options.realm) {\n\n            const authp = (this._options.authid ? 1 : 0) +\n                ((this._isArray(this._options.authmethods) && this._options.authmethods.length) ? 1 : 0) +\n                (typeof this._options.onChallenge === 'function' ? 1 : 0);\n\n            if (authp > 0 && authp < 3) {\n                this._cache.opStatus = WAMP_ERROR_MSG.NO_CRA_CB_OR_ID;\n                return this;\n            }\n\n            this._setWsProtocols();\n            this._ws = getWebSocket(this._url, this._protocols, this._options.ws);\n            if (!this._ws) {\n                this._cache.opStatus = WAMP_ERROR_MSG.NO_WS_OR_URL;\n                return this;\n            }\n            this._initWsCallbacks();\n\n        } else {\n            this._cache.opStatus = WAMP_ERROR_MSG.NO_REALM;\n        }\n\n        return this;\n    }\n\n    /**\n     * Disconnect from server\n     * @returns {Wampy}\n     */\n    disconnect () {\n        if (this._cache.sessionId) {\n            // need to send goodbye message to server\n            this._cache.isSayingGoodbye = true;\n            this._send([WAMP_MSG_SPEC.GOODBYE, {}, 'wamp.error.system_shutdown']);\n        } else if (this._ws) {\n            this._ws.close();\n        }\n\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n\n        return this;\n    }\n\n    /**\n     * Abort WAMP session establishment\n     *\n     * @returns {Wampy}\n     */\n    abort () {\n\n        if (!this._cache.sessionId && this._ws.readyState === 1) {\n            this._send([WAMP_MSG_SPEC.ABORT, {}, 'wamp.error.abort']);\n            this._cache.sessionId = null;\n        }\n\n        this._ws.close();\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n\n        return this;\n    }\n\n    /**\n     * Subscribe to a topic on a broker\n     *\n     * @param {string} topicURI\n     * @param {function|object} callbacks - if it is a function - it will be treated as published event callback\n     *                          or it can be hash table of callbacks:\n     *                          { onSuccess: will be called when subscribe would be confirmed\n     *                            onError: will be called if subscribe would be aborted\n     *                            onEvent: will be called on receiving published event }\n     *\n     * @returns {Wampy}\n     */\n    subscribe (topicURI, callbacks) {\n        let reqId;\n\n        if (!this._preReqChecks(topicURI, 'broker', callbacks)) {\n            return this;\n        }\n\n        if (typeof callbacks === 'function') {\n            callbacks = { onEvent: callbacks };\n        } else if (!this._isPlainObject(callbacks) || typeof (callbacks.onEvent) === 'undefined') {\n            this._cache.opStatus = WAMP_ERROR_MSG.NO_CALLBACK_SPEC;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        if (!this._subscriptions[topicURI] || !this._subscriptions[topicURI].callbacks.length) {\n            // no such subscription or processing unsubscribing\n\n            reqId = this._getReqId();\n\n            this._requests[reqId] = {\n                topic: topicURI,\n                callbacks: callbacks\n            };\n\n            // WAMP SPEC: [SUBSCRIBE, Request|id, Options|dict, Topic|uri]\n            this._send([WAMP_MSG_SPEC.SUBSCRIBE, reqId, {}, topicURI]);\n\n        } else {    // already have subscription to this topic\n            // There is no such callback yet\n            if (this._subscriptions[topicURI].callbacks.indexOf(callbacks.onEvent) < 0) {\n                this._subscriptions[topicURI].callbacks.push(callbacks.onEvent);\n            }\n\n            if (callbacks.onSuccess) {\n                callbacks.onSuccess();\n            }\n        }\n\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n        return this;\n    }\n\n    /**\n     * Unsubscribe from topic\n     * @param {string} topicURI\n     * @param {function|object} callbacks - if it is a function - it will be treated as\n     *                          published event callback to remove or it can be hash table of callbacks:\n     *                          { onSuccess: will be called when unsubscribe would be confirmed\n     *                            onError: will be called if unsubscribe would be aborted\n     *                            onEvent: published event callback to remove }\n     * @returns {Wampy}\n     */\n    unsubscribe (topicURI, callbacks) {\n        let reqId, i = -1;\n\n        if (!this._preReqChecks(null, 'broker', callbacks)) {\n            return this;\n        }\n\n        if (this._subscriptions[topicURI]) {\n\n            reqId = this._getReqId();\n\n            if (typeof (callbacks) === 'undefined') {\n                this._subscriptions[topicURI].callbacks = [];\n                callbacks = {};\n            } else if (typeof callbacks === 'function') {\n                i = this._subscriptions[topicURI].callbacks.indexOf(callbacks);\n                callbacks = {};\n            } else if (callbacks.onEvent && typeof callbacks.onEvent === 'function') {\n                i = this._subscriptions[topicURI].callbacks.indexOf(callbacks.onEvent);\n            } else {\n                this._subscriptions[topicURI].callbacks = [];\n            }\n\n            if (i >= 0) {\n                this._subscriptions[topicURI].callbacks.splice(i, 1);\n            }\n\n            if (this._subscriptions[topicURI].callbacks.length) {\n                // There are another callbacks for this topic\n                this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n                return this;\n            }\n\n            this._requests[reqId] = {\n                topic: topicURI,\n                callbacks: callbacks\n            };\n\n            // WAMP_SPEC: [UNSUBSCRIBE, Request|id, SUBSCRIBED.Subscription|id]\n            this._send([WAMP_MSG_SPEC.UNSUBSCRIBE, reqId, this._subscriptions[topicURI].id]);\n\n        } else {\n            this._cache.opStatus = WAMP_ERROR_MSG.NON_EXIST_UNSUBSCRIBE;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n        return this;\n    }\n\n    /**\n     * Publish a event to topic\n     * @param {string} topicURI\n     * @param {string|number|Array|object} payload - can be either a value of any type or null.  Also it\n     *                          is possible to pass array and object-like data simultaneously.\n     *                          In this case pass a hash-table with next attributes:\n     *                          {\n     *                             argsList: array payload (may be omitted)\n     *                             argsDict: object payload (may be omitted)\n     *                          }\n     * @param {object} [callbacks] - optional hash table of callbacks:\n     *                          { onSuccess: will be called when publishing would be confirmed\n     *                            onError: will be called if publishing would be aborted }\n     * @param {object} advancedOptions - optional parameter. Must include any or all of the options:\n     *                          { exclude: integer|array WAMP session id(s) that won't receive a published event,\n     *                                      even though they may be subscribed\n     *                            exclude_authid: string|array Authentication id(s) that won't receive\n     *                                      a published event, even though they may be subscribed\n     *                            exclude_authrole: string|array Authentication role(s) that won't receive\n     *                                      a published event, even though they may be subscribed\n     *                            eligible: integer|array WAMP session id(s) that are allowed\n     *                                      to receive a published event\n     *                            eligible_authid: string|array Authentication id(s) that are allowed\n     *                                      to receive a published event\n     *                            eligible_authrole: string|array Authentication role(s) that are allowed\n     *                                      to receive a published event\n     *                            exclude_me: bool flag of receiving publishing event by initiator\n     *                            disclose_me: bool flag of disclosure of publisher identity (its WAMP session ID)\n     *                                      to receivers of a published event }\n     * @returns {Wampy}\n     */\n    publish (topicURI, payload, callbacks, advancedOptions) {\n        let reqId, msg, err = false, hasPayload = false;\n        const options = {},\n            _optionsConvertHelper = (option, sourceType) => {\n                if (advancedOptions[option]) {\n                    if (this._isArray(advancedOptions[option]) && advancedOptions[option].length) {\n                        options[option] = advancedOptions[option];\n                    } else if (typeof advancedOptions[option] === sourceType) {\n                        options[option] = [advancedOptions[option]];\n                    } else {\n                        err = true;\n                    }\n                }\n            };\n\n        if (!this._preReqChecks(topicURI, 'broker', callbacks)) {\n            return this;\n        }\n\n        if (this._isPlainObject(callbacks)) {\n            options.acknowledge = true;\n        }\n\n        if (typeof (advancedOptions) !== 'undefined') {\n\n            if (this._isPlainObject(advancedOptions)) {\n                _optionsConvertHelper('exclude', 'number');\n                _optionsConvertHelper('exclude_authid', 'string');\n                _optionsConvertHelper('exclude_authrole', 'string');\n                _optionsConvertHelper('eligible', 'number');\n                _optionsConvertHelper('eligible_authid', 'string');\n                _optionsConvertHelper('eligible_authrole', 'string');\n\n                if (advancedOptions.hasOwnProperty('exclude_me')) {\n                    options.exclude_me = advancedOptions.exclude_me !== false;\n                }\n\n                if (advancedOptions.hasOwnProperty('disclose_me')) {\n                    options.disclose_me = advancedOptions.disclose_me === true;\n                }\n\n            } else {\n                err = true;\n            }\n\n            if (err) {\n                this._cache.opStatus = WAMP_ERROR_MSG.INVALID_PARAM;\n\n                if (this._isPlainObject(callbacks) && callbacks.onError) {\n                    callbacks.onError({ error: this._cache.opStatus.description });\n                }\n\n                return this;\n            }\n        }\n\n        reqId = this._getReqId();\n\n        switch (arguments.length) {\n            case 1:\n                break;\n            case 2:\n                hasPayload = true;\n                break;\n            default:\n                this._requests[reqId] = {\n                    topic: topicURI,\n                    callbacks: callbacks\n                };\n                hasPayload = true;\n                break;\n        }\n\n        // WAMP_SPEC: [PUBLISH, Request|id, Options|dict, Topic|uri]\n        msg = [WAMP_MSG_SPEC.PUBLISH, reqId, options, topicURI];\n\n        if (hasPayload) {\n            // WAMP_SPEC: [PUBLISH, Request|id, Options|dict, Topic|uri, Arguments|list (, ArgumentsKw|dict)]\n            if (this._isArray(payload)) {\n                msg.push(payload);\n            } else if (this._isPlainObject(payload)) {\n                // It's a wampy unified form of payload passing\n                if (payload.argsList || payload.argsDict) {\n                    if (payload.argsList) {\n                        msg.push(payload.argsList);\n                    }\n\n                    if (payload.argsDict) {\n                        if (msg.length === 4) {\n                            msg.push([]);\n                        }\n                        msg.push(payload.argsDict);\n                    }\n                } else {\n                    msg.push([], payload);\n                }\n            } else {    // assume it's a single value\n                msg.push([payload]);\n            }\n        }\n\n        this._send(msg);\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n        return this;\n    }\n\n    /**\n     * Remote Procedure Call\n     * @param {string} topicURI\n     * @param {string|number|Array|object} payload - can be either a value of any type or null.  Also it\n     *                          is possible to pass array and object-like data simultaneously.\n     *                          In this case pass a hash-table with next attributes:\n     *                          {\n     *                             argsList: array payload (may be omitted)\n     *                             argsDict: object payload (may be omitted)\n     *                          }\n     * @param {function|object} callbacks - if it is a function - it will be treated as result callback function\n     *                          or it can be hash table of callbacks:\n     *                          { onSuccess: will be called with result on successful call\n     *                            onError: will be called if invocation would be aborted }\n     * @param {object} advancedOptions - optional parameter. Must include any or all of the options:\n     *                          { disclose_me: bool flag of disclosure of Caller identity (WAMP session ID)\n     *                                  to endpoints of a routed call\n     *                            receive_progress: bool flag for receiving progressive results. In this case\n     *                                  onSuccess function will be called every time on receiving result\n     *                            timeout: integer timeout (in ms) for the call to finish }\n     * @returns {Wampy}\n     */\n    call (topicURI, payload, callbacks, advancedOptions) {\n        let reqId, msg, err = false;\n        const options = {};\n\n        if (!this._preReqChecks(topicURI, 'dealer', callbacks)) {\n            return this;\n        }\n\n        if (typeof callbacks === 'function') {\n            callbacks = { onSuccess: callbacks };\n        } else if (!this._isPlainObject(callbacks) || typeof (callbacks.onSuccess) === 'undefined') {\n            this._cache.opStatus = WAMP_ERROR_MSG.NO_CALLBACK_SPEC;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        if (typeof (advancedOptions) !== 'undefined') {\n\n            if (this._isPlainObject(advancedOptions)) {\n                if (advancedOptions.hasOwnProperty('disclose_me')) {\n                    options.disclose_me = advancedOptions.disclose_me === true;\n                }\n\n                if (advancedOptions.hasOwnProperty('receive_progress')) {\n                    options.receive_progress = advancedOptions.receive_progress === true;\n                }\n\n                if (advancedOptions.hasOwnProperty('timeout')) {\n                    if (typeof advancedOptions.timeout === 'number') {\n                        options.timeout = advancedOptions.timeout;\n                    } else {\n                        err = true;\n                    }\n                }\n\n            } else {\n                err = true;\n            }\n\n            if (err) {\n                this._cache.opStatus = WAMP_ERROR_MSG.INVALID_PARAM;\n\n                if (this._isPlainObject(callbacks) && callbacks.onError) {\n                    callbacks.onError({ error: this._cache.opStatus.description });\n                }\n\n                return this;\n            }\n        }\n\n        do {\n            reqId = this._getReqId();\n        } while (reqId in this._calls);\n\n        this._calls[reqId] = callbacks;\n\n        // WAMP SPEC: [CALL, Request|id, Options|dict, Procedure|uri, (Arguments|list, ArgumentsKw|dict)]\n        msg = [WAMP_MSG_SPEC.CALL, reqId, options, topicURI];\n\n        if (payload !== null) {\n            if (this._isArray(payload)) {\n                msg.push(payload);\n            } else if (this._isPlainObject(payload)) {\n                // It's a wampy unified form of payload passing\n                if (payload.argsList || payload.argsDict) {\n                    if (payload.argsList) {\n                        msg.push(payload.argsList);\n                    }\n\n                    if (payload.argsDict) {\n                        if (msg.length === 4) {\n                            msg.push([]);\n                        }\n                        msg.push(payload.argsDict);\n                    }\n                } else {\n                    msg.push([], payload);\n                }\n            } else {    // assume it's a single value\n                msg.push([payload]);\n            }\n        }\n\n        this._send(msg);\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n        return this;\n    }\n\n    /**\n     * RPC invocation cancelling\n     *\n     * @param {int} reqId RPC call request ID\n     * @param {function|object} callbacks - if it is a function - it will be called if successfully\n     *                          sent canceling message or it can be hash table of callbacks:\n     *                          { onSuccess: will be called if successfully sent canceling message\n     *                            onError: will be called if some error occurred }\n     * @param {object} advancedOptions - optional parameter. Must include any or all of the options:\n     *                          { mode: string|one of the possible modes:\n     *                                  \"skip\" | \"kill\" | \"killnowait\". Skip is default.\n     *                          }\n     *\n     * @returns {Wampy}\n     */\n    cancel (reqId, callbacks, advancedOptions) {\n        const options = { mode: 'skip' };\n\n        if (!this._preReqChecks(null, 'dealer', callbacks)) {\n            return this;\n        }\n\n        if (!reqId || !this._calls[reqId]) {\n            this._cache.opStatus = WAMP_ERROR_MSG.NON_EXIST_RPC_REQ_ID;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        if ((typeof (advancedOptions) !== 'undefined') &&\n            (this._isPlainObject(advancedOptions)) &&\n            (advancedOptions.hasOwnProperty('mode'))) {\n\n            options.mode = /skip|kill|killnowait/.test(advancedOptions.mode) ? advancedOptions.mode : 'skip';\n        }\n\n        // WAMP SPEC: [CANCEL, CALL.Request|id, Options|dict]\n        this._send([WAMP_MSG_SPEC.CANCEL, reqId, options]);\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n\n        callbacks.onSuccess && callbacks.onSuccess();\n\n        return this;\n    }\n\n    /**\n     * RPC registration for invocation\n     * @param {string} topicURI\n     * @param {function|object} callbacks - if it is a function - it will be treated as rpc itself\n     *                          or it can be hash table of callbacks:\n     *                          { rpc: registered procedure\n     *                            onSuccess: will be called on successful registration\n     *                            onError: will be called if registration would be aborted }\n     * @returns {Wampy}\n     */\n    register (topicURI, callbacks) {\n        let reqId;\n\n        if (!this._preReqChecks(topicURI, 'dealer', callbacks)) {\n            return this;\n        }\n\n        if (typeof callbacks === 'function') {\n            callbacks = { rpc: callbacks };\n        } else if (!this._isPlainObject(callbacks) || typeof (callbacks.rpc) === 'undefined') {\n            this._cache.opStatus = WAMP_ERROR_MSG.NO_CALLBACK_SPEC;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        if (!this._rpcRegs[topicURI] || !this._rpcRegs[topicURI].callbacks.length) {\n            // no such registration or processing unregistering\n\n            reqId = this._getReqId();\n\n            this._requests[reqId] = {\n                topic: topicURI,\n                callbacks: callbacks\n            };\n\n            // WAMP SPEC: [REGISTER, Request|id, Options|dict, Procedure|uri]\n            this._send([WAMP_MSG_SPEC.REGISTER, reqId, {}, topicURI]);\n            this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n            this._cache.opStatus.reqId = reqId;\n        } else {    // already have registration with such topicURI\n            this._cache.opStatus = WAMP_ERROR_MSG.RPC_ALREADY_REGISTERED;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n        }\n\n        return this;\n\n    }\n\n    /**\n     * RPC unregistration for invocation\n     * @param {string} topicURI\n     * @param {function|object} callbacks - if it is a function, it will be called on successful unregistration\n     *                          or it can be hash table of callbacks:\n     *                          { onSuccess: will be called on successful unregistration\n     *                            onError: will be called if unregistration would be aborted }\n     * @returns {Wampy}\n     */\n    unregister (topicURI, callbacks) {\n        let reqId;\n\n        if (!this._preReqChecks(topicURI, 'dealer', callbacks)) {\n            return this;\n        }\n\n        if (typeof callbacks === 'function') {\n            callbacks = { onSuccess: callbacks };\n        }\n\n        if (this._rpcRegs[topicURI]) {   // there is such registration\n\n            reqId = this._getReqId();\n\n            this._requests[reqId] = {\n                topic: topicURI,\n                callbacks: callbacks\n            };\n\n            // WAMP SPEC: [UNREGISTER, Request|id, REGISTERED.Registration|id]\n            this._send([WAMP_MSG_SPEC.UNREGISTER, reqId, this._rpcRegs[topicURI].id]);\n            this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n            this._cache.opStatus.reqId = reqId;\n        } else {    // there is no registration with such topicURI\n            this._cache.opStatus = WAMP_ERROR_MSG.NON_EXIST_RPC_UNREG;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n        }\n\n        return this;\n    }\n}\n\nexport default Wampy;\nexport { Wampy };\n"]}
||||||| merged common ancestors
{"version":3,"sources":["../src/wampy.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AAgBA;;AACA;;AACA;;;;;;;;IAKM,K;;;;;;;;AAOF,mBAAa,GAAb,EAAkB,OAAlB,EAA2B;AAAA;;;;;;;AAOvB,aAAK,OAAL,GAAe,QAAf;;;;;;;AAOA,aAAK,IAAL,GAAa,OAAO,GAAP,KAAe,QAAhB,GAA4B,GAA5B,GAAkC,IAA9C;;;;;;;AAOA,aAAK,UAAL,GAAkB,CAAC,aAAD,CAAlB;;;;;;;AAOA,aAAK,cAAL,GAAsB;AAClB,mBAAO,cAAc,KAAK,OADR;AAElB,mBAAO;AACH,2BAAW;AACP,8BAAU;AACN,uDAA+B,IADzB;AAEN,6CAAqB,IAFf;AAGN,kDAA0B;AAHpB;AADH,iBADR;AAQH,4BAAY,EART;AASH,wBAAQ;AACJ,8BAAU;AACN,+CAAuB,IADjB;AAEN,kDAA0B,IAFpB;AAGN,wCAAgB,IAHV;AAIN,sCAAc;AAJR;AADN,iBATL;AAiBH,wBAAQ;AACJ,8BAAU;AACN,+CAAuB;AADjB;AADN;AAjBL;AAFW,SAAtB;;;;;;;AAgCA,aAAK,MAAL,GAAc;;;;;AAKV,uBAAW,IALD;;;;;;AAWV,mBAAO,CAXG;;;;;AAgBV,kCAAsB,EAAE,OAAO,EAAT,EAhBZ;;;;;;AAsBV,6BAAiB,KAtBP;;;;;AA2BV,sBAAU,EAAE,MAAM,CAAR,EAAW,aAAa,UAAxB,EAAoC,OAAO,CAA3C,EA3BA;;;;;;AAiCV,mBAAO,IAjCG;;;;;;AAuCV,kCAAsB;AAvCZ,SAAd;;;;;;;AA+CA,aAAK,GAAL,GAAW,IAAX;;;;;;;AAOA,aAAK,QAAL,GAAgB,EAAhB;;;;;;;AAOA,aAAK,SAAL,GAAiB,EAAjB;;;;;;;AAOA,aAAK,MAAL,GAAc,EAAd;;;;;;;AAOA,aAAK,cAAL,GAAsB,EAAtB;;;;;;;AAOA,aAAK,WAAL,GAAmB,IAAI,GAAJ,EAAnB;;;;;;;AAOA,aAAK,QAAL,GAAgB,EAAhB;;;;;;;AAOA,aAAK,SAAL,GAAiB,IAAI,GAAJ,EAAjB;;;;;;;AAOA,aAAK,QAAL,GAAgB;;;;;AAKZ,mBAAO,KALK;;;;;;AAWZ,2BAAe,IAXH;;;;;;AAiBZ,+BAAmB,IAAI,IAjBX;;;;;;AAuBZ,wBAAY,EAvBA;;;;;;AA6BZ,mBAAO,IA7BK;;;;;;AAmCZ,gCAAoB,IAnCR;;;;;;AAyCZ,oBAAQ,IAzCI;;;;;;AA+CZ,yBAAa,EA/CD;;;;;;AAqDZ,yBAAa,IArDD;;;;;;AA2DZ,uBAAW,IA3DC;;;;;;AAiEZ,qBAAS,IAjEG;;;;;;AAuEZ,qBAAS,IAvEG;;;;;;AA6EZ,yBAAa,IA7ED;;;;;;AAmFZ,gCAAoB,IAnFR;;;;;;AAyFZ,gBAAI,IAzFQ;;;;;;AA+FZ,wBAAY;AA/FA,SAAhB;;AAkGA,YAAI,KAAK,cAAL,CAAoB,OAApB,CAAJ,EAAkC;AAC9B,iBAAK,QAAL,GAAgB,KAAK,MAAL,CAAY,KAAK,QAAjB,EAA2B,OAA3B,CAAhB;AACH,SAFD,MAEO,IAAI,KAAK,cAAL,CAAoB,GAApB,CAAJ,EAA8B;AACjC,iBAAK,QAAL,GAAgB,KAAK,MAAL,CAAY,KAAK,QAAjB,EAA2B,GAA3B,CAAhB;AACH;;AAED,YAAI,KAAK,IAAT,EAAe;AACX,iBAAK,OAAL;AACH;AAEJ;;;;;;;;;;;+BAOO;AACJ,gBAAI,KAAK,QAAL,CAAc,KAAlB,EAAyB;AACrB,wBAAQ,GAAR,CAAY,SAAZ;AACH;AACJ;;;;;;;;;;oCAOY;AACT,mBAAO,EAAE,KAAK,MAAL,CAAY,KAArB;AACH;;;;;;;;;;iCAOS;AACN,gBAAM,MAAM,EAAZ;gBAAgB,IAAI,UAAU,MAA9B;AACA,gBAAI,UAAJ;gBAAO,aAAP;;AAEA,iBAAK,IAAI,CAAT,EAAY,IAAI,CAAhB,EAAmB,GAAnB,EAAwB;AACpB,qBAAK,IAAL,IAAa,UAAU,CAAV,CAAb,EAA2B;AACvB,wBAAI,IAAJ,IAAY,UAAU,CAAV,EAAa,IAAb,CAAZ;AACH;AACJ;;AAED,mBAAO,GAAP;AACH;;;;;;;;;;;iCAQS,G,EAAK;AACX,mBAAQ,CAAC,CAAC,GAAH,IAAY,MAAM,OAAN,CAAc,GAAd,CAAnB;AACH;;;;;;;;;;;uCAQe,G,EAAK;AACjB,mBAAQ,CAAC,CAAC,GAAH,IAAY,IAAI,WAAJ,KAAoB,MAAvC;AACH;;;;;;;;;0CAMkB;AACf,gBAAI,EAAE,KAAK,QAAL,CAAc,UAAd,0CAAF,CAAJ,EAA2D;AACvD,qBAAK,UAAL,CAAgB,OAAhB,CAAwB,YAAY,KAAK,QAAL,CAAc,UAAd,CAAyB,QAA7D;AACH;AACJ;;;;;;;;;;;;;sCAUc,Q,EAAU,I,EAAM,S,EAAW;AACtC,gBAAI,OAAO,IAAX;;AAEA,gBAAI,KAAK,MAAL,CAAY,SAAZ,IAAyB,CAAC,KAAK,MAAL,CAAY,oBAAZ,CAAiC,KAAjC,CAAuC,IAAvC,CAA9B,EAA4E;AACxE,qBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,QAAQ,KAAK,WAAL,EAAvB,CAAvB;AACA,uBAAO,KAAP;AACH;;AAED,gBAAI,YAAY,CAAC,KAAK,YAAL,CAAkB,QAAlB,CAAjB,EAA8C;AAC1C,qBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,SAAtC;AACA,uBAAO,KAAP;AACH;;AAED,gBAAI,IAAJ,EAAU;AACN,uBAAO,IAAP;AACH;;AAED,gBAAI,KAAK,cAAL,CAAoB,SAApB,KAAkC,UAAU,OAAhD,EAAyD;AACrD,0BAAU,OAAV,CAAkB,EAAE,OAAO,KAAK,MAAL,CAAY,QAAZ,CAAqB,WAA9B,EAAlB;AACH;;AAED,mBAAO,KAAP;AACH;;;;;;;;;;;qCAQa,G,EAAK;AACf,gBAAM,KAAK,2CAAX;AACA,mBAAO,EAAE,CAAC,GAAG,IAAH,CAAQ,GAAR,CAAD,IAAiB,IAAI,OAAJ,CAAY,MAAZ,MAAwB,CAA3C,CAAP;AACH;;;;;;;;;;;gCAQQ,G,EAAK;AACV,gBAAI;AACA,uBAAO,KAAK,QAAL,CAAc,UAAd,CAAyB,MAAzB,CAAgC,GAAhC,CAAP;AACH,aAFD,CAEE,OAAO,CAAP,EAAU;AACR,sBAAM,IAAI,KAAJ,CAAU,6BAAV,CAAN;AACH;AACJ;;;;;;;;;;;gCAQQ,G,EAAK;AACV,gBAAI;AACA,uBAAO,KAAK,QAAL,CAAc,UAAd,CAAyB,MAAzB,CAAgC,GAAhC,CAAP;AACH,aAFD,CAEE,OAAO,CAAP,EAAU;AACR,sBAAM,IAAI,KAAJ,CAAU,6BAAV,CAAN;AACH;AACJ;;;;;;;;;;8BAOM,G,EAAK;AACR,gBAAI,GAAJ,EAAS;AACL,qBAAK,QAAL,CAAc,IAAd,CAAmB,KAAK,OAAL,CAAa,GAAb,CAAnB;AACH;;AAED,gBAAI,KAAK,GAAL,IAAY,KAAK,GAAL,CAAS,UAAT,KAAwB,CAApC,IAAyC,KAAK,MAAL,CAAY,SAAzD,EAAoE;AAChE,uBAAO,KAAK,QAAL,CAAc,MAArB,EAA6B;AACzB,yBAAK,GAAL,CAAS,IAAT,CAAc,KAAK,QAAL,CAAc,KAAd,EAAd;AACH;AACJ;AACJ;;;;;;;;;sCAMc;AACX,iBAAK,QAAL,GAAgB,EAAhB;AACA,iBAAK,cAAL,GAAsB,EAAtB;AACA,iBAAK,WAAL,GAAmB,IAAI,GAAJ,EAAnB;AACA,iBAAK,SAAL,GAAiB,EAAjB;AACA,iBAAK,MAAL,GAAc,EAAd;AACA,iBAAK,QAAL,GAAgB,EAAhB;AACA,iBAAK,SAAL,GAAiB,IAAI,GAAJ,EAAjB;;;AAGA,iBAAK,MAAL,GAAc;AACV,uBAAO,CADG;AAEV,sCAAsB;AAFZ,aAAd;AAIH;;;;;;;;;2CAMmB;AAAA;;AAChB,gBAAI,KAAK,GAAT,EAAc;AACV,qBAAK,GAAL,CAAS,MAAT,GAAkB,YAAM;AACpB,0BAAK,SAAL;AACH,iBAFD;AAGA,qBAAK,GAAL,CAAS,OAAT,GAAmB,iBAAS;AACxB,0BAAK,UAAL,CAAgB,KAAhB;AACH,iBAFD;AAGA,qBAAK,GAAL,CAAS,SAAT,GAAqB,iBAAS;AAC1B,0BAAK,YAAL,CAAkB,KAAlB;AACH,iBAFD;AAGA,qBAAK,GAAL,CAAS,OAAT,GAAmB,iBAAS;AACxB,0BAAK,UAAL,CAAgB,KAAhB;AACH,iBAFD;AAGH;AACJ;;;;;;;;;oCAMY;AACT,gBAAM,UAAU,KAAK,MAAL,CAAY,KAAK,QAAL,CAAc,kBAA1B,EAA8C,KAAK,cAAnD,CAAhB;gBACI,iBAAiB,KAAK,GAAL,CAAS,QAAT,GAAoB,KAAK,GAAL,CAAS,QAAT,CAAkB,KAAlB,CAAwB,GAAxB,EAA6B,CAA7B,CAApB,GAAsD,EAD3E;;AAGA,gBAAI,KAAK,QAAL,CAAc,MAAlB,EAA0B;AACtB,wBAAQ,WAAR,GAAsB,KAAK,QAAL,CAAc,WAApC;AACA,wBAAQ,MAAR,GAAiB,KAAK,QAAL,CAAc,MAA/B;AACH;;AAED,iBAAK,IAAL,CAAU,6BAAV;;AAEA,gBAAI,KAAK,QAAL,CAAc,UAAd,CAAyB,QAAzB,KAAsC,cAA1C,EAA0D;;;;AAItD,oBAAI,mBAAmB,MAAvB,EAA+B;AAC3B,yBAAK,QAAL,CAAc,UAAd,GAA2B,oCAA3B;AACH,iBAFD,MAEO;AACH,yBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,uBAAtC;AACA,2BAAO,IAAP;AACH;AAEJ;;AAED,gBAAM,OAAO,KAAK,QAAL,CAAc,UAAd,CAAyB,UAAtC;;AAEA,gBAAI,CAAC,gCAAoB,IAApB,CAAL,EAAgC;AAC5B,qBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,uBAAtC;AACA,uBAAO,IAAP;AACH;;AAED,iBAAK,GAAL,CAAS,UAAT,GAAsB,IAAtB;;;;AAIA,iBAAK,GAAL,CAAS,IAAT,CAAc,KAAK,OAAL,CAAa,CAAC,yBAAc,KAAf,EAAsB,KAAK,QAAL,CAAc,KAApC,EAA2C,OAA3C,CAAb,CAAd;AACH;;;;;;;;;;mCAOW,K,EAAO;AAAA;;AACf,gBAAM,OAAO,oBAAS,MAAT,GAAkB,MAA/B;AACA,iBAAK,IAAL,CAAU,wCAAV,EAAoD,KAApD;;;AAGA,gBAAI,CAAC,KAAK,MAAL,CAAY,SAAZ,IAAyB,KAAK,MAAL,CAAY,oBAAtC,KACA,KAAK,QAAL,CAAc,aADd,IAC+B,KAAK,MAAL,CAAY,oBAAZ,GAAmC,KAAK,QAAL,CAAc,UADhF,IAC8F,CAAC,KAAK,MAAL,CAAY,eAD/G,EACgI;AAC5H,qBAAK,MAAL,CAAY,SAAZ,GAAwB,IAAxB;AACA,qBAAK,MAAL,CAAY,KAAZ,GAAoB,KAAK,UAAL,CAChB,YAAM;AACF,2BAAK,YAAL;AACH,iBAHe,EAIhB,KAAK,QAAL,CAAc,iBAJE,CAApB;AAMH,aATD,MASO;;AAEH,oBAAI,KAAK,QAAL,CAAc,OAAlB,EAA2B;AACvB,yBAAK,QAAL,CAAc,OAAd;AACH;;AAED,qBAAK,WAAL;AACA,qBAAK,GAAL,GAAW,IAAX;AACH;AACJ;;;;;;;;;;qCAOa,K,EAAO;AAAA;;AACjB,gBAAI,aAAJ;gBAAU,WAAV;gBAAc,UAAd;gBAAiB,YAAjB;gBAAsB,UAAtB;;AAEA,iBAAK,IAAL,CAAU,oCAAV,EAAgD,MAAM,IAAtD;;AAEA,mBAAO,KAAK,OAAL,CAAa,MAAM,IAAnB,CAAP;;AAEA,oBAAQ,KAAK,CAAL,CAAR;AACI,qBAAK,yBAAc,OAAnB;;;AAGI,yBAAK,MAAL,CAAY,SAAZ,GAAwB,KAAK,CAAL,CAAxB;AACA,yBAAK,MAAL,CAAY,oBAAZ,GAAmC,KAAK,CAAL,CAAnC;;AAEA,wBAAI,KAAK,MAAL,CAAY,oBAAhB,EAAsC;;;AAGlC,6BAAK,MAAL,CAAY,oBAAZ,GAAmC,CAAnC;;AAEA,4BAAI,KAAK,QAAL,CAAc,kBAAlB,EAAsC;AAClC,iCAAK,QAAL,CAAc,kBAAd;AACH;;;AAGD,6BAAK,mBAAL;AACA,6BAAK,mBAAL;AAEH,qBAbD,MAaO;;AAEH,4BAAI,KAAK,QAAL,CAAc,SAAlB,EAA6B;AACzB,iCAAK,QAAL,CAAc,SAAd;AACH;AACJ;;;AAGD,yBAAK,KAAL;;AAEA;AACJ,qBAAK,yBAAc,KAAnB;;AAEI,wBAAI,KAAK,QAAL,CAAc,OAAlB,EAA2B;AACvB,6BAAK,QAAL,CAAc,OAAd,CAAsB,EAAE,OAAO,KAAK,CAAL,CAAT,EAAkB,SAAS,KAAK,CAAL,CAA3B,EAAtB;AACH;AACD,yBAAK,GAAL,CAAS,KAAT;AACA;AACJ,qBAAK,yBAAc,SAAnB;;;AAGI,wBAAI,KAAK,QAAL,CAAc,MAAd,IAAwB,OAAO,KAAK,QAAL,CAAc,WAArB,KAAqC,UAAjE,EAA6E;;AAEzE,4BAAI,IAAI,OAAJ,CAAY,UAAC,OAAD,EAAU,MAAV,EAAqB;AACjC,oCAAQ,OAAK,QAAL,CAAc,WAAd,CAA0B,KAAK,CAAL,CAA1B,EAAmC,KAAK,CAAL,CAAnC,CAAR;AACH,yBAFG,CAAJ;;AAIA,0BAAE,IAAF,CAAO,UAAC,GAAD,EAAS;;;AAGZ,mCAAK,GAAL,CAAS,IAAT,CAAc,OAAK,OAAL,CAAa,CAAC,yBAAc,YAAf,EAA6B,GAA7B,EAAkC,EAAlC,CAAb,CAAd;AAEH,yBALD,EAKG,KALH,CAKS,aAAK;AACV,mCAAK,GAAL,CAAS,IAAT,CAAc,OAAK,OAAL,CAAa,CACvB,yBAAc,KADS,EAEvB,EAAE,SAAS,0CAAX,EAFuB,EAGvB,gCAHuB,CAAb,CAAd;AAKA,gCAAI,OAAK,QAAL,CAAc,OAAlB,EAA2B;AACvB,uCAAK,QAAL,CAAc,OAAd,CAAsB,EAAE,OAAO,0BAAe,aAAf,CAA6B,WAAtC,EAAtB;AACH;AACD,mCAAK,GAAL,CAAS,KAAT;AACA,mCAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,aAAtC;AACH,yBAhBD;AAkBH,qBAxBD,MAwBO;;AAEH,6BAAK,GAAL,CAAS,IAAT,CAAc,KAAK,OAAL,CAAa,CACvB,yBAAc,KADS,EAEvB,EAAE,SAAS,0BAAe,eAAf,CAA+B,WAA1C,EAFuB,EAGvB,gCAHuB,CAAb,CAAd;AAKA,4BAAI,KAAK,QAAL,CAAc,OAAlB,EAA2B;AACvB,iCAAK,QAAL,CAAc,OAAd,CAAsB,EAAE,OAAO,0BAAe,eAAf,CAA+B,WAAxC,EAAtB;AACH;AACD,6BAAK,GAAL,CAAS,KAAT;AACA,6BAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,eAAtC;AAEH;AACD;AACJ,qBAAK,yBAAc,OAAnB;;AAEI,wBAAI,CAAC,KAAK,MAAL,CAAY,eAAjB,EAAkC;;AAC9B,6BAAK,MAAL,CAAY,eAAZ,GAA8B,IAA9B;AACA,6BAAK,KAAL,CAAW,CAAC,yBAAc,OAAf,EAAwB,EAAxB,EAA4B,4BAA5B,CAAX;AACH;AACD,yBAAK,MAAL,CAAY,SAAZ,GAAwB,IAAxB;AACA,yBAAK,GAAL,CAAS,KAAT;AACA;AACJ,qBAAK,yBAAc,KAAnB;;;AAGI,4BAAQ,KAAK,CAAL,CAAR;AACI,6BAAK,yBAAc,SAAnB;AACA,6BAAK,yBAAc,WAAnB;AACA,6BAAK,yBAAc,OAAnB;AACA,6BAAK,yBAAc,QAAnB;AACA,6BAAK,yBAAc,UAAnB;;AAEI,iCAAK,SAAL,CAAe,KAAK,CAAL,CAAf,KAA2B,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,OAA7D,IACA,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,OAAlC,CAA0C;AACtC,uCAAO,KAAK,CAAL,CAD+B;AAEtC,yCAAS,KAAK,CAAL,CAF6B;AAGtC,0CAAU,KAAK,CAAL,CAH4B;AAItC,0CAAU,KAAK,CAAL;AAJ4B,6BAA1C,CADA;AAOA,mCAAO,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,CAAP;;AAEA;AACJ,6BAAK,yBAAc,UAAnB;AACI;AACJ,6BAAK,yBAAc,IAAnB;;;;AAII,iCAAK,MAAL,CAAY,KAAK,CAAL,CAAZ,KAAwB,KAAK,MAAL,CAAY,KAAK,CAAL,CAAZ,EAAqB,OAA7C,IACA,KAAK,MAAL,CAAY,KAAK,CAAL,CAAZ,EAAqB,OAArB,CAA6B;AACzB,uCAAU,KAAK,CAAL,CADe;AAEzB,yCAAU,KAAK,CAAL,CAFe;AAGzB,0CAAU,KAAK,CAAL,CAHe;AAIzB,0CAAU,KAAK,CAAL;AAJe,6BAA7B,CADA;AAOA,mCAAO,KAAK,MAAL,CAAY,KAAK,CAAL,CAAZ,CAAP;;AAEA;AACJ;AACI,iCAAK,IAAL,CAAU,mDAAV;AACA;AAnCR;AAqCA;AACJ,qBAAK,yBAAc,UAAnB;;AAEI,wBAAI,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,CAAJ,EAA6B;AACzB,6BAAK,cAAL,CAAoB,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,KAA5C,IAAqD,KAAK,cAAL,CAAoB,KAAK,CAAL,CAApB,IAA+B;AAChF,gCAAI,KAAK,CAAL,CAD4E;AAEhF,uCAAW,CAAC,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,OAAnC;AAFqE,yBAApF;;AAKA,6BAAK,WAAL,CAAiB,GAAjB,CAAqB,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,KAA7C;;AAEA,4BAAI,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,SAAtC,EAAiD;AAC7C,iCAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,SAAlC;AACH;;AAED,+BAAO,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,CAAP;AAEH;AACD;AACJ,qBAAK,yBAAc,YAAnB;;AAEI,wBAAI,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,CAAJ,EAA6B;AACzB,6BAAK,KAAK,cAAL,CAAoB,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,KAA5C,EAAmD,EAAxD;AACA,+BAAO,KAAK,cAAL,CAAoB,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,KAA5C,CAAP;AACA,+BAAO,KAAK,cAAL,CAAoB,EAApB,CAAP;;AAEA,4BAAI,KAAK,WAAL,CAAiB,GAAjB,CAAqB,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,KAA7C,CAAJ,EAAyD;AACrD,iCAAK,WAAL,CAAiB,MAAjB,CAAwB,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,KAAhD;AACH;;AAED,4BAAI,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,SAAtC,EAAiD;AAC7C,iCAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,SAAlC;AACH;;AAED,+BAAO,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,CAAP;AACH;AACD;AACJ,qBAAK,yBAAc,SAAnB;;AAEI,wBAAI,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,CAAJ,EAA6B;AACzB,4BAAI,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,IAAqC,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,SAA3E,EAAsF;AAClF,iCAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,SAAlC;AACH;;AAED,+BAAO,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,CAAP;AAEH;AACD;AACJ,qBAAK,yBAAc,KAAnB;AACI,wBAAI,KAAK,cAAL,CAAoB,KAAK,CAAL,CAApB,CAAJ,EAAkC;;;;;AAK9B,4BAAI,KAAK,cAAL,CAAoB,KAAK,CAAL,CAApB,EAA6B,SAA7B,CAAuC,MAA3C;AACA,+BAAO,GAAP,EAAY;AACR,iCAAK,cAAL,CAAoB,KAAK,CAAL,CAApB,EAA6B,SAA7B,CAAuC,CAAvC,EAA0C;AACtC,yCAAU,KAAK,CAAL,CAD4B;AAEtC,0CAAU,KAAK,CAAL,CAF4B;AAGtC,0CAAU,KAAK,CAAL;AAH4B,6BAA1C;AAKH;AAEJ;AACD;AACJ,qBAAK,yBAAc,MAAnB;AACI,wBAAI,KAAK,MAAL,CAAY,KAAK,CAAL,CAAZ,CAAJ,EAA0B;;;;;AAKtB,6BAAK,MAAL,CAAY,KAAK,CAAL,CAAZ,EAAqB,SAArB,CAA+B;AAC3B,qCAAU,KAAK,CAAL,CADiB;AAE3B,sCAAU,KAAK,CAAL,CAFiB;AAG3B,sCAAU,KAAK,CAAL;AAHiB,yBAA/B;AAKA,4BAAI,EAAE,KAAK,CAAL,EAAQ,QAAR,IAAoB,KAAK,CAAL,EAAQ,QAAR,KAAqB,IAA3C,CAAJ,EAAsD;;AAElD,mCAAO,KAAK,MAAL,CAAY,KAAK,CAAL,CAAZ,CAAP;AACH;AAEJ;AACD;;;;AAIJ,qBAAK,yBAAc,UAAnB;;AAEI,wBAAI,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,CAAJ,EAA6B;AACzB,6BAAK,QAAL,CAAc,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,KAAtC,IAA+C,KAAK,QAAL,CAAc,KAAK,CAAL,CAAd,IAAyB;AACpE,gCAAI,KAAK,CAAL,CADgE;AAEpE,uCAAW,CAAC,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,GAAnC;AAFyD,yBAAxE;;AAKA,6BAAK,SAAL,CAAe,GAAf,CAAmB,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,KAA3C;;AAEA,4BAAI,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,IAAqC,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,SAA3E,EAAsF;AAClF,iCAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,SAAlC;AACH;;AAED,+BAAO,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,CAAP;AAEH;AACD;;;;AAIJ,qBAAK,yBAAc,YAAnB;;AAEI,wBAAI,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,CAAJ,EAA6B;AACzB,6BAAK,KAAK,QAAL,CAAc,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,KAAtC,EAA6C,EAAlD;AACA,+BAAO,KAAK,QAAL,CAAc,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,KAAtC,CAAP;AACA,+BAAO,KAAK,QAAL,CAAc,EAAd,CAAP;;AAEA,4BAAI,KAAK,SAAL,CAAe,GAAf,CAAmB,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,KAA3C,CAAJ,EAAuD;AACnD,iCAAK,SAAL,CAAe,MAAf,CAAsB,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,KAA9C;AACH;;AAED,4BAAI,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,IAAqC,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,SAA3E,EAAsF;AAClF,iCAAK,SAAL,CAAe,KAAK,CAAL,CAAf,EAAwB,SAAxB,CAAkC,SAAlC;AACH;;AAED,+BAAO,KAAK,SAAL,CAAe,KAAK,CAAL,CAAf,CAAP;AACH;AACD;AACJ,qBAAK,yBAAc,UAAnB;AACI,wBAAI,KAAK,QAAL,CAAc,KAAK,CAAL,CAAd,CAAJ,EAA4B;;;;;AAKxB,4BAAI,IAAI,OAAJ,CAAY,UAAC,OAAD,EAAU,MAAV,EAAqB;AACjC,oCAAQ,OAAK,QAAL,CAAc,KAAK,CAAL,CAAd,EAAuB,SAAvB,CAAiC,CAAjC,EAAoC;AACxC,yCAAU,KAAK,CAAL,CAD8B;AAExC,0CAAU,KAAK,CAAL,CAF8B;AAGxC,0CAAU,KAAK,CAAL;AAH8B,6BAApC,CAAR;AAKH,yBANG,CAAJ;;AAQA,0BAAE,IAAF,CAAO,UAAC,OAAD,EAAa;;AAEhB,kCAAM,CAAC,yBAAc,KAAf,EAAsB,KAAK,CAAL,CAAtB,EAA+B,EAA/B,CAAN;;AAEA,gCAAI,OAAK,cAAL,CAAoB,OAApB,CAAJ,EAAkC;;AAE9B,oCAAI,OAAK,cAAL,CAAoB,QAAQ,OAA5B,CAAJ,EAA0C;AACtC,wCAAI,CAAJ,IAAS,QAAQ,OAAjB;AACH;;AAED,oCAAI,OAAK,QAAL,CAAc,QAAQ,QAAtB,CAAJ,EAAqC;AACjC,wCAAI,IAAJ,CAAS,QAAQ,QAAjB;AACH,iCAFD,MAEO,IAAI,OAAQ,QAAQ,QAAhB,KAA8B,WAAlC,EAA+C;AAClD,wCAAI,IAAJ,CAAS,CAAC,QAAQ,QAAT,CAAT;AACH;;AAED,oCAAI,OAAK,cAAL,CAAoB,QAAQ,QAA5B,CAAJ,EAA2C;AACvC,wCAAI,IAAI,MAAJ,KAAe,CAAnB,EAAsB;AAClB,4CAAI,IAAJ,CAAS,EAAT;AACH;AACD,wCAAI,IAAJ,CAAS,QAAQ,QAAjB;AACH;AACJ,6BAlBD,MAkBO;AACH,sCAAM,CAAC,yBAAc,KAAf,EAAsB,KAAK,CAAL,CAAtB,EAA+B,EAA/B,CAAN;AACH;AACD,mCAAK,KAAL,CAAW,GAAX;AACH,yBA1BD,EA0BG,KA1BH,CA0BS,aAAK;AACV,gCAAI,MAAM,CAAC,yBAAc,KAAf,EAAsB,yBAAc,UAApC,EACN,KAAK,CAAL,CADM,EACG,EAAE,OAAF,IAAa,EADhB,EACoB,EAAE,KAAF,IAAW,iCAD/B,CAAV;;AAGA,gCAAI,EAAE,QAAF,IAAc,OAAK,QAAL,CAAc,EAAE,QAAhB,CAAlB,EAA6C;AACzC,oCAAI,IAAJ,CAAS,EAAE,QAAX;AACH;;AAED,gCAAI,EAAE,QAAF,IAAc,OAAK,cAAL,CAAoB,EAAE,QAAtB,CAAlB,EAAmD;AAC/C,oCAAI,IAAI,MAAJ,KAAe,CAAnB,EAAsB;AAClB,wCAAI,IAAJ,CAAS,EAAT;AACH;AACD,oCAAI,IAAJ,CAAS,EAAE,QAAX;AACH;AACD,mCAAK,KAAL,CAAW,GAAX;AACH,yBAzCD;AA2CH,qBAxDD,MAwDO;;AAEH,6BAAK,KAAL,CAAW,CAAC,yBAAc,KAAf,EAAsB,yBAAc,UAApC,EACP,KAAK,CAAL,CADO,EACE,EADF,EACM,8BADN,CAAX;AAEA,6BAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,wBAAtC;AACH;;AAED;;;;;;;AAOJ;AACI,yBAAK,IAAL,CAAU,6CAAV;AACA;AAvUR;AAyUH;;;;;;;;;;mCAOW,K,EAAO;AACf,iBAAK,IAAL,CAAU,yBAAV;;AAEA,gBAAI,KAAK,QAAL,CAAc,OAAlB,EAA2B;AACvB,qBAAK,QAAL,CAAc,OAAd,CAAsB,EAAE,OAAO,KAAT,EAAtB;AACH;AACJ;;;;;;;;;uCAMe;AACZ,iBAAK,IAAL,CAAU,mCAAV;;AAEA,gBAAI,KAAK,QAAL,CAAc,WAAlB,EAA+B;AAC3B,qBAAK,QAAL,CAAc,WAAd;AACH;;AAED,iBAAK,MAAL,CAAY,oBAAZ;AACA,iBAAK,GAAL,GAAW,yBAAa,KAAK,IAAlB,EAAwB,KAAK,UAA7B,EAAyC,KAAK,QAAL,CAAc,EAAvD,CAAX;AACA,iBAAK,gBAAL;AACH;;;;;;;;;8CAMsB;AACnB,gBAAI,UAAJ;AACA,gBAAM,OAAO,KAAK,cAAlB;gBACI,KAAK,KAAK,WADd;;AAGA,iBAAK,cAAL,GAAsB,EAAtB;AACA,iBAAK,WAAL,GAAmB,IAAI,GAAJ,EAAnB;;AANmB;AAAA;AAAA;;AAAA;AAQnB,qCAAkB,EAAlB,8HAAsB;AAAA,wBAAb,KAAa;;AAClB,wBAAI,KAAK,KAAL,EAAY,SAAZ,CAAsB,MAA1B;AACA,2BAAO,GAAP,EAAY;AACR,6BAAK,SAAL,CAAe,KAAf,EAAsB,KAAK,KAAL,EAAY,SAAZ,CAAsB,CAAtB,CAAtB;AACH;AACJ;AAbkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AActB;;;;;;;;;8CAMsB;AACnB,gBAAM,OAAO,KAAK,QAAlB;gBACI,KAAK,KAAK,SADd;;AAGA,iBAAK,QAAL,GAAgB,EAAhB;AACA,iBAAK,SAAL,GAAiB,IAAI,GAAJ,EAAjB;;AALmB;AAAA;AAAA;;AAAA;AAOnB,sCAAoB,EAApB,mIAAwB;AAAA,wBAAf,OAAe;;AACpB,yBAAK,QAAL,CAAc,OAAd,EAAuB,EAAE,KAAK,KAAK,OAAL,EAAc,SAAd,CAAwB,CAAxB,CAAP,EAAvB;AACH;AATkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAUtB;;;;;;;;;;;;;;;;gCAaQ,I,EAAM;AACX,gBAAI,OAAQ,IAAR,KAAkB,WAAtB,EAAmC;AAC/B,uBAAO,KAAK,QAAZ;AACH,aAFD,MAEO,IAAI,KAAK,cAAL,CAAoB,IAApB,CAAJ,EAA+B;AAClC,qBAAK,QAAL,GAAgB,KAAK,MAAL,CAAY,KAAK,QAAjB,EAA2B,IAA3B,CAAhB;AACA,uBAAO,IAAP;AACH;AACJ;;;;;;;;;;;;;;sCAWc;AACX,mBAAO,KAAK,MAAL,CAAY,QAAnB;AACH;;;;;;;;;;uCAOe;AACZ,mBAAO,KAAK,MAAL,CAAY,SAAnB;AACH;;;;;;;;;;gCAOQ,G,EAAK;AACV,gBAAI,GAAJ,EAAS;AACL,qBAAK,IAAL,GAAY,GAAZ;AACH;;AAED,gBAAI,KAAK,QAAL,CAAc,KAAlB,EAAyB;;AAErB,oBAAM,QAAQ,CAAC,KAAK,QAAL,CAAc,MAAd,GAAuB,CAAvB,GAA2B,CAA5B,KACR,KAAK,QAAL,CAAc,KAAK,QAAL,CAAc,WAA5B,KAA4C,KAAK,QAAL,CAAc,WAAd,CAA0B,MAAvE,GAAiF,CAAjF,GAAqF,CAD5E,KAET,OAAO,KAAK,QAAL,CAAc,WAArB,KAAqC,UAArC,GAAkD,CAAlD,GAAsD,CAF7C,CAAd;;AAIA,oBAAI,QAAQ,CAAR,IAAa,QAAQ,CAAzB,EAA4B;AACxB,yBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,eAAtC;AACA,2BAAO,IAAP;AACH;;AAED,qBAAK,eAAL;AACA,qBAAK,GAAL,GAAW,yBAAa,KAAK,IAAlB,EAAwB,KAAK,UAA7B,EAAyC,KAAK,QAAL,CAAc,EAAvD,CAAX;AACA,oBAAI,CAAC,KAAK,GAAV,EAAe;AACX,yBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,YAAtC;AACA,2BAAO,IAAP;AACH;AACD,qBAAK,gBAAL;AAEH,aAnBD,MAmBO;AACH,qBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,QAAtC;AACH;;AAED,mBAAO,IAAP;AACH;;;;;;;;;qCAMa;AACV,gBAAI,KAAK,MAAL,CAAY,SAAhB,EAA2B;;AAEvB,qBAAK,MAAL,CAAY,eAAZ,GAA8B,IAA9B;AACA,qBAAK,KAAL,CAAW,CAAC,yBAAc,OAAf,EAAwB,EAAxB,EAA4B,4BAA5B,CAAX;AACH,aAJD,MAIO,IAAI,KAAK,GAAT,EAAc;AACjB,qBAAK,GAAL,CAAS,KAAT;AACH;;AAED,iBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,OAAtC;;AAEA,mBAAO,IAAP;AACH;;;;;;;;;;gCAOQ;;AAEL,gBAAI,CAAC,KAAK,MAAL,CAAY,SAAb,IAA0B,KAAK,GAAL,CAAS,UAAT,KAAwB,CAAtD,EAAyD;AACrD,qBAAK,KAAL,CAAW,CAAC,yBAAc,KAAf,EAAsB,EAAtB,EAA0B,kBAA1B,CAAX;AACA,qBAAK,MAAL,CAAY,SAAZ,GAAwB,IAAxB;AACH;;AAED,iBAAK,GAAL,CAAS,KAAT;AACA,iBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,OAAtC;;AAEA,mBAAO,IAAP;AACH;;;;;;;;;;;;;;;;;kCAcU,Q,EAAU,S,EAAW;AAC5B,gBAAI,cAAJ;;AAEA,gBAAI,CAAC,KAAK,aAAL,CAAmB,QAAnB,EAA6B,QAA7B,EAAuC,SAAvC,CAAL,EAAwD;AACpD,uBAAO,IAAP;AACH;;AAED,gBAAI,OAAO,SAAP,KAAqB,UAAzB,EAAqC;AACjC,4BAAY,EAAE,SAAS,SAAX,EAAZ;AACH,aAFD,MAEO,IAAI,CAAC,KAAK,cAAL,CAAoB,SAApB,CAAD,IAAmC,OAAQ,UAAU,OAAlB,KAA+B,WAAtE,EAAmF;AACtF,qBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,gBAAtC;;AAEA,oBAAI,KAAK,cAAL,CAAoB,SAApB,KAAkC,UAAU,OAAhD,EAAyD;AACrD,8BAAU,OAAV,CAAkB,EAAE,OAAO,KAAK,MAAL,CAAY,QAAZ,CAAqB,WAA9B,EAAlB;AACH;;AAED,uBAAO,IAAP;AACH;;AAED,gBAAI,CAAC,KAAK,cAAL,CAAoB,QAApB,CAAD,IAAkC,CAAC,KAAK,cAAL,CAAoB,QAApB,EAA8B,SAA9B,CAAwC,MAA/E,EAAuF;;;AAGnF,wBAAQ,KAAK,SAAL,EAAR;;AAEA,qBAAK,SAAL,CAAe,KAAf,IAAwB;AACpB,2BAAO,QADa;AAEpB,+BAAW;AAFS,iBAAxB;;;AAMA,qBAAK,KAAL,CAAW,CAAC,yBAAc,SAAf,EAA0B,KAA1B,EAAiC,EAAjC,EAAqC,QAArC,CAAX;AAEH,aAbD,MAaO;;;AAEH,oBAAI,KAAK,cAAL,CAAoB,QAApB,EAA8B,SAA9B,CAAwC,OAAxC,CAAgD,UAAU,OAA1D,IAAqE,CAAzE,EAA4E;AACxE,yBAAK,cAAL,CAAoB,QAApB,EAA8B,SAA9B,CAAwC,IAAxC,CAA6C,UAAU,OAAvD;AACH;;AAED,oBAAI,UAAU,SAAd,EAAyB;AACrB,8BAAU,SAAV;AACH;AACJ;;AAED,iBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,OAAtC;AACA,iBAAK,MAAL,CAAY,QAAZ,CAAqB,KAArB,GAA6B,KAA7B;AACA,mBAAO,IAAP;AACH;;;;;;;;;;;;;;;oCAYY,Q,EAAU,S,EAAW;AAC9B,gBAAI,cAAJ;gBAAW,IAAI,CAAC,CAAhB;;AAEA,gBAAI,CAAC,KAAK,aAAL,CAAmB,IAAnB,EAAyB,QAAzB,EAAmC,SAAnC,CAAL,EAAoD;AAChD,uBAAO,IAAP;AACH;;AAED,gBAAI,KAAK,cAAL,CAAoB,QAApB,CAAJ,EAAmC;;AAE/B,wBAAQ,KAAK,SAAL,EAAR;;AAEA,oBAAI,OAAQ,SAAR,KAAuB,WAA3B,EAAwC;AACpC,yBAAK,cAAL,CAAoB,QAApB,EAA8B,SAA9B,GAA0C,EAA1C;AACA,gCAAY,EAAZ;AACH,iBAHD,MAGO,IAAI,OAAO,SAAP,KAAqB,UAAzB,EAAqC;AACxC,wBAAI,KAAK,cAAL,CAAoB,QAApB,EAA8B,SAA9B,CAAwC,OAAxC,CAAgD,SAAhD,CAAJ;AACA,gCAAY,EAAZ;AACH,iBAHM,MAGA,IAAI,UAAU,OAAV,IAAqB,OAAO,UAAU,OAAjB,KAA6B,UAAtD,EAAkE;AACrE,wBAAI,KAAK,cAAL,CAAoB,QAApB,EAA8B,SAA9B,CAAwC,OAAxC,CAAgD,UAAU,OAA1D,CAAJ;AACH,iBAFM,MAEA;AACH,yBAAK,cAAL,CAAoB,QAApB,EAA8B,SAA9B,GAA0C,EAA1C;AACH;;AAED,oBAAI,KAAK,CAAT,EAAY;AACR,yBAAK,cAAL,CAAoB,QAApB,EAA8B,SAA9B,CAAwC,MAAxC,CAA+C,CAA/C,EAAkD,CAAlD;AACH;;AAED,oBAAI,KAAK,cAAL,CAAoB,QAApB,EAA8B,SAA9B,CAAwC,MAA5C,EAAoD;;AAEhD,yBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,OAAtC;AACA,2BAAO,IAAP;AACH;;AAED,qBAAK,SAAL,CAAe,KAAf,IAAwB;AACpB,2BAAO,QADa;AAEpB,+BAAW;AAFS,iBAAxB;;;AAMA,qBAAK,KAAL,CAAW,CAAC,yBAAc,WAAf,EAA4B,KAA5B,EAAmC,KAAK,cAAL,CAAoB,QAApB,EAA8B,EAAjE,CAAX;AAEH,aAlCD,MAkCO;AACH,qBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,qBAAtC;;AAEA,oBAAI,KAAK,cAAL,CAAoB,SAApB,KAAkC,UAAU,OAAhD,EAAyD;AACrD,8BAAU,OAAV,CAAkB,EAAE,OAAO,KAAK,MAAL,CAAY,QAAZ,CAAqB,WAA9B,EAAlB;AACH;;AAED,uBAAO,IAAP;AACH;;AAED,iBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,OAAtC;AACA,iBAAK,MAAL,CAAY,QAAZ,CAAqB,KAArB,GAA6B,KAA7B;AACA,mBAAO,IAAP;AACH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;gCA2BQ,Q,EAAU,O,EAAS,S,EAAW,e,EAAiB;AACpD,gBAAI,cAAJ;gBAAW,YAAX;gBAAgB,MAAM,KAAtB;gBAA6B,aAAa,KAA1C;AACA,gBAAM,UAAU,EAAhB;;AAEA,gBAAI,CAAC,KAAK,aAAL,CAAmB,QAAnB,EAA6B,QAA7B,EAAuC,SAAvC,CAAL,EAAwD;AACpD,uBAAO,IAAP;AACH;;AAED,gBAAI,KAAK,cAAL,CAAoB,SAApB,CAAJ,EAAoC;AAChC,wBAAQ,WAAR,GAAsB,IAAtB;AACH;;AAED,gBAAI,OAAQ,eAAR,KAA6B,WAAjC,EAA8C;;AAE1C,oBAAI,KAAK,cAAL,CAAoB,eAApB,CAAJ,EAA0C;AACtC,wBAAI,gBAAgB,OAApB,EAA6B;AACzB,4BAAI,KAAK,QAAL,CAAc,gBAAgB,OAA9B,KAA0C,gBAAgB,OAAhB,CAAwB,MAAtE,EAA8E;AAC1E,oCAAQ,OAAR,GAAkB,gBAAgB,OAAlC;AACH,yBAFD,MAEO,IAAI,OAAO,gBAAgB,OAAvB,KAAmC,QAAvC,EAAiD;AACpD,oCAAQ,OAAR,GAAkB,CAAC,gBAAgB,OAAjB,CAAlB;AACH,yBAFM,MAEA;AACH,kCAAM,IAAN;AACH;AACJ;;AAED,wBAAI,gBAAgB,cAApB,EAAoC;AAChC,4BAAI,KAAK,QAAL,CAAc,gBAAgB,cAA9B,KAAiD,gBAAgB,cAAhB,CAA+B,MAApF,EAA4F;AACxF,oCAAQ,cAAR,GAAyB,gBAAgB,cAAzC;AACH,yBAFD,MAEO,IAAI,OAAO,gBAAgB,cAAvB,KAA0C,QAA9C,EAAwD;AAC3D,oCAAQ,cAAR,GAAyB,CAAC,gBAAgB,cAAjB,CAAzB;AACH,yBAFM,MAEA;AACH,kCAAM,IAAN;AACH;AACJ;;AAED,wBAAI,gBAAgB,gBAApB,EAAsC;AAClC,4BAAI,KAAK,QAAL,CAAc,gBAAgB,gBAA9B,KAAmD,gBAAgB,gBAAhB,CAAiC,MAAxF,EAAgG;AAC5F,oCAAQ,gBAAR,GAA2B,gBAAgB,gBAA3C;AACH,yBAFD,MAEO,IAAI,OAAO,gBAAgB,gBAAvB,KAA4C,QAAhD,EAA0D;AAC7D,oCAAQ,gBAAR,GAA2B,CAAC,gBAAgB,gBAAjB,CAA3B;AACH,yBAFM,MAEA;AACH,kCAAM,IAAN;AACH;AACJ;;AAED,wBAAI,gBAAgB,QAApB,EAA8B;AAC1B,4BAAI,KAAK,QAAL,CAAc,gBAAgB,QAA9B,KAA2C,gBAAgB,QAAhB,CAAyB,MAAxE,EAAgF;AAC5E,oCAAQ,QAAR,GAAmB,gBAAgB,QAAnC;AACH,yBAFD,MAEO,IAAI,OAAO,gBAAgB,QAAvB,KAAoC,QAAxC,EAAkD;AACrD,oCAAQ,QAAR,GAAmB,CAAC,gBAAgB,QAAjB,CAAnB;AACH,yBAFM,MAEA;AACH,kCAAM,IAAN;AACH;AACJ;;AAED,wBAAI,gBAAgB,eAApB,EAAqC;AACjC,4BAAI,KAAK,QAAL,CAAc,gBAAgB,eAA9B,KAAkD,gBAAgB,eAAhB,CAAgC,MAAtF,EAA8F;AAC1F,oCAAQ,eAAR,GAA0B,gBAAgB,eAA1C;AACH,yBAFD,MAEO,IAAI,OAAO,gBAAgB,eAAvB,KAA2C,QAA/C,EAAyD;AAC5D,oCAAQ,eAAR,GAA0B,CAAC,gBAAgB,eAAjB,CAA1B;AACH,yBAFM,MAEA;AACH,kCAAM,IAAN;AACH;AACJ;;AAED,wBAAI,gBAAgB,iBAApB,EAAuC;AACnC,4BAAI,KAAK,QAAL,CAAc,gBAAgB,iBAA9B,KAAoD,gBAAgB,iBAAhB,CAAkC,MAA1F,EAAkG;AAC9F,oCAAQ,iBAAR,GAA4B,gBAAgB,iBAA5C;AACH,yBAFD,MAEO,IAAI,OAAO,gBAAgB,iBAAvB,KAA6C,QAAjD,EAA2D;AAC9D,oCAAQ,iBAAR,GAA4B,CAAC,gBAAgB,iBAAjB,CAA5B;AACH,yBAFM,MAEA;AACH,kCAAM,IAAN;AACH;AACJ;;AAED,wBAAI,gBAAgB,cAAhB,CAA+B,YAA/B,CAAJ,EAAkD;AAC9C,gCAAQ,UAAR,GAAqB,gBAAgB,UAAhB,KAA+B,KAApD;AACH;;AAED,wBAAI,gBAAgB,cAAhB,CAA+B,aAA/B,CAAJ,EAAmD;AAC/C,gCAAQ,WAAR,GAAsB,gBAAgB,WAAhB,KAAgC,IAAtD;AACH;AAEJ,iBArED,MAqEO;AACH,0BAAM,IAAN;AACH;;AAED,oBAAI,GAAJ,EAAS;AACL,yBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,aAAtC;;AAEA,wBAAI,KAAK,cAAL,CAAoB,SAApB,KAAkC,UAAU,OAAhD,EAAyD;AACrD,kCAAU,OAAV,CAAkB,EAAE,OAAO,KAAK,MAAL,CAAY,QAAZ,CAAqB,WAA9B,EAAlB;AACH;;AAED,2BAAO,IAAP;AACH;AACJ;;AAED,oBAAQ,KAAK,SAAL,EAAR;;AAEA,oBAAQ,UAAU,MAAlB;AACI,qBAAK,CAAL;AACI;AACJ,qBAAK,CAAL;AACI,iCAAa,IAAb;AACA;AACJ;AACI,yBAAK,SAAL,CAAe,KAAf,IAAwB;AACpB,+BAAO,QADa;AAEpB,mCAAW;AAFS,qBAAxB;AAIA,iCAAa,IAAb;AACA;AAZR;;;AAgBA,kBAAM,CAAC,yBAAc,OAAf,EAAwB,KAAxB,EAA+B,OAA/B,EAAwC,QAAxC,CAAN;;AAEA,gBAAI,UAAJ,EAAgB;;AAEZ,oBAAI,KAAK,QAAL,CAAc,OAAd,CAAJ,EAA4B;AACxB,wBAAI,IAAJ,CAAS,OAAT;AACH,iBAFD,MAEO,IAAI,KAAK,cAAL,CAAoB,OAApB,CAAJ,EAAkC;;AAErC,wBAAI,QAAQ,QAAR,IAAoB,QAAQ,QAAhC,EAA0C;AACtC,4BAAI,QAAQ,QAAZ,EAAsB;AAClB,gCAAI,IAAJ,CAAS,QAAQ,QAAjB;AACH;;AAED,4BAAI,QAAQ,QAAZ,EAAsB;AAClB,gCAAI,IAAI,MAAJ,KAAe,CAAnB,EAAsB;AAClB,oCAAI,IAAJ,CAAS,EAAT;AACH;AACD,gCAAI,IAAJ,CAAS,QAAQ,QAAjB;AACH;AACJ,qBAXD,MAWO;AACH,4BAAI,IAAJ,CAAS,EAAT,EAAa,OAAb;AACH;AACJ,iBAhBM,MAgBA;;AACH,wBAAI,IAAJ,CAAS,CAAC,OAAD,CAAT;AACH;AACJ;;AAED,iBAAK,KAAL,CAAW,GAAX;AACA,iBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,OAAtC;AACA,iBAAK,MAAL,CAAY,QAAZ,CAAqB,KAArB,GAA6B,KAA7B;AACA,mBAAO,IAAP;AACH;;;;;;;;;;;;;;;;;;;;;6BAkBK,Q,EAAU,O,EAAS,S,EAAW,e,EAAiB;AACjD,gBAAI,cAAJ;gBAAW,YAAX;gBAAgB,MAAM,KAAtB;AACA,gBAAM,UAAU,EAAhB;;AAEA,gBAAI,CAAC,KAAK,aAAL,CAAmB,QAAnB,EAA6B,QAA7B,EAAuC,SAAvC,CAAL,EAAwD;AACpD,uBAAO,IAAP;AACH;;AAED,gBAAI,OAAO,SAAP,KAAqB,UAAzB,EAAqC;AACjC,4BAAY,EAAE,WAAW,SAAb,EAAZ;AACH,aAFD,MAEO,IAAI,CAAC,KAAK,cAAL,CAAoB,SAApB,CAAD,IAAmC,OAAQ,UAAU,SAAlB,KAAiC,WAAxE,EAAqF;AACxF,qBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,gBAAtC;;AAEA,oBAAI,KAAK,cAAL,CAAoB,SAApB,KAAkC,UAAU,OAAhD,EAAyD;AACrD,8BAAU,OAAV,CAAkB,EAAE,OAAO,KAAK,MAAL,CAAY,QAAZ,CAAqB,WAA9B,EAAlB;AACH;;AAED,uBAAO,IAAP;AACH;;AAED,gBAAI,OAAQ,eAAR,KAA6B,WAAjC,EAA8C;;AAE1C,oBAAI,KAAK,cAAL,CAAoB,eAApB,CAAJ,EAA0C;AACtC,wBAAI,gBAAgB,cAAhB,CAA+B,aAA/B,CAAJ,EAAmD;AAC/C,gCAAQ,WAAR,GAAsB,gBAAgB,WAAhB,KAAgC,IAAtD;AACH;;AAED,wBAAI,gBAAgB,cAAhB,CAA+B,kBAA/B,CAAJ,EAAwD;AACpD,gCAAQ,gBAAR,GAA2B,gBAAgB,gBAAhB,KAAqC,IAAhE;AACH;;AAED,wBAAI,gBAAgB,cAAhB,CAA+B,SAA/B,CAAJ,EAA+C;AAC3C,4BAAI,OAAO,gBAAgB,OAAvB,KAAmC,QAAvC,EAAiD;AAC7C,oCAAQ,OAAR,GAAkB,gBAAgB,OAAlC;AACH,yBAFD,MAEO;AACH,kCAAM,IAAN;AACH;AACJ;AAEJ,iBAjBD,MAiBO;AACH,0BAAM,IAAN;AACH;;AAED,oBAAI,GAAJ,EAAS;AACL,yBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,aAAtC;;AAEA,wBAAI,KAAK,cAAL,CAAoB,SAApB,KAAkC,UAAU,OAAhD,EAAyD;AACrD,kCAAU,OAAV,CAAkB,EAAE,OAAO,KAAK,MAAL,CAAY,QAAZ,CAAqB,WAA9B,EAAlB;AACH;;AAED,2BAAO,IAAP;AACH;AACJ;;AAED,eAAG;AACC,wBAAQ,KAAK,SAAL,EAAR;AACH,aAFD,QAES,SAAS,KAAK,MAFvB;;AAIA,iBAAK,MAAL,CAAY,KAAZ,IAAqB,SAArB;;;AAGA,kBAAM,CAAC,yBAAc,IAAf,EAAqB,KAArB,EAA4B,OAA5B,EAAqC,QAArC,CAAN;;AAEA,gBAAI,YAAY,IAAhB,EAAsB;AAClB,oBAAI,KAAK,QAAL,CAAc,OAAd,CAAJ,EAA4B;AACxB,wBAAI,IAAJ,CAAS,OAAT;AACH,iBAFD,MAEO,IAAI,KAAK,cAAL,CAAoB,OAApB,CAAJ,EAAkC;;AAErC,wBAAI,QAAQ,QAAR,IAAoB,QAAQ,QAAhC,EAA0C;AACtC,4BAAI,QAAQ,QAAZ,EAAsB;AAClB,gCAAI,IAAJ,CAAS,QAAQ,QAAjB;AACH;;AAED,4BAAI,QAAQ,QAAZ,EAAsB;AAClB,gCAAI,IAAI,MAAJ,KAAe,CAAnB,EAAsB;AAClB,oCAAI,IAAJ,CAAS,EAAT;AACH;AACD,gCAAI,IAAJ,CAAS,QAAQ,QAAjB;AACH;AACJ,qBAXD,MAWO;AACH,4BAAI,IAAJ,CAAS,EAAT,EAAa,OAAb;AACH;AACJ,iBAhBM,MAgBA;;AACH,wBAAI,IAAJ,CAAS,CAAC,OAAD,CAAT;AACH;AACJ;;AAED,iBAAK,KAAL,CAAW,GAAX;AACA,iBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,OAAtC;AACA,iBAAK,MAAL,CAAY,QAAZ,CAAqB,KAArB,GAA6B,KAA7B;AACA,mBAAO,IAAP;AACH;;;;;;;;;;;;;;;;;;;;+BAiBO,K,EAAO,S,EAAW,e,EAAiB;AACvC,gBAAM,UAAU,EAAE,MAAM,MAAR,EAAhB;;AAEA,gBAAI,CAAC,KAAK,aAAL,CAAmB,IAAnB,EAAyB,QAAzB,EAAmC,SAAnC,CAAL,EAAoD;AAChD,uBAAO,IAAP;AACH;;AAED,gBAAI,CAAC,KAAD,IAAU,CAAC,KAAK,MAAL,CAAY,KAAZ,CAAf,EAAmC;AAC/B,qBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,oBAAtC;;AAEA,oBAAI,KAAK,cAAL,CAAoB,SAApB,KAAkC,UAAU,OAAhD,EAAyD;AACrD,8BAAU,OAAV,CAAkB,EAAE,OAAO,KAAK,MAAL,CAAY,QAAZ,CAAqB,WAA9B,EAAlB;AACH;;AAED,uBAAO,IAAP;AACH;;AAED,gBAAK,OAAQ,eAAR,KAA6B,WAA9B,IACC,KAAK,cAAL,CAAoB,eAApB,CADD,IAEC,gBAAgB,cAAhB,CAA+B,MAA/B,CAFL,EAE8C;;AAE1C,wBAAQ,IAAR,GAAe,uBAAuB,IAAvB,CAA4B,gBAAgB,IAA5C,IAAoD,gBAAgB,IAApE,GAA2E,MAA1F;AACH;;;AAGD,iBAAK,KAAL,CAAW,CAAC,yBAAc,MAAf,EAAuB,KAAvB,EAA8B,OAA9B,CAAX;AACA,iBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,OAAtC;AACA,iBAAK,MAAL,CAAY,QAAZ,CAAqB,KAArB,GAA6B,KAA7B;;AAEA,sBAAU,SAAV,IAAuB,UAAU,SAAV,EAAvB;;AAEA,mBAAO,IAAP;AACH;;;;;;;;;;;;;;;iCAYS,Q,EAAU,S,EAAW;AAC3B,gBAAI,cAAJ;;AAEA,gBAAI,CAAC,KAAK,aAAL,CAAmB,QAAnB,EAA6B,QAA7B,EAAuC,SAAvC,CAAL,EAAwD;AACpD,uBAAO,IAAP;AACH;;AAED,gBAAI,OAAO,SAAP,KAAqB,UAAzB,EAAqC;AACjC,4BAAY,EAAE,KAAK,SAAP,EAAZ;AACH,aAFD,MAEO,IAAI,CAAC,KAAK,cAAL,CAAoB,SAApB,CAAD,IAAmC,OAAQ,UAAU,GAAlB,KAA2B,WAAlE,EAA+E;AAClF,qBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,gBAAtC;;AAEA,oBAAI,KAAK,cAAL,CAAoB,SAApB,KAAkC,UAAU,OAAhD,EAAyD;AACrD,8BAAU,OAAV,CAAkB,EAAE,OAAO,KAAK,MAAL,CAAY,QAAZ,CAAqB,WAA9B,EAAlB;AACH;;AAED,uBAAO,IAAP;AACH;;AAED,gBAAI,CAAC,KAAK,QAAL,CAAc,QAAd,CAAD,IAA4B,CAAC,KAAK,QAAL,CAAc,QAAd,EAAwB,SAAxB,CAAkC,MAAnE,EAA2E;;;AAGvE,wBAAQ,KAAK,SAAL,EAAR;;AAEA,qBAAK,SAAL,CAAe,KAAf,IAAwB;AACpB,2BAAO,QADa;AAEpB,+BAAW;AAFS,iBAAxB;;;AAMA,qBAAK,KAAL,CAAW,CAAC,yBAAc,QAAf,EAAyB,KAAzB,EAAgC,EAAhC,EAAoC,QAApC,CAAX;AACA,qBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,OAAtC;AACA,qBAAK,MAAL,CAAY,QAAZ,CAAqB,KAArB,GAA6B,KAA7B;AACH,aAdD,MAcO;;AACH,qBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,sBAAtC;;AAEA,oBAAI,KAAK,cAAL,CAAoB,SAApB,KAAkC,UAAU,OAAhD,EAAyD;AACrD,8BAAU,OAAV,CAAkB,EAAE,OAAO,KAAK,MAAL,CAAY,QAAZ,CAAqB,WAA9B,EAAlB;AACH;AAEJ;;AAED,mBAAO,IAAP;AAEH;;;;;;;;;;;;;;mCAWW,Q,EAAU,S,EAAW;AAC7B,gBAAI,cAAJ;;AAEA,gBAAI,CAAC,KAAK,aAAL,CAAmB,QAAnB,EAA6B,QAA7B,EAAuC,SAAvC,CAAL,EAAwD;AACpD,uBAAO,IAAP;AACH;;AAED,gBAAI,OAAO,SAAP,KAAqB,UAAzB,EAAqC;AACjC,4BAAY,EAAE,WAAW,SAAb,EAAZ;AACH;;AAED,gBAAI,KAAK,QAAL,CAAc,QAAd,CAAJ,EAA6B;;;AAEzB,wBAAQ,KAAK,SAAL,EAAR;;AAEA,qBAAK,SAAL,CAAe,KAAf,IAAwB;AACpB,2BAAO,QADa;AAEpB,+BAAW;AAFS,iBAAxB;;;AAMA,qBAAK,KAAL,CAAW,CAAC,yBAAc,UAAf,EAA2B,KAA3B,EAAkC,KAAK,QAAL,CAAc,QAAd,EAAwB,EAA1D,CAAX;AACA,qBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,OAAtC;AACA,qBAAK,MAAL,CAAY,QAAZ,CAAqB,KAArB,GAA6B,KAA7B;AACH,aAbD,MAaO;;AACH,qBAAK,MAAL,CAAY,QAAZ,GAAuB,0BAAe,mBAAtC;;AAEA,oBAAI,KAAK,cAAL,CAAoB,SAApB,KAAkC,UAAU,OAAhD,EAAyD;AACrD,8BAAU,OAAV,CAAkB,EAAE,OAAO,KAAK,MAAL,CAAY,QAAZ,CAAqB,WAA9B,EAAlB;AACH;AAEJ;;AAED,mBAAO,IAAP;AACH;;;;;;kBAGU,K;QACN,K,GAAA,K","file":"wampy.js","sourcesContent":["/**\n * Project: wampy.js\n *\n * https://github.com/KSDaemon/wampy.js\n *\n * A lightweight client-side implementation of\n * WAMP (The WebSocket Application Messaging Protocol v2)\n * http://wamp.ws\n *\n * Provides asynchronous RPC/PubSub over WebSocket.\n *\n * Copyright 2014 KSDaemon. Licensed under the MIT License.\n * See @license text at http://www.opensource.org/licenses/mit-license.php\n *\n */\n\nimport { WAMP_MSG_SPEC, WAMP_ERROR_MSG, isNode } from './constants';\nimport { getWebSocket, isBinaryTypeAllowed } from './utils';\nimport { JsonSerializer } from './serializers/JsonSerializer';\n\n/**\n * WAMP Client Class\n */\nclass Wampy {\n\n    /**\n     * Wampy constructor\n     * @param {string} [url]\n     * @param {Object} [options]\n     */\n    constructor (url, options) {\n\n        /**\n         * Wampy version\n         * @type {string}\n         * @private\n         */\n        this.version = 'v6.0.0';\n\n        /**\n         * WS Url\n         * @type {string}\n         * @private\n         */\n        this._url = (typeof url === 'string') ? url : null;\n\n        /**\n         * WS protocols\n         * @type {Array}\n         * @private\n         */\n        this._protocols = ['wamp.2.json'];\n\n        /**\n         * WAMP features, supported by Wampy\n         * @type {object}\n         * @private\n         */\n        this._wamp_features = {\n            agent: 'Wampy.js ' + this.version,\n            roles: {\n                publisher: {\n                    features: {\n                        subscriber_blackwhite_listing: true,\n                        publisher_exclusion: true,\n                        publisher_identification: true\n                    }\n                },\n                subscriber: {},\n                caller: {\n                    features: {\n                        caller_identification: true,\n                        progressive_call_results: true,\n                        call_canceling: true,\n                        call_timeout: true\n                    }\n                },\n                callee: {\n                    features: {\n                        caller_identification: true\n                    }\n                }\n            }\n        };\n\n        /**\n         * Internal cache for object lifetime\n         * @type {Object}\n         * @private\n         */\n        this._cache = {\n            /**\n             * WAMP Session ID\n             * @type {string}\n             */\n            sessionId: null,\n\n            /**\n             * WAMP Session scope requests ID\n             * @type {int}\n             */\n            reqId: 0,\n\n            /**\n             * Server WAMP roles and features\n             */\n            server_wamp_features: { roles: {} },\n\n            /**\n             * Are we in state of saying goodbye\n             * @type {boolean}\n             */\n            isSayingGoodbye: false,\n\n            /**\n             * Status of last operation\n             */\n            opStatus: { code: 0, description: 'Success!', reqId: 0 },\n\n            /**\n             * Timer for reconnection\n             * @type {null}\n             */\n            timer: null,\n\n            /**\n             * Reconnection attempts\n             * @type {number}\n             */\n            reconnectingAttempts: 0\n        };\n\n        /**\n         * WebSocket object\n         * @type {Object}\n         * @private\n         */\n        this._ws = null;\n\n        /**\n         * Internal queue for websocket requests, for case of disconnect\n         * @type {Array}\n         * @private\n         */\n        this._wsQueue = [];\n\n        /**\n         * Internal queue for wamp requests\n         * @type {object}\n         * @private\n         */\n        this._requests = {};\n\n        /**\n         * Stored RPC\n         * @type {object}\n         * @private\n         */\n        this._calls = {};\n\n        /**\n         * Stored Pub/Sub\n         * @type {object}\n         * @private\n         */\n        this._subscriptions = {};\n\n        /**\n         * Stored Pub/Sub topics\n         * @type {Array}\n         * @private\n         */\n        this._subsTopics = new Set();\n\n        /**\n         * Stored RPC Registrations\n         * @type {object}\n         * @private\n         */\n        this._rpcRegs = {};\n\n        /**\n         * Stored RPC names\n         * @type {Array}\n         * @private\n         */\n        this._rpcNames = new Set();\n\n        /**\n         * Options hash-table\n         * @type {Object}\n         * @private\n         */\n        this._options = {\n            /**\n             * Logging\n             * @type {boolean}\n             */\n            debug: false,\n\n            /**\n             * Reconnecting flag\n             * @type {boolean}\n             */\n            autoReconnect: true,\n\n            /**\n             * Reconnecting interval (in ms)\n             * @type {number}\n             */\n            reconnectInterval: 2 * 1000,\n\n            /**\n             * Maximum reconnection retries\n             * @type {number}\n             */\n            maxRetries: 25,\n\n            /**\n             * WAMP Realm to join\n             * @type {string}\n             */\n            realm: null,\n\n            /**\n             * Custom attributes to send to router on hello\n             * @type {object}\n             */\n            helloCustomDetails: null,\n\n            /**\n             * Authentication id to use in challenge\n             * @type {string}\n             */\n            authid: null,\n\n            /**\n             * Supported authentication methods\n             * @type {array}\n             */\n            authmethods: [],\n\n            /**\n             * onChallenge callback\n             * @type {function}\n             */\n            onChallenge: null,\n\n            /**\n             * onConnect callback\n             * @type {function}\n             */\n            onConnect: null,\n\n            /**\n             * onClose callback\n             * @type {function}\n             */\n            onClose: null,\n\n            /**\n             * onError callback\n             * @type {function}\n             */\n            onError: null,\n\n            /**\n             * onReconnect callback\n             * @type {function}\n             */\n            onReconnect: null,\n\n            /**\n             * onReconnectSuccess callback\n             * @type {function}\n             */\n            onReconnectSuccess: null,\n\n            /**\n             * User provided WebSocket class\n             * @type {function}\n             */\n            ws: null,\n\n            /**\n             * User provided msgpack class\n             * @type {object}\n             */\n            serializer: new JsonSerializer()\n        };\n\n        if (this._isPlainObject(options)) {\n            this._options = this._merge(this._options, options);\n        } else if (this._isPlainObject(url)) {\n            this._options = this._merge(this._options, url);\n        }\n\n        if (this._url) {\n            this.connect();\n        }\n\n    }\n\n    /* Internal utils methods */\n    /**\n     * Internal logger\n     * @private\n     */\n    _log () {\n        if (this._options.debug) {\n            console.log(arguments);\n        }\n    }\n\n    /**\n     * Get the new unique request id\n     * @returns {number}\n     * @private\n     */\n    _getReqId () {\n        return ++this._cache.reqId;\n    }\n\n    /**\n     * Merge argument objects into one\n     * @returns {Object}\n     * @private\n     */\n    _merge () {\n        const obj = {}, l = arguments.length;\n        let i, attr;\n\n        for (i = 0; i < l; i++) {\n            for (attr in arguments[i]) {\n                obj[attr] = arguments[i][attr];\n            }\n        }\n\n        return obj;\n    }\n\n    /**\n     * Check if value is array\n     * @param obj\n     * @returns {boolean}\n     * @private\n     */\n    _isArray (obj) {\n        return (!!obj) && (Array.isArray(obj));\n    }\n\n    /**\n     * Check if value is object literal\n     * @param obj\n     * @returns {boolean}\n     * @private\n     */\n    _isPlainObject (obj) {\n        return (!!obj) && (obj.constructor === Object);\n    }\n\n    /**\n     * Fix websocket protocols based on options\n     * @private\n     */\n    _setWsProtocols () {\n        if (!(this._options.serializer instanceof JsonSerializer)) {\n            this._protocols.unshift('wamp.2.' + this._options.serializer.protocol);\n        }\n    }\n\n    /**\n     * Prerequisite checks for any wampy api call\n     * @param {string} topicURI\n     * @param {string} role\n     * @param {object} callbacks\n     * @returns {boolean}\n     * @private\n     */\n    _preReqChecks (topicURI, role, callbacks) {\n        let flag = true;\n\n        if (this._cache.sessionId && !this._cache.server_wamp_features.roles[role]) {\n            this._cache.opStatus = WAMP_ERROR_MSG['NO_' + role.toUpperCase()];\n            flag = false;\n        }\n\n        if (topicURI && !this._validateURI(topicURI)) {\n            this._cache.opStatus = WAMP_ERROR_MSG.URI_ERROR;\n            flag = false;\n        }\n\n        if (flag) {\n            return true;\n        }\n\n        if (this._isPlainObject(callbacks) && callbacks.onError) {\n            callbacks.onError({ error: this._cache.opStatus.description });\n        }\n\n        return false;\n    }\n\n    /**\n     * Validate uri\n     * @param {string} uri\n     * @returns {boolean}\n     * @private\n     */\n    _validateURI (uri) {\n        const re = /^([0-9a-zA-Z_]{2,}\\.)*([0-9a-zA-Z_]{2,})$/;\n        return !(!re.test(uri) || uri.indexOf('wamp') === 0);\n    }\n\n    /**\n     * Encode WAMP message\n     * @param {Array} msg\n     * @returns {*}\n     * @private\n     */\n    _encode (msg) {\n        try {\n            return this._options.serializer.encode(msg);\n        } catch (e) {\n            throw new Error('[wampy] encoding exception!');\n        }\n    }\n\n    /**\n     * Decode WAMP message\n     * @param  msg\n     * @returns {array}\n     * @private\n     */\n    _decode (msg) {\n        try {\n            return this._options.serializer.decode(msg);\n        } catch (e) {\n            throw new Error('[wampy] decoding exception!');\n        }\n    }\n\n    /**\n     * Send encoded message to server\n     * @param {Array} msg\n     * @private\n     */\n    _send (msg) {\n        if (msg) {\n            this._wsQueue.push(this._encode(msg));\n        }\n\n        if (this._ws && this._ws.readyState === 1 && this._cache.sessionId) {\n            while (this._wsQueue.length) {\n                this._ws.send(this._wsQueue.shift());\n            }\n        }\n    }\n\n    /**\n     * Reset internal state and cache\n     * @private\n     */\n    _resetState () {\n        this._wsQueue = [];\n        this._subscriptions = {};\n        this._subsTopics = new Set();\n        this._requests = {};\n        this._calls = {};\n        this._rpcRegs = {};\n        this._rpcNames = new Set();\n\n        // Just keep attrs that are have to be present\n        this._cache = {\n            reqId: 0,\n            reconnectingAttempts: 0\n        };\n    }\n\n    /**\n     * Initialize internal websocket callbacks\n     * @private\n     */\n    _initWsCallbacks () {\n        if (this._ws) {\n            this._ws.onopen = () => {\n                this._wsOnOpen();\n            };\n            this._ws.onclose = event => {\n                this._wsOnClose(event);\n            };\n            this._ws.onmessage = event => {\n                this._wsOnMessage(event);\n            };\n            this._ws.onerror = error => {\n                this._wsOnError(error);\n            };\n        }\n    }\n\n    /**\n     * Internal websocket on open callback\n     * @private\n     */\n    _wsOnOpen () {\n        const options = this._merge(this._options.helloCustomDetails, this._wamp_features),\n            serverProtocol = this._ws.protocol ? this._ws.protocol.split('.')[2] : '';\n\n        if (this._options.authid) {\n            options.authmethods = this._options.authmethods;\n            options.authid = this._options.authid;\n        }\n\n        this._log('[wampy] websocket connected');\n\n        if (this._options.serializer.protocol !== serverProtocol) {\n            // Server have chosen not our preferred protocol\n\n            // Falling back to json if possible\n            if (serverProtocol === 'json') {\n                this._options.serializer = new JsonSerializer();\n            } else {\n                this._cache.opStatus = WAMP_ERROR_MSG.NO_SERIALIZER_AVAILABLE;\n                return this;\n            }\n\n        }\n\n        const type = this._options.serializer.binaryType;\n\n        if (!isBinaryTypeAllowed(type)) {\n            this._cache.opStatus = WAMP_ERROR_MSG.INVALID_SERIALIZER_TYPE;\n            return this;\n        }\n\n        this._ws.binatyType = type;\n\n        // WAMP SPEC: [HELLO, Realm|uri, Details|dict]\n        // Sending directly 'cause it's a hello msg and no sessionId check is needed\n        this._ws.send(this._encode([WAMP_MSG_SPEC.HELLO, this._options.realm, options]));\n    }\n\n    /**\n     * Internal websocket on close callback\n     * @param {object} event\n     * @private\n     */\n    _wsOnClose (event) {\n        const root = isNode ? global : window;\n        this._log('[wampy] websocket disconnected. Info: ', event);\n\n        // Automatic reconnection\n        if ((this._cache.sessionId || this._cache.reconnectingAttempts) &&\n            this._options.autoReconnect && this._cache.reconnectingAttempts < this._options.maxRetries && !this._cache.isSayingGoodbye) {\n            this._cache.sessionId = null;\n            this._cache.timer = root.setTimeout(\n                () => {\n                    this._wsReconnect();\n                },\n                this._options.reconnectInterval\n            );\n        } else {\n            // No reconnection needed or reached max retries count\n            if (this._options.onClose) {\n                this._options.onClose();\n            }\n\n            this._resetState();\n            this._ws = null;\n        }\n    }\n\n    /**\n     * Internal websocket on event callback\n     * @param {object} event\n     * @private\n     */\n    _wsOnMessage (event) {\n        let data, id, i, msg, p;\n\n        this._log('[wampy] websocket message received', event.data);\n\n        data = this._decode(event.data);\n\n        switch (data[0]) {\n            case WAMP_MSG_SPEC.WELCOME:\n                // WAMP SPEC: [WELCOME, Session|id, Details|dict]\n\n                this._cache.sessionId = data[1];\n                this._cache.server_wamp_features = data[2];\n\n                if (this._cache.reconnectingAttempts) {\n                    // There was reconnection\n\n                    this._cache.reconnectingAttempts = 0;\n\n                    if (this._options.onReconnectSuccess) {\n                        this._options.onReconnectSuccess();\n                    }\n\n                    // Let's renew all previous state\n                    this._renewSubscriptions();\n                    this._renewRegistrations();\n\n                } else {\n                    // Firing onConnect event on real connection to WAMP server\n                    if (this._options.onConnect) {\n                        this._options.onConnect();\n                    }\n                }\n\n                // Send local queue if there is something out there\n                this._send();\n\n                break;\n            case WAMP_MSG_SPEC.ABORT:\n                // WAMP SPEC: [ABORT, Details|dict, Reason|uri]\n                if (this._options.onError) {\n                    this._options.onError({ error: data[2], details: data[1] });\n                }\n                this._ws.close();\n                break;\n            case WAMP_MSG_SPEC.CHALLENGE:\n                // WAMP SPEC: [CHALLENGE, AuthMethod|string, Extra|dict]\n\n                if (this._options.authid && typeof this._options.onChallenge === 'function') {\n\n                    p = new Promise((resolve, reject) => {\n                        resolve(this._options.onChallenge(data[1], data[2]));\n                    });\n\n                    p.then((key) => {\n\n                        // Sending directly 'cause it's a challenge msg and no sessionId check is needed\n                        this._ws.send(this._encode([WAMP_MSG_SPEC.AUTHENTICATE, key, {}]));\n\n                    }).catch(e => {\n                        this._ws.send(this._encode([\n                            WAMP_MSG_SPEC.ABORT,\n                            { message: 'Exception in onChallenge handler raised!' },\n                            'wamp.error.cannot_authenticate'\n                        ]));\n                        if (this._options.onError) {\n                            this._options.onError({ error: WAMP_ERROR_MSG.CRA_EXCEPTION.description });\n                        }\n                        this._ws.close();\n                        this._cache.opStatus = WAMP_ERROR_MSG.CRA_EXCEPTION;\n                    });\n\n                } else {\n\n                    this._ws.send(this._encode([\n                        WAMP_MSG_SPEC.ABORT,\n                        { message: WAMP_ERROR_MSG.NO_CRA_CB_OR_ID.description },\n                        'wamp.error.cannot_authenticate'\n                    ]));\n                    if (this._options.onError) {\n                        this._options.onError({ error: WAMP_ERROR_MSG.NO_CRA_CB_OR_ID.description });\n                    }\n                    this._ws.close();\n                    this._cache.opStatus = WAMP_ERROR_MSG.NO_CRA_CB_OR_ID;\n\n                }\n                break;\n            case WAMP_MSG_SPEC.GOODBYE:\n                // WAMP SPEC: [GOODBYE, Details|dict, Reason|uri]\n                if (!this._cache.isSayingGoodbye) {    // get goodbye, initiated by server\n                    this._cache.isSayingGoodbye = true;\n                    this._send([WAMP_MSG_SPEC.GOODBYE, {}, 'wamp.error.goodbye_and_out']);\n                }\n                this._cache.sessionId = null;\n                this._ws.close();\n                break;\n            case WAMP_MSG_SPEC.ERROR:\n                // WAMP SPEC: [ERROR, REQUEST.Type|int, REQUEST.Request|id, Details|dict,\n                //             Error|uri, (Arguments|list, ArgumentsKw|dict)]\n                switch (data[1]) {\n                    case WAMP_MSG_SPEC.SUBSCRIBE:\n                    case WAMP_MSG_SPEC.UNSUBSCRIBE:\n                    case WAMP_MSG_SPEC.PUBLISH:\n                    case WAMP_MSG_SPEC.REGISTER:\n                    case WAMP_MSG_SPEC.UNREGISTER:\n\n                        this._requests[data[2]] && this._requests[data[2]].callbacks.onError &&\n                        this._requests[data[2]].callbacks.onError({\n                            error: data[4],\n                            details: data[3],\n                            argsList: data[5],\n                            argsDict: data[6]\n                        });\n                        delete this._requests[data[2]];\n\n                        break;\n                    case WAMP_MSG_SPEC.INVOCATION:\n                        break;\n                    case WAMP_MSG_SPEC.CALL:\n\n                        // WAMP SPEC: [ERROR, CALL, CALL.Request|id, Details|dict,\n                        //             Error|uri, Arguments|list, ArgumentsKw|dict]\n                        this._calls[data[2]] && this._calls[data[2]].onError &&\n                        this._calls[data[2]].onError({\n                            error   : data[4],\n                            details : data[3],\n                            argsList: data[5],\n                            argsDict: data[6]\n                        });\n                        delete this._calls[data[2]];\n\n                        break;\n                    default:\n                        this._log('[wampy] Received non-compliant WAMP ERROR message');\n                        break;\n                }\n                break;\n            case WAMP_MSG_SPEC.SUBSCRIBED:\n                // WAMP SPEC: [SUBSCRIBED, SUBSCRIBE.Request|id, Subscription|id]\n                if (this._requests[data[1]]) {\n                    this._subscriptions[this._requests[data[1]].topic] = this._subscriptions[data[2]] = {\n                        id: data[2],\n                        callbacks: [this._requests[data[1]].callbacks.onEvent]\n                    };\n\n                    this._subsTopics.add(this._requests[data[1]].topic);\n\n                    if (this._requests[data[1]].callbacks.onSuccess) {\n                        this._requests[data[1]].callbacks.onSuccess();\n                    }\n\n                    delete this._requests[data[1]];\n\n                }\n                break;\n            case WAMP_MSG_SPEC.UNSUBSCRIBED:\n                // WAMP SPEC: [UNSUBSCRIBED, UNSUBSCRIBE.Request|id]\n                if (this._requests[data[1]]) {\n                    id = this._subscriptions[this._requests[data[1]].topic].id;\n                    delete this._subscriptions[this._requests[data[1]].topic];\n                    delete this._subscriptions[id];\n\n                    if (this._subsTopics.has(this._requests[data[1]].topic)) {\n                        this._subsTopics.delete(this._requests[data[1]].topic);\n                    }\n\n                    if (this._requests[data[1]].callbacks.onSuccess) {\n                        this._requests[data[1]].callbacks.onSuccess();\n                    }\n\n                    delete this._requests[data[1]];\n                }\n                break;\n            case WAMP_MSG_SPEC.PUBLISHED:\n                // WAMP SPEC: [PUBLISHED, PUBLISH.Request|id, Publication|id]\n                if (this._requests[data[1]]) {\n                    if (this._requests[data[1]].callbacks && this._requests[data[1]].callbacks.onSuccess) {\n                        this._requests[data[1]].callbacks.onSuccess();\n                    }\n\n                    delete this._requests[data[1]];\n\n                }\n                break;\n            case WAMP_MSG_SPEC.EVENT:\n                if (this._subscriptions[data[1]]) {\n\n                    // WAMP SPEC: [EVENT, SUBSCRIBED.Subscription|id, PUBLISHED.Publication|id,\n                    //             Details|dict, PUBLISH.Arguments|list, PUBLISH.ArgumentKw|dict]\n\n                    i = this._subscriptions[data[1]].callbacks.length;\n                    while (i--) {\n                        this._subscriptions[data[1]].callbacks[i]({\n                            details : data[3],\n                            argsList: data[4],\n                            argsDict: data[5]\n                        });\n                    }\n\n                }\n                break;\n            case WAMP_MSG_SPEC.RESULT:\n                if (this._calls[data[1]]) {\n\n                    // WAMP SPEC: [RESULT, CALL.Request|id, Details|dict,\n                    //             YIELD.Arguments|list, YIELD.ArgumentsKw|dict]\n\n                    this._calls[data[1]].onSuccess({\n                        details : data[2],\n                        argsList: data[3],\n                        argsDict: data[4]\n                    });\n                    if (!(data[2].progress && data[2].progress === true)) {\n                        // We receive final result (progressive or not)\n                        delete this._calls[data[1]];\n                    }\n\n                }\n                break;\n            // case WAMP_MSG_SPEC.REGISTER:\n            //     // WAMP SPEC:\n            //     break;\n            case WAMP_MSG_SPEC.REGISTERED:\n                // WAMP SPEC: [REGISTERED, REGISTER.Request|id, Registration|id]\n                if (this._requests[data[1]]) {\n                    this._rpcRegs[this._requests[data[1]].topic] = this._rpcRegs[data[2]] = {\n                        id: data[2],\n                        callbacks: [this._requests[data[1]].callbacks.rpc]\n                    };\n\n                    this._rpcNames.add(this._requests[data[1]].topic);\n\n                    if (this._requests[data[1]].callbacks && this._requests[data[1]].callbacks.onSuccess) {\n                        this._requests[data[1]].callbacks.onSuccess();\n                    }\n\n                    delete this._requests[data[1]];\n\n                }\n                break;\n            // case WAMP_MSG_SPEC.UNREGISTER:\n            //     // WAMP SPEC:\n            //     break;\n            case WAMP_MSG_SPEC.UNREGISTERED:\n                // WAMP SPEC: [UNREGISTERED, UNREGISTER.Request|id]\n                if (this._requests[data[1]]) {\n                    id = this._rpcRegs[this._requests[data[1]].topic].id;\n                    delete this._rpcRegs[this._requests[data[1]].topic];\n                    delete this._rpcRegs[id];\n\n                    if (this._rpcNames.has(this._requests[data[1]].topic)) {\n                        this._rpcNames.delete(this._requests[data[1]].topic);\n                    }\n\n                    if (this._requests[data[1]].callbacks && this._requests[data[1]].callbacks.onSuccess) {\n                        this._requests[data[1]].callbacks.onSuccess();\n                    }\n\n                    delete this._requests[data[1]];\n                }\n                break;\n            case WAMP_MSG_SPEC.INVOCATION:\n                if (this._rpcRegs[data[2]]) {\n\n                    // WAMP SPEC: [INVOCATION, Request|id, REGISTERED.Registration|id,\n                    //             Details|dict, CALL.Arguments|list, CALL.ArgumentsKw|dict]\n\n                    p = new Promise((resolve, reject) => {\n                        resolve(this._rpcRegs[data[2]].callbacks[0]({\n                            details : data[3],\n                            argsList: data[4],\n                            argsDict: data[5]\n                        }));\n                    });\n\n                    p.then((results) => {\n                        // WAMP SPEC: [YIELD, INVOCATION.Request|id, Options|dict, (Arguments|list, ArgumentsKw|dict)]\n                        msg = [WAMP_MSG_SPEC.YIELD, data[1], {}];\n\n                        if (this._isPlainObject(results)) {\n\n                            if (this._isPlainObject(results.options)) {\n                                msg[2] = results.options;\n                            }\n\n                            if (this._isArray(results.argsList)) {\n                                msg.push(results.argsList);\n                            } else if (typeof (results.argsList) !== 'undefined') {\n                                msg.push([results.argsList]);\n                            }\n\n                            if (this._isPlainObject(results.argsDict)) {\n                                if (msg.length === 3) {\n                                    msg.push([]);\n                                }\n                                msg.push(results.argsDict);\n                            }\n                        } else {\n                            msg = [WAMP_MSG_SPEC.YIELD, data[1], {}];\n                        }\n                        this._send(msg);\n                    }).catch(e => {\n                        let msg = [WAMP_MSG_SPEC.ERROR, WAMP_MSG_SPEC.INVOCATION,\n                            data[1], e.details || {}, e.error || 'wamp.error.invocation_exception'];\n\n                        if (e.argsList && this._isArray(e.argsList)) {\n                            msg.push(e.argsList);\n                        }\n\n                        if (e.argsDict && this._isPlainObject(e.argsDict)) {\n                            if (msg.length === 5) {\n                                msg.push([]);\n                            }\n                            msg.push(e.argsDict);\n                        }\n                        this._send(msg);\n                    });\n\n                } else {\n                    // WAMP SPEC: [ERROR, INVOCATION, INVOCATION.Request|id, Details|dict, Error|uri]\n                    this._send([WAMP_MSG_SPEC.ERROR, WAMP_MSG_SPEC.INVOCATION,\n                        data[1], {}, 'wamp.error.no_such_procedure']);\n                    this._cache.opStatus = WAMP_ERROR_MSG.NON_EXIST_RPC_INVOCATION;\n                }\n\n                break;\n            // case WAMP_MSG_SPEC.INTERRUPT:\n            //     // WAMP SPEC:\n            //     break;\n            // case WAMP_MSG_SPEC.YIELD:\n            //     // WAMP SPEC:\n            //     break;\n            default:\n                this._log('[wampy] Received non-compliant WAMP message');\n                break;\n        }\n    }\n\n    /**\n     * Internal websocket on error callback\n     * @param {object} error\n     * @private\n     */\n    _wsOnError (error) {\n        this._log('[wampy] websocket error');\n\n        if (this._options.onError) {\n            this._options.onError({ error: error });\n        }\n    }\n\n    /**\n     * Reconnect to server in case of websocket error\n     * @private\n     */\n    _wsReconnect () {\n        this._log('[wampy] websocket reconnecting...');\n\n        if (this._options.onReconnect) {\n            this._options.onReconnect();\n        }\n\n        this._cache.reconnectingAttempts++;\n        this._ws = getWebSocket(this._url, this._protocols, this._options.ws);\n        this._initWsCallbacks();\n    }\n\n    /**\n     * Resubscribe to topics in case of communication error\n     * @private\n     */\n    _renewSubscriptions () {\n        let i;\n        const subs = this._subscriptions,\n            st = this._subsTopics;\n\n        this._subscriptions = {};\n        this._subsTopics = new Set();\n\n        for (let topic of st) {\n            i = subs[topic].callbacks.length;\n            while (i--) {\n                this.subscribe(topic, subs[topic].callbacks[i]);\n            }\n        }\n    }\n\n    /**\n     * Reregister RPCs in case of communication error\n     * @private\n     */\n    _renewRegistrations () {\n        const rpcs = this._rpcRegs,\n            rn = this._rpcNames;\n\n        this._rpcRegs = {};\n        this._rpcNames = new Set();\n\n        for (let rpcName of rn) {\n            this.register(rpcName, { rpc: rpcs[rpcName].callbacks[0] });\n        }\n    }\n\n    /* Wampy public API */\n\n    /**\n     * Get or set Wampy options\n     *\n     * To get options - call without parameters\n     * To set options - pass hash-table with options values\n     *\n     * @param {object} [opts]\n     * @returns {*}\n     */\n    options (opts) {\n        if (typeof (opts) === 'undefined') {\n            return this._options;\n        } else if (this._isPlainObject(opts)) {\n            this._options = this._merge(this._options, opts);\n            return this;\n        }\n    }\n\n    /**\n     * Get the status of last operation\n     *\n     * @returns {object} with 2 fields: code, description\n     *      code: 0 - if operation was successful\n     *      code > 0 - if error occurred\n     *      description contains details about error\n     *      reqId: last send request ID\n     */\n    getOpStatus () {\n        return this._cache.opStatus;\n    }\n\n    /**\n     * Get the WAMP Session ID\n     *\n     * @returns {string} Session ID\n     */\n    getSessionId () {\n        return this._cache.sessionId;\n    }\n\n    /**\n     * Connect to server\n     * @param {string} [url] New url (optional)\n     * @returns {Wampy}\n     */\n    connect (url) {\n        if (url) {\n            this._url = url;\n        }\n\n        if (this._options.realm) {\n\n            const authp = (this._options.authid ? 1 : 0) +\n                ((this._isArray(this._options.authmethods) && this._options.authmethods.length) ? 1 : 0) +\n                (typeof this._options.onChallenge === 'function' ? 1 : 0);\n\n            if (authp > 0 && authp < 3) {\n                this._cache.opStatus = WAMP_ERROR_MSG.NO_CRA_CB_OR_ID;\n                return this;\n            }\n\n            this._setWsProtocols();\n            this._ws = getWebSocket(this._url, this._protocols, this._options.ws);\n            if (!this._ws) {\n                this._cache.opStatus = WAMP_ERROR_MSG.NO_WS_OR_URL;\n                return this;\n            }\n            this._initWsCallbacks();\n\n        } else {\n            this._cache.opStatus = WAMP_ERROR_MSG.NO_REALM;\n        }\n\n        return this;\n    }\n\n    /**\n     * Disconnect from server\n     * @returns {Wampy}\n     */\n    disconnect () {\n        if (this._cache.sessionId) {\n            // need to send goodbye message to server\n            this._cache.isSayingGoodbye = true;\n            this._send([WAMP_MSG_SPEC.GOODBYE, {}, 'wamp.error.system_shutdown']);\n        } else if (this._ws) {\n            this._ws.close();\n        }\n\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n\n        return this;\n    }\n\n    /**\n     * Abort WAMP session establishment\n     *\n     * @returns {Wampy}\n     */\n    abort () {\n\n        if (!this._cache.sessionId && this._ws.readyState === 1) {\n            this._send([WAMP_MSG_SPEC.ABORT, {}, 'wamp.error.abort']);\n            this._cache.sessionId = null;\n        }\n\n        this._ws.close();\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n\n        return this;\n    }\n\n    /**\n     * Subscribe to a topic on a broker\n     *\n     * @param {string} topicURI\n     * @param {function|object} callbacks - if it is a function - it will be treated as published event callback\n     *                          or it can be hash table of callbacks:\n     *                          { onSuccess: will be called when subscribe would be confirmed\n     *                            onError: will be called if subscribe would be aborted\n     *                            onEvent: will be called on receiving published event }\n     *\n     * @returns {Wampy}\n     */\n    subscribe (topicURI, callbacks) {\n        let reqId;\n\n        if (!this._preReqChecks(topicURI, 'broker', callbacks)) {\n            return this;\n        }\n\n        if (typeof callbacks === 'function') {\n            callbacks = { onEvent: callbacks };\n        } else if (!this._isPlainObject(callbacks) || typeof (callbacks.onEvent) === 'undefined') {\n            this._cache.opStatus = WAMP_ERROR_MSG.NO_CALLBACK_SPEC;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        if (!this._subscriptions[topicURI] || !this._subscriptions[topicURI].callbacks.length) {\n            // no such subscription or processing unsubscribing\n\n            reqId = this._getReqId();\n\n            this._requests[reqId] = {\n                topic: topicURI,\n                callbacks: callbacks\n            };\n\n            // WAMP SPEC: [SUBSCRIBE, Request|id, Options|dict, Topic|uri]\n            this._send([WAMP_MSG_SPEC.SUBSCRIBE, reqId, {}, topicURI]);\n\n        } else {    // already have subscription to this topic\n            // There is no such callback yet\n            if (this._subscriptions[topicURI].callbacks.indexOf(callbacks.onEvent) < 0) {\n                this._subscriptions[topicURI].callbacks.push(callbacks.onEvent);\n            }\n\n            if (callbacks.onSuccess) {\n                callbacks.onSuccess();\n            }\n        }\n\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n        return this;\n    }\n\n    /**\n     * Unsubscribe from topic\n     * @param {string} topicURI\n     * @param {function|object} callbacks - if it is a function - it will be treated as\n     *                          published event callback to remove or it can be hash table of callbacks:\n     *                          { onSuccess: will be called when unsubscribe would be confirmed\n     *                            onError: will be called if unsubscribe would be aborted\n     *                            onEvent: published event callback to remove }\n     * @returns {Wampy}\n     */\n    unsubscribe (topicURI, callbacks) {\n        let reqId, i = -1;\n\n        if (!this._preReqChecks(null, 'broker', callbacks)) {\n            return this;\n        }\n\n        if (this._subscriptions[topicURI]) {\n\n            reqId = this._getReqId();\n\n            if (typeof (callbacks) === 'undefined') {\n                this._subscriptions[topicURI].callbacks = [];\n                callbacks = {};\n            } else if (typeof callbacks === 'function') {\n                i = this._subscriptions[topicURI].callbacks.indexOf(callbacks);\n                callbacks = {};\n            } else if (callbacks.onEvent && typeof callbacks.onEvent === 'function') {\n                i = this._subscriptions[topicURI].callbacks.indexOf(callbacks.onEvent);\n            } else {\n                this._subscriptions[topicURI].callbacks = [];\n            }\n\n            if (i >= 0) {\n                this._subscriptions[topicURI].callbacks.splice(i, 1);\n            }\n\n            if (this._subscriptions[topicURI].callbacks.length) {\n                // There are another callbacks for this topic\n                this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n                return this;\n            }\n\n            this._requests[reqId] = {\n                topic: topicURI,\n                callbacks: callbacks\n            };\n\n            // WAMP_SPEC: [UNSUBSCRIBE, Request|id, SUBSCRIBED.Subscription|id]\n            this._send([WAMP_MSG_SPEC.UNSUBSCRIBE, reqId, this._subscriptions[topicURI].id]);\n\n        } else {\n            this._cache.opStatus = WAMP_ERROR_MSG.NON_EXIST_UNSUBSCRIBE;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n        return this;\n    }\n\n    /**\n     * Publish a event to topic\n     * @param {string} topicURI\n     * @param {string|number|Array|object} payload - optional parameter.\n     * @param {object} [callbacks] - optional hash table of callbacks:\n     *                          { onSuccess: will be called when publishing would be confirmed\n     *                            onError: will be called if publishing would be aborted }\n     * @param {object} advancedOptions - optional parameter. Must include any or all of the options:\n     *                          { exclude: integer|array WAMP session id(s) that won't receive a published event,\n     *                                      even though they may be subscribed\n     *                            exclude_authid: string|array Authentication id(s) that won't receive\n     *                                      a published event, even though they may be subscribed\n     *                            exclude_authrole: string|array Authentication role(s) that won't receive\n     *                                      a published event, even though they may be subscribed\n     *                            eligible: integer|array WAMP session id(s) that are allowed\n     *                                      to receive a published event\n     *                            eligible_authid: string|array Authentication id(s) that are allowed\n     *                                      to receive a published event\n     *                            eligible_authrole: string|array Authentication role(s) that are allowed\n     *                                      to receive a published event\n     *                            exclude_me: bool flag of receiving publishing event by initiator\n     *                            disclose_me: bool flag of disclosure of publisher identity (its WAMP session ID)\n     *                                      to receivers of a published event }\n     * @returns {Wampy}\n     */\n    publish (topicURI, payload, callbacks, advancedOptions) {\n        let reqId, msg, err = false, hasPayload = false;\n        const options = {};\n\n        if (!this._preReqChecks(topicURI, 'broker', callbacks)) {\n            return this;\n        }\n\n        if (this._isPlainObject(callbacks)) {\n            options.acknowledge = true;\n        }\n\n        if (typeof (advancedOptions) !== 'undefined') {\n\n            if (this._isPlainObject(advancedOptions)) {\n                if (advancedOptions.exclude) {\n                    if (this._isArray(advancedOptions.exclude) && advancedOptions.exclude.length) {\n                        options.exclude = advancedOptions.exclude;\n                    } else if (typeof advancedOptions.exclude === 'number') {\n                        options.exclude = [advancedOptions.exclude];\n                    } else {\n                        err = true;\n                    }\n                }\n\n                if (advancedOptions.exclude_authid) {\n                    if (this._isArray(advancedOptions.exclude_authid) && advancedOptions.exclude_authid.length) {\n                        options.exclude_authid = advancedOptions.exclude_authid;\n                    } else if (typeof advancedOptions.exclude_authid === 'string') {\n                        options.exclude_authid = [advancedOptions.exclude_authid];\n                    } else {\n                        err = true;\n                    }\n                }\n\n                if (advancedOptions.exclude_authrole) {\n                    if (this._isArray(advancedOptions.exclude_authrole) && advancedOptions.exclude_authrole.length) {\n                        options.exclude_authrole = advancedOptions.exclude_authrole;\n                    } else if (typeof advancedOptions.exclude_authrole === 'string') {\n                        options.exclude_authrole = [advancedOptions.exclude_authrole];\n                    } else {\n                        err = true;\n                    }\n                }\n\n                if (advancedOptions.eligible) {\n                    if (this._isArray(advancedOptions.eligible) && advancedOptions.eligible.length) {\n                        options.eligible = advancedOptions.eligible;\n                    } else if (typeof advancedOptions.eligible === 'number') {\n                        options.eligible = [advancedOptions.eligible];\n                    } else {\n                        err = true;\n                    }\n                }\n\n                if (advancedOptions.eligible_authid) {\n                    if (this._isArray(advancedOptions.eligible_authid) && advancedOptions.eligible_authid.length) {\n                        options.eligible_authid = advancedOptions.eligible_authid;\n                    } else if (typeof advancedOptions.eligible_authid === 'string') {\n                        options.eligible_authid = [advancedOptions.eligible_authid];\n                    } else {\n                        err = true;\n                    }\n                }\n\n                if (advancedOptions.eligible_authrole) {\n                    if (this._isArray(advancedOptions.eligible_authrole) && advancedOptions.eligible_authrole.length) {\n                        options.eligible_authrole = advancedOptions.eligible_authrole;\n                    } else if (typeof advancedOptions.eligible_authrole === 'string') {\n                        options.eligible_authrole = [advancedOptions.eligible_authrole];\n                    } else {\n                        err = true;\n                    }\n                }\n\n                if (advancedOptions.hasOwnProperty('exclude_me')) {\n                    options.exclude_me = advancedOptions.exclude_me !== false;\n                }\n\n                if (advancedOptions.hasOwnProperty('disclose_me')) {\n                    options.disclose_me = advancedOptions.disclose_me === true;\n                }\n\n            } else {\n                err = true;\n            }\n\n            if (err) {\n                this._cache.opStatus = WAMP_ERROR_MSG.INVALID_PARAM;\n\n                if (this._isPlainObject(callbacks) && callbacks.onError) {\n                    callbacks.onError({ error: this._cache.opStatus.description });\n                }\n\n                return this;\n            }\n        }\n\n        reqId = this._getReqId();\n\n        switch (arguments.length) {\n            case 1:\n                break;\n            case 2:\n                hasPayload = true;\n                break;\n            default:\n                this._requests[reqId] = {\n                    topic: topicURI,\n                    callbacks: callbacks\n                };\n                hasPayload = true;\n                break;\n        }\n\n        // WAMP_SPEC: [PUBLISH, Request|id, Options|dict, Topic|uri]\n        msg = [WAMP_MSG_SPEC.PUBLISH, reqId, options, topicURI];\n\n        if (hasPayload) {\n            // WAMP_SPEC: [PUBLISH, Request|id, Options|dict, Topic|uri, Arguments|list (, ArgumentsKw|dict)]\n            if (this._isArray(payload)) {\n                msg.push(payload);\n            } else if (this._isPlainObject(payload)) {\n                // It's a wampy unified form of payload passing\n                if (payload.argsList || payload.argsDict) {\n                    if (payload.argsList) {\n                        msg.push(payload.argsList);\n                    }\n\n                    if (payload.argsDict) {\n                        if (msg.length === 4) {\n                            msg.push([]);\n                        }\n                        msg.push(payload.argsDict);\n                    }\n                } else {\n                    msg.push([], payload);\n                }\n            } else {    // assume it's a single value\n                msg.push([payload]);\n            }\n        }\n\n        this._send(msg);\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n        return this;\n    }\n\n    /**\n     * Remote Procedure Call\n     * @param {string} topicURI\n     * @param {string|number|Array|object} payload - can be either a value of any type or null\n     * @param {function|object} callbacks - if it is a function - it will be treated as result callback function\n     *                          or it can be hash table of callbacks:\n     *                          { onSuccess: will be called with result on successful call\n     *                            onError: will be called if invocation would be aborted }\n     * @param {object} advancedOptions - optional parameter. Must include any or all of the options:\n     *                          { disclose_me: bool flag of disclosure of Caller identity (WAMP session ID)\n     *                                  to endpoints of a routed call\n     *                            receive_progress: bool flag for receiving progressive results. In this case\n     *                                  onSuccess function will be called every time on receiving result\n     *                            timeout: integer timeout (in ms) for the call to finish }\n     * @returns {Wampy}\n     */\n    call (topicURI, payload, callbacks, advancedOptions) {\n        let reqId, msg, err = false;\n        const options = {};\n\n        if (!this._preReqChecks(topicURI, 'dealer', callbacks)) {\n            return this;\n        }\n\n        if (typeof callbacks === 'function') {\n            callbacks = { onSuccess: callbacks };\n        } else if (!this._isPlainObject(callbacks) || typeof (callbacks.onSuccess) === 'undefined') {\n            this._cache.opStatus = WAMP_ERROR_MSG.NO_CALLBACK_SPEC;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        if (typeof (advancedOptions) !== 'undefined') {\n\n            if (this._isPlainObject(advancedOptions)) {\n                if (advancedOptions.hasOwnProperty('disclose_me')) {\n                    options.disclose_me = advancedOptions.disclose_me === true;\n                }\n\n                if (advancedOptions.hasOwnProperty('receive_progress')) {\n                    options.receive_progress = advancedOptions.receive_progress === true;\n                }\n\n                if (advancedOptions.hasOwnProperty('timeout')) {\n                    if (typeof advancedOptions.timeout === 'number') {\n                        options.timeout = advancedOptions.timeout;\n                    } else {\n                        err = true;\n                    }\n                }\n\n            } else {\n                err = true;\n            }\n\n            if (err) {\n                this._cache.opStatus = WAMP_ERROR_MSG.INVALID_PARAM;\n\n                if (this._isPlainObject(callbacks) && callbacks.onError) {\n                    callbacks.onError({ error: this._cache.opStatus.description });\n                }\n\n                return this;\n            }\n        }\n\n        do {\n            reqId = this._getReqId();\n        } while (reqId in this._calls);\n\n        this._calls[reqId] = callbacks;\n\n        // WAMP SPEC: [CALL, Request|id, Options|dict, Procedure|uri, (Arguments|list, ArgumentsKw|dict)]\n        msg = [WAMP_MSG_SPEC.CALL, reqId, options, topicURI];\n\n        if (payload !== null) {\n            if (this._isArray(payload)) {\n                msg.push(payload);\n            } else if (this._isPlainObject(payload)) {\n                // It's a wampy unified form of payload passing\n                if (payload.argsList || payload.argsDict) {\n                    if (payload.argsList) {\n                        msg.push(payload.argsList);\n                    }\n\n                    if (payload.argsDict) {\n                        if (msg.length === 4) {\n                            msg.push([]);\n                        }\n                        msg.push(payload.argsDict);\n                    }\n                } else {\n                    msg.push([], payload);\n                }\n            } else {    // assume it's a single value\n                msg.push([payload]);\n            }\n        }\n\n        this._send(msg);\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n        return this;\n    }\n\n    /**\n     * RPC invocation cancelling\n     *\n     * @param {int} reqId RPC call request ID\n     * @param {function|object} callbacks - if it is a function - it will be called if successfully\n     *                          sent canceling message or it can be hash table of callbacks:\n     *                          { onSuccess: will be called if successfully sent canceling message\n     *                            onError: will be called if some error occurred }\n     * @param {object} advancedOptions - optional parameter. Must include any or all of the options:\n     *                          { mode: string|one of the possible modes:\n     *                                  \"skip\" | \"kill\" | \"killnowait\". Skip is default.\n     *                          }\n     *\n     * @returns {Wampy}\n     */\n    cancel (reqId, callbacks, advancedOptions) {\n        const options = { mode: 'skip' };\n\n        if (!this._preReqChecks(null, 'dealer', callbacks)) {\n            return this;\n        }\n\n        if (!reqId || !this._calls[reqId]) {\n            this._cache.opStatus = WAMP_ERROR_MSG.NON_EXIST_RPC_REQ_ID;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        if ((typeof (advancedOptions) !== 'undefined') &&\n            (this._isPlainObject(advancedOptions)) &&\n            (advancedOptions.hasOwnProperty('mode'))) {\n\n            options.mode = /skip|kill|killnowait/.test(advancedOptions.mode) ? advancedOptions.mode : 'skip';\n        }\n\n        // WAMP SPEC: [CANCEL, CALL.Request|id, Options|dict]\n        this._send([WAMP_MSG_SPEC.CANCEL, reqId, options]);\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n\n        callbacks.onSuccess && callbacks.onSuccess();\n\n        return this;\n    }\n\n    /**\n     * RPC registration for invocation\n     * @param {string} topicURI\n     * @param {function|object} callbacks - if it is a function - it will be treated as rpc itself\n     *                          or it can be hash table of callbacks:\n     *                          { rpc: registered procedure\n     *                            onSuccess: will be called on successful registration\n     *                            onError: will be called if registration would be aborted }\n     * @returns {Wampy}\n     */\n    register (topicURI, callbacks) {\n        let reqId;\n\n        if (!this._preReqChecks(topicURI, 'dealer', callbacks)) {\n            return this;\n        }\n\n        if (typeof callbacks === 'function') {\n            callbacks = { rpc: callbacks };\n        } else if (!this._isPlainObject(callbacks) || typeof (callbacks.rpc) === 'undefined') {\n            this._cache.opStatus = WAMP_ERROR_MSG.NO_CALLBACK_SPEC;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        if (!this._rpcRegs[topicURI] || !this._rpcRegs[topicURI].callbacks.length) {\n            // no such registration or processing unregistering\n\n            reqId = this._getReqId();\n\n            this._requests[reqId] = {\n                topic: topicURI,\n                callbacks: callbacks\n            };\n\n            // WAMP SPEC: [REGISTER, Request|id, Options|dict, Procedure|uri]\n            this._send([WAMP_MSG_SPEC.REGISTER, reqId, {}, topicURI]);\n            this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n            this._cache.opStatus.reqId = reqId;\n        } else {    // already have registration with such topicURI\n            this._cache.opStatus = WAMP_ERROR_MSG.RPC_ALREADY_REGISTERED;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n        }\n\n        return this;\n\n    }\n\n    /**\n     * RPC unregistration for invocation\n     * @param {string} topicURI\n     * @param {function|object} callbacks - if it is a function, it will be called on successful unregistration\n     *                          or it can be hash table of callbacks:\n     *                          { onSuccess: will be called on successful unregistration\n     *                            onError: will be called if unregistration would be aborted }\n     * @returns {Wampy}\n     */\n    unregister (topicURI, callbacks) {\n        let reqId;\n\n        if (!this._preReqChecks(topicURI, 'dealer', callbacks)) {\n            return this;\n        }\n\n        if (typeof callbacks === 'function') {\n            callbacks = { onSuccess: callbacks };\n        }\n\n        if (this._rpcRegs[topicURI]) {   // there is such registration\n\n            reqId = this._getReqId();\n\n            this._requests[reqId] = {\n                topic: topicURI,\n                callbacks: callbacks\n            };\n\n            // WAMP SPEC: [UNREGISTER, Request|id, REGISTERED.Registration|id]\n            this._send([WAMP_MSG_SPEC.UNREGISTER, reqId, this._rpcRegs[topicURI].id]);\n            this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n            this._cache.opStatus.reqId = reqId;\n        } else {    // there is no registration with such topicURI\n            this._cache.opStatus = WAMP_ERROR_MSG.NON_EXIST_RPC_UNREG;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n        }\n\n        return this;\n    }\n}\n\nexport default Wampy;\nexport { Wampy };\n"]}
=======
{"version":3,"sources":["../src/wampy.js"],"names":["Wampy","url","options","version","_url","_protocols","_wamp_features","agent","roles","publisher","features","subscriber_blackwhite_listing","publisher_exclusion","publisher_identification","subscriber","caller","caller_identification","progressive_call_results","call_canceling","call_timeout","callee","_cache","sessionId","reqId","server_wamp_features","isSayingGoodbye","opStatus","code","description","timer","reconnectingAttempts","_ws","_wsQueue","_requests","_calls","_subscriptions","_subsTopics","Set","_rpcRegs","_rpcNames","_options","debug","autoReconnect","reconnectInterval","maxRetries","realm","helloCustomDetails","authid","authmethods","onChallenge","onConnect","onClose","onError","onReconnect","onReconnectSuccess","ws","serializer","_isPlainObject","_merge","connect","console","log","arguments","obj","l","length","i","attr","Array","isArray","constructor","Object","unshift","protocol","topicURI","role","callbacks","flag","toUpperCase","_validateURI","URI_ERROR","error","uri","re","test","indexOf","msg","encode","e","Error","decode","push","_encode","readyState","send","shift","onopen","_wsOnOpen","onclose","_wsOnClose","event","onmessage","_wsOnMessage","onerror","_wsOnError","serverProtocol","split","_log","NO_SERIALIZER_AVAILABLE","type","binaryType","INVALID_SERIALIZER_TYPE","binatyType","HELLO","setTimeout","_wsReconnect","_resetState","data","_decode","then","id","p","WELCOME","_renewSubscriptions","_renewRegistrations","_send","ABORT","details","close","CHALLENGE","Promise","resolve","reject","key","AUTHENTICATE","catch","message","CRA_EXCEPTION","NO_CRA_CB_OR_ID","GOODBYE","ERROR","SUBSCRIBE","UNSUBSCRIBE","PUBLISH","REGISTER","UNREGISTER","argsList","argsDict","INVOCATION","CALL","SUBSCRIBED","topic","onEvent","add","onSuccess","UNSUBSCRIBED","has","delete","PUBLISHED","EVENT","RESULT","progress","REGISTERED","rpc","UNREGISTERED","results","YIELD","_isArray","NON_EXIST_RPC_INVOCATION","err","_initWsCallbacks","subs","st","subscribe","rpcs","rn","rpcName","register","opts","authp","_setWsProtocols","NO_WS_OR_URL","NO_REALM","SUCCESS","_preReqChecks","NO_CALLBACK_SPEC","_getReqId","splice","NON_EXIST_UNSUBSCRIBE","payload","advancedOptions","hasPayload","acknowledge","exclude","exclude_authid","exclude_authrole","eligible","eligible_authid","eligible_authrole","hasOwnProperty","exclude_me","disclose_me","INVALID_PARAM","receive_progress","timeout","mode","NON_EXIST_RPC_REQ_ID","CANCEL","RPC_ALREADY_REGISTERED","NON_EXIST_RPC_UNREG"],"mappings":"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","file":"wampy.js","sourcesContent":["/**\n * Project: wampy.js\n *\n * https://github.com/KSDaemon/wampy.js\n *\n * A lightweight client-side implementation of\n * WAMP (The WebSocket Application Messaging Protocol v2)\n * http://wamp.ws\n *\n * Provides asynchronous RPC/PubSub over WebSocket.\n *\n * Copyright 2014 KSDaemon. Licensed under the MIT License.\n * See @license text at http://www.opensource.org/licenses/mit-license.php\n *\n */\n\nimport {WAMP_ERROR_MSG, WAMP_MSG_SPEC} from './constants';\nimport {getWebSocket, isBinaryTypeAllowed} from './utils';\nimport {JsonSerializer} from './serializers/JsonSerializer';\n\n/**\n * WAMP Client Class\n */\nclass Wampy {\n\n    /**\n     * Wampy constructor\n     * @param {string} [url]\n     * @param {Object} [options]\n     */\n    constructor (url, options) {\n\n        /**\n         * Wampy version\n         * @type {string}\n         * @private\n         */\n        this.version = 'v6.0.0';\n\n        /**\n         * WS Url\n         * @type {string}\n         * @private\n         */\n        this._url = (typeof url === 'string') ? url : null;\n\n        /**\n         * WS protocols\n         * @type {Array}\n         * @private\n         */\n        this._protocols = ['wamp.2.json'];\n\n        /**\n         * WAMP features, supported by Wampy\n         * @type {object}\n         * @private\n         */\n        this._wamp_features = {\n            agent: 'Wampy.js ' + this.version,\n            roles: {\n                publisher: {\n                    features: {\n                        subscriber_blackwhite_listing: true,\n                        publisher_exclusion: true,\n                        publisher_identification: true\n                    }\n                },\n                subscriber: {},\n                caller: {\n                    features: {\n                        caller_identification: true,\n                        progressive_call_results: true,\n                        call_canceling: true,\n                        call_timeout: true\n                    }\n                },\n                callee: {\n                    features: {\n                        caller_identification: true\n                    }\n                }\n            }\n        };\n\n        /**\n         * Internal cache for object lifetime\n         * @type {Object}\n         * @private\n         */\n        this._cache = {\n            /**\n             * WAMP Session ID\n             * @type {string}\n             */\n            sessionId: null,\n\n            /**\n             * WAMP Session scope requests ID\n             * @type {int}\n             */\n            reqId: 0,\n\n            /**\n             * Server WAMP roles and features\n             */\n            server_wamp_features: { roles: {} },\n\n            /**\n             * Are we in state of saying goodbye\n             * @type {boolean}\n             */\n            isSayingGoodbye: false,\n\n            /**\n             * Status of last operation\n             */\n            opStatus: { code: 0, description: 'Success!', reqId: 0 },\n\n            /**\n             * Timer for reconnection\n             * @type {null}\n             */\n            timer: null,\n\n            /**\n             * Reconnection attempts\n             * @type {number}\n             */\n            reconnectingAttempts: 0\n        };\n\n        /**\n         * WebSocket object\n         * @type {Object}\n         * @private\n         */\n        this._ws = null;\n\n        /**\n         * Internal queue for websocket requests, for case of disconnect\n         * @type {Array}\n         * @private\n         */\n        this._wsQueue = [];\n\n        /**\n         * Internal queue for wamp requests\n         * @type {object}\n         * @private\n         */\n        this._requests = {};\n\n        /**\n         * Stored RPC\n         * @type {object}\n         * @private\n         */\n        this._calls = {};\n\n        /**\n         * Stored Pub/Sub\n         * @type {object}\n         * @private\n         */\n        this._subscriptions = {};\n\n        /**\n         * Stored Pub/Sub topics\n         * @type {Array}\n         * @private\n         */\n        this._subsTopics = new Set();\n\n        /**\n         * Stored RPC Registrations\n         * @type {object}\n         * @private\n         */\n        this._rpcRegs = {};\n\n        /**\n         * Stored RPC names\n         * @type {Array}\n         * @private\n         */\n        this._rpcNames = new Set();\n\n        /**\n         * Options hash-table\n         * @type {Object}\n         * @private\n         */\n        this._options = {\n            /**\n             * Logging\n             * @type {boolean}\n             */\n            debug: false,\n\n            /**\n             * Reconnecting flag\n             * @type {boolean}\n             */\n            autoReconnect: true,\n\n            /**\n             * Reconnecting interval (in ms)\n             * @type {number}\n             */\n            reconnectInterval: 2 * 1000,\n\n            /**\n             * Maximum reconnection retries\n             * @type {number}\n             */\n            maxRetries: 25,\n\n            /**\n             * WAMP Realm to join\n             * @type {string}\n             */\n            realm: null,\n\n            /**\n             * Custom attributes to send to router on hello\n             * @type {object}\n             */\n            helloCustomDetails: null,\n\n            /**\n             * Authentication id to use in challenge\n             * @type {string}\n             */\n            authid: null,\n\n            /**\n             * Supported authentication methods\n             * @type {array}\n             */\n            authmethods: [],\n\n            /**\n             * onChallenge callback\n             * @type {function}\n             */\n            onChallenge: null,\n\n            /**\n             * onConnect callback\n             * @type {function}\n             */\n            onConnect: null,\n\n            /**\n             * onClose callback\n             * @type {function}\n             */\n            onClose: null,\n\n            /**\n             * onError callback\n             * @type {function}\n             */\n            onError: null,\n\n            /**\n             * onReconnect callback\n             * @type {function}\n             */\n            onReconnect: null,\n\n            /**\n             * onReconnectSuccess callback\n             * @type {function}\n             */\n            onReconnectSuccess: null,\n\n            /**\n             * User provided WebSocket class\n             * @type {function}\n             */\n            ws: null,\n\n            /**\n             * User provided msgpack class\n             * @type {object}\n             */\n            serializer: new JsonSerializer()\n        };\n\n        if (this._isPlainObject(options)) {\n            this._options = this._merge(this._options, options);\n        } else if (this._isPlainObject(url)) {\n            this._options = this._merge(this._options, url);\n        }\n\n        if (this._url) {\n            this.connect();\n        }\n\n    }\n\n    /* Internal utils methods */\n    /**\n     * Internal logger\n     * @private\n     */\n    _log () {\n        if (this._options.debug) {\n            console.log(arguments);\n        }\n    }\n\n    /**\n     * Get the new unique request id\n     * @returns {number}\n     * @private\n     */\n    _getReqId () {\n        return ++this._cache.reqId;\n    }\n\n    /**\n     * Merge argument objects into one\n     * @returns {Object}\n     * @private\n     */\n    _merge () {\n        const obj = {}, l = arguments.length;\n        let i, attr;\n\n        for (i = 0; i < l; i++) {\n            for (attr in arguments[i]) {\n                obj[attr] = arguments[i][attr];\n            }\n        }\n\n        return obj;\n    }\n\n    /**\n     * Check if value is array\n     * @param obj\n     * @returns {boolean}\n     * @private\n     */\n    _isArray (obj) {\n        return (!!obj) && (Array.isArray(obj));\n    }\n\n    /**\n     * Check if value is object literal\n     * @param obj\n     * @returns {boolean}\n     * @private\n     */\n    _isPlainObject (obj) {\n        return (!!obj) && (obj.constructor === Object);\n    }\n\n    /**\n     * Fix websocket protocols based on options\n     * @private\n     */\n    _setWsProtocols () {\n        if (!(this._options.serializer instanceof JsonSerializer)) {\n            this._protocols.unshift('wamp.2.' + this._options.serializer.protocol);\n        }\n    }\n\n    /**\n     * Prerequisite checks for any wampy api call\n     * @param {string} topicURI\n     * @param {string} role\n     * @param {object} callbacks\n     * @returns {boolean}\n     * @private\n     */\n    _preReqChecks (topicURI, role, callbacks) {\n        let flag = true;\n\n        if (this._cache.sessionId && !this._cache.server_wamp_features.roles[role]) {\n            this._cache.opStatus = WAMP_ERROR_MSG['NO_' + role.toUpperCase()];\n            flag = false;\n        }\n\n        if (topicURI && !this._validateURI(topicURI)) {\n            this._cache.opStatus = WAMP_ERROR_MSG.URI_ERROR;\n            flag = false;\n        }\n\n        if (flag) {\n            return true;\n        }\n\n        if (this._isPlainObject(callbacks) && callbacks.onError) {\n            callbacks.onError({ error: this._cache.opStatus.description });\n        }\n\n        return false;\n    }\n\n    /**\n     * Validate uri\n     * @param {string} uri\n     * @returns {boolean}\n     * @private\n     */\n    _validateURI (uri) {\n        const re = /^([0-9a-zA-Z_]{2,}\\.)*([0-9a-zA-Z_]{2,})$/;\n        return !(!re.test(uri) || uri.indexOf('wamp') === 0);\n    }\n\n    /**\n     * Encode WAMP message\n     * @param {Array} msg\n     * @returns {*}\n     * @private\n     */\n    _encode (msg) {\n        try {\n            return this._options.serializer.encode(msg);\n        } catch (e) {\n            throw new Error('[wampy] encoding exception!');\n        }\n    }\n\n    /**\n     * Decode WAMP message\n     * @param  msg\n     * @returns {Promise}\n     * @private\n     */\n    _decode (msg) {\n        return this._options.serializer.decode(msg);\n    }\n\n    /**\n     * Send encoded message to server\n     * @param {Array} msg\n     * @private\n     */\n    _send (msg) {\n        if (msg) {\n            this._wsQueue.push(this._encode(msg));\n        }\n\n        if (this._ws && this._ws.readyState === 1 && this._cache.sessionId) {\n            while (this._wsQueue.length) {\n                this._ws.send(this._wsQueue.shift());\n            }\n        }\n    }\n\n    /**\n     * Reset internal state and cache\n     * @private\n     */\n    _resetState () {\n        this._wsQueue = [];\n        this._subscriptions = {};\n        this._subsTopics = new Set();\n        this._requests = {};\n        this._calls = {};\n        this._rpcRegs = {};\n        this._rpcNames = new Set();\n\n        // Just keep attrs that are have to be present\n        this._cache = {\n            reqId: 0,\n            reconnectingAttempts: 0\n        };\n    }\n\n    /**\n     * Initialize internal websocket callbacks\n     * @private\n     */\n    _initWsCallbacks () {\n        if (this._ws) {\n            this._ws.onopen = () => {\n                this._wsOnOpen();\n            };\n            this._ws.onclose = event => {\n                this._wsOnClose(event);\n            };\n            this._ws.onmessage = event => {\n                this._wsOnMessage(event);\n            };\n            this._ws.onerror = error => {\n                this._wsOnError(error);\n            };\n        }\n    }\n\n    /**\n     * Internal websocket on open callback\n     * @private\n     */\n    _wsOnOpen () {\n        const options = this._merge(this._options.helloCustomDetails, this._wamp_features),\n            serverProtocol = this._ws.protocol ? this._ws.protocol.split('.')[2] : '';\n\n        if (this._options.authid) {\n            options.authmethods = this._options.authmethods;\n            options.authid = this._options.authid;\n        }\n\n        this._log('[wampy] websocket connected');\n\n        if (this._options.serializer.protocol !== serverProtocol) {\n            // Server have chosen not our preferred protocol\n\n            // Falling back to json if possible\n            if (serverProtocol === 'json') {\n                this._options.serializer = new JsonSerializer();\n            } else {\n                this._cache.opStatus = WAMP_ERROR_MSG.NO_SERIALIZER_AVAILABLE;\n                return this;\n            }\n\n        }\n\n        const type = this._options.serializer.binaryType;\n\n        if (!isBinaryTypeAllowed(type)) {\n            this._cache.opStatus = WAMP_ERROR_MSG.INVALID_SERIALIZER_TYPE;\n            return this;\n        }\n\n        this._ws.binatyType = type;\n\n        // WAMP SPEC: [HELLO, Realm|uri, Details|dict]\n        // Sending directly 'cause it's a hello msg and no sessionId check is needed\n        this._ws.send(this._encode([WAMP_MSG_SPEC.HELLO, this._options.realm, options]));\n    }\n\n    /**\n     * Internal websocket on close callback\n     * @param {object} event\n     * @private\n     */\n    _wsOnClose (event) {\n        this._log('[wampy] websocket disconnected. Info: ', event);\n\n        // Automatic reconnection\n        if ((this._cache.sessionId || this._cache.reconnectingAttempts) &&\n            this._options.autoReconnect && this._cache.reconnectingAttempts < this._options.maxRetries && !this._cache.isSayingGoodbye) {\n            this._cache.sessionId = null;\n            this._cache.timer = setTimeout(\n                () => {\n                    this._wsReconnect();\n                },\n                this._options.reconnectInterval\n            );\n        } else {\n            // No reconnection needed or reached max retries count\n            if (this._options.onClose) {\n                this._options.onClose();\n            }\n\n            this._resetState();\n            this._ws = null;\n        }\n    }\n\n    /**\n     * Internal websocket on event callback\n     * @param {object} event\n     * @private\n     */\n    _wsOnMessage (event) {\n        this._log('[wampy] websocket message received', event.data);\n\n        this._decode(event.data).then(data => {\n\n            let id, i, msg, p;\n\n            switch (data[0]) {\n                case WAMP_MSG_SPEC.WELCOME:\n                    // WAMP SPEC: [WELCOME, Session|id, Details|dict]\n\n                    this._cache.sessionId = data[1];\n                    this._cache.server_wamp_features = data[2];\n\n                    if (this._cache.reconnectingAttempts) {\n                        // There was reconnection\n\n                        this._cache.reconnectingAttempts = 0;\n\n                        if (this._options.onReconnectSuccess) {\n                            this._options.onReconnectSuccess();\n                        }\n\n                        // Let's renew all previous state\n                        this._renewSubscriptions();\n                        this._renewRegistrations();\n\n                    } else {\n                        // Firing onConnect event on real connection to WAMP server\n                        if (this._options.onConnect) {\n                            this._options.onConnect();\n                        }\n                    }\n\n                    // Send local queue if there is something out there\n                    this._send();\n\n                    break;\n                case WAMP_MSG_SPEC.ABORT:\n                    // WAMP SPEC: [ABORT, Details|dict, Reason|uri]\n                    if (this._options.onError) {\n                        this._options.onError({ error: data[2], details: data[1] });\n                    }\n                    this._ws.close();\n                    break;\n                case WAMP_MSG_SPEC.CHALLENGE:\n                    // WAMP SPEC: [CHALLENGE, AuthMethod|string, Extra|dict]\n\n                    if (this._options.authid && typeof this._options.onChallenge === 'function') {\n\n                        p = new Promise((resolve, reject) => {\n                            resolve(this._options.onChallenge(data[1], data[2]));\n                        });\n\n                        p.then((key) => {\n\n                            // Sending directly 'cause it's a challenge msg and no sessionId check is needed\n                            this._ws.send(this._encode([WAMP_MSG_SPEC.AUTHENTICATE, key, {}]));\n\n                        }).catch(e => {\n                            this._ws.send(this._encode([\n                                WAMP_MSG_SPEC.ABORT,\n                                { message: 'Exception in onChallenge handler raised!' },\n                                'wamp.error.cannot_authenticate'\n                            ]));\n                            if (this._options.onError) {\n                                this._options.onError({ error: WAMP_ERROR_MSG.CRA_EXCEPTION.description });\n                            }\n                            this._ws.close();\n                            this._cache.opStatus = WAMP_ERROR_MSG.CRA_EXCEPTION;\n                        });\n\n                    } else {\n\n                        this._ws.send(this._encode([\n                            WAMP_MSG_SPEC.ABORT,\n                            { message: WAMP_ERROR_MSG.NO_CRA_CB_OR_ID.description },\n                            'wamp.error.cannot_authenticate'\n                        ]));\n                        if (this._options.onError) {\n                            this._options.onError({ error: WAMP_ERROR_MSG.NO_CRA_CB_OR_ID.description });\n                        }\n                        this._ws.close();\n                        this._cache.opStatus = WAMP_ERROR_MSG.NO_CRA_CB_OR_ID;\n\n                    }\n                    break;\n                case WAMP_MSG_SPEC.GOODBYE:\n                    // WAMP SPEC: [GOODBYE, Details|dict, Reason|uri]\n                    if (!this._cache.isSayingGoodbye) {    // get goodbye, initiated by server\n                        this._cache.isSayingGoodbye = true;\n                        this._send([WAMP_MSG_SPEC.GOODBYE, {}, 'wamp.error.goodbye_and_out']);\n                    }\n                    this._cache.sessionId = null;\n                    this._ws.close();\n                    break;\n                case WAMP_MSG_SPEC.ERROR:\n                    // WAMP SPEC: [ERROR, REQUEST.Type|int, REQUEST.Request|id, Details|dict,\n                    //             Error|uri, (Arguments|list, ArgumentsKw|dict)]\n                    switch (data[1]) {\n                        case WAMP_MSG_SPEC.SUBSCRIBE:\n                        case WAMP_MSG_SPEC.UNSUBSCRIBE:\n                        case WAMP_MSG_SPEC.PUBLISH:\n                        case WAMP_MSG_SPEC.REGISTER:\n                        case WAMP_MSG_SPEC.UNREGISTER:\n\n                            this._requests[data[2]] && this._requests[data[2]].callbacks.onError &&\n                            this._requests[data[2]].callbacks.onError({\n                                error: data[4],\n                                details: data[3],\n                                argsList: data[5],\n                                argsDict: data[6]\n                            });\n                            delete this._requests[data[2]];\n\n                            break;\n                        case WAMP_MSG_SPEC.INVOCATION:\n                            break;\n                        case WAMP_MSG_SPEC.CALL:\n\n                            // WAMP SPEC: [ERROR, CALL, CALL.Request|id, Details|dict,\n                            //             Error|uri, Arguments|list, ArgumentsKw|dict]\n                            this._calls[data[2]] && this._calls[data[2]].onError &&\n                            this._calls[data[2]].onError({\n                                error: data[4],\n                                details: data[3],\n                                argsList: data[5],\n                                argsDict: data[6]\n                            });\n                            delete this._calls[data[2]];\n\n                            break;\n                        default:\n                            this._log('[wampy] Received non-compliant WAMP ERROR message');\n                            break;\n                    }\n                    break;\n                case WAMP_MSG_SPEC.SUBSCRIBED:\n                    // WAMP SPEC: [SUBSCRIBED, SUBSCRIBE.Request|id, Subscription|id]\n                    if (this._requests[data[1]]) {\n                        this._subscriptions[this._requests[data[1]].topic] = this._subscriptions[data[2]] = {\n                            id: data[2],\n                            callbacks: [this._requests[data[1]].callbacks.onEvent]\n                        };\n\n                        this._subsTopics.add(this._requests[data[1]].topic);\n\n                        if (this._requests[data[1]].callbacks.onSuccess) {\n                            this._requests[data[1]].callbacks.onSuccess();\n                        }\n\n                        delete this._requests[data[1]];\n\n                    }\n                    break;\n                case WAMP_MSG_SPEC.UNSUBSCRIBED:\n                    // WAMP SPEC: [UNSUBSCRIBED, UNSUBSCRIBE.Request|id]\n                    if (this._requests[data[1]]) {\n                        id = this._subscriptions[this._requests[data[1]].topic].id;\n                        delete this._subscriptions[this._requests[data[1]].topic];\n                        delete this._subscriptions[id];\n\n                        if (this._subsTopics.has(this._requests[data[1]].topic)) {\n                            this._subsTopics.delete(this._requests[data[1]].topic);\n                        }\n\n                        if (this._requests[data[1]].callbacks.onSuccess) {\n                            this._requests[data[1]].callbacks.onSuccess();\n                        }\n\n                        delete this._requests[data[1]];\n                    }\n                    break;\n                case WAMP_MSG_SPEC.PUBLISHED:\n                    // WAMP SPEC: [PUBLISHED, PUBLISH.Request|id, Publication|id]\n                    if (this._requests[data[1]]) {\n                        if (this._requests[data[1]].callbacks && this._requests[data[1]].callbacks.onSuccess) {\n                            this._requests[data[1]].callbacks.onSuccess();\n                        }\n\n                        delete this._requests[data[1]];\n\n                    }\n                    break;\n                case WAMP_MSG_SPEC.EVENT:\n                    if (this._subscriptions[data[1]]) {\n\n                        // WAMP SPEC: [EVENT, SUBSCRIBED.Subscription|id, PUBLISHED.Publication|id,\n                        //             Details|dict, PUBLISH.Arguments|list, PUBLISH.ArgumentKw|dict]\n\n                        i = this._subscriptions[data[1]].callbacks.length;\n                        while (i--) {\n                            this._subscriptions[data[1]].callbacks[i]({\n                                details: data[3],\n                                argsList: data[4],\n                                argsDict: data[5]\n                            });\n                        }\n\n                    }\n                    break;\n                case WAMP_MSG_SPEC.RESULT:\n                    if (this._calls[data[1]]) {\n\n                        // WAMP SPEC: [RESULT, CALL.Request|id, Details|dict,\n                        //             YIELD.Arguments|list, YIELD.ArgumentsKw|dict]\n\n                        this._calls[data[1]].onSuccess({\n                            details: data[2],\n                            argsList: data[3],\n                            argsDict: data[4]\n                        });\n                        if (!(data[2].progress && data[2].progress === true)) {\n                            // We receive final result (progressive or not)\n                            delete this._calls[data[1]];\n                        }\n\n                    }\n                    break;\n                // case WAMP_MSG_SPEC.REGISTER:\n                //     // WAMP SPEC:\n                //     break;\n                case WAMP_MSG_SPEC.REGISTERED:\n                    // WAMP SPEC: [REGISTERED, REGISTER.Request|id, Registration|id]\n                    if (this._requests[data[1]]) {\n                        this._rpcRegs[this._requests[data[1]].topic] = this._rpcRegs[data[2]] = {\n                            id: data[2],\n                            callbacks: [this._requests[data[1]].callbacks.rpc]\n                        };\n\n                        this._rpcNames.add(this._requests[data[1]].topic);\n\n                        if (this._requests[data[1]].callbacks && this._requests[data[1]].callbacks.onSuccess) {\n                            this._requests[data[1]].callbacks.onSuccess();\n                        }\n\n                        delete this._requests[data[1]];\n\n                    }\n                    break;\n                // case WAMP_MSG_SPEC.UNREGISTER:\n                //     // WAMP SPEC:\n                //     break;\n                case WAMP_MSG_SPEC.UNREGISTERED:\n                    // WAMP SPEC: [UNREGISTERED, UNREGISTER.Request|id]\n                    if (this._requests[data[1]]) {\n                        id = this._rpcRegs[this._requests[data[1]].topic].id;\n                        delete this._rpcRegs[this._requests[data[1]].topic];\n                        delete this._rpcRegs[id];\n\n                        if (this._rpcNames.has(this._requests[data[1]].topic)) {\n                            this._rpcNames.delete(this._requests[data[1]].topic);\n                        }\n\n                        if (this._requests[data[1]].callbacks && this._requests[data[1]].callbacks.onSuccess) {\n                            this._requests[data[1]].callbacks.onSuccess();\n                        }\n\n                        delete this._requests[data[1]];\n                    }\n                    break;\n                case WAMP_MSG_SPEC.INVOCATION:\n                    if (this._rpcRegs[data[2]]) {\n\n                        // WAMP SPEC: [INVOCATION, Request|id, REGISTERED.Registration|id,\n                        //             Details|dict, CALL.Arguments|list, CALL.ArgumentsKw|dict]\n\n                        p = new Promise((resolve, reject) => {\n                            resolve(this._rpcRegs[data[2]].callbacks[0]({\n                                details: data[3],\n                                argsList: data[4],\n                                argsDict: data[5]\n                            }));\n                        });\n\n                        p.then((results) => {\n                            // WAMP SPEC: [YIELD, INVOCATION.Request|id, Options|dict, (Arguments|list, ArgumentsKw|dict)]\n                            msg = [WAMP_MSG_SPEC.YIELD, data[1], {}];\n\n                            if (this._isPlainObject(results)) {\n\n                                if (this._isPlainObject(results.options)) {\n                                    msg[2] = results.options;\n                                }\n\n                                if (this._isArray(results.argsList)) {\n                                    msg.push(results.argsList);\n                                } else if (typeof (results.argsList) !== 'undefined') {\n                                    msg.push([results.argsList]);\n                                }\n\n                                if (this._isPlainObject(results.argsDict)) {\n                                    if (msg.length === 3) {\n                                        msg.push([]);\n                                    }\n                                    msg.push(results.argsDict);\n                                }\n                            } else {\n                                msg = [WAMP_MSG_SPEC.YIELD, data[1], {}];\n                            }\n                            this._send(msg);\n                        }).catch(e => {\n                            let msg = [WAMP_MSG_SPEC.ERROR, WAMP_MSG_SPEC.INVOCATION,\n                                data[1], e.details || {}, e.error || 'wamp.error.invocation_exception'];\n\n                            if (e.argsList && this._isArray(e.argsList)) {\n                                msg.push(e.argsList);\n                            }\n\n                            if (e.argsDict && this._isPlainObject(e.argsDict)) {\n                                if (msg.length === 5) {\n                                    msg.push([]);\n                                }\n                                msg.push(e.argsDict);\n                            }\n                            this._send(msg);\n                        });\n\n                    } else {\n                        // WAMP SPEC: [ERROR, INVOCATION, INVOCATION.Request|id, Details|dict, Error|uri]\n                        this._send([WAMP_MSG_SPEC.ERROR, WAMP_MSG_SPEC.INVOCATION,\n                            data[1], {}, 'wamp.error.no_such_procedure']);\n                        this._cache.opStatus = WAMP_ERROR_MSG.NON_EXIST_RPC_INVOCATION;\n                    }\n\n                    break;\n                // case WAMP_MSG_SPEC.INTERRUPT:\n                //     // WAMP SPEC:\n                //     break;\n                // case WAMP_MSG_SPEC.YIELD:\n                //     // WAMP SPEC:\n                //     break;\n                default:\n                    this._log('[wampy] Received non-compliant WAMP message');\n                    break;\n            }\n        }, err => console.error(err));\n    }\n\n    /**\n     * Internal websocket on error callback\n     * @param {object} error\n     * @private\n     */\n    _wsOnError (error) {\n        this._log('[wampy] websocket error');\n\n        if (this._options.onError) {\n            this._options.onError({ error: error });\n        }\n    }\n\n    /**\n     * Reconnect to server in case of websocket error\n     * @private\n     */\n    _wsReconnect () {\n        this._log('[wampy] websocket reconnecting...');\n\n        if (this._options.onReconnect) {\n            this._options.onReconnect();\n        }\n\n        this._cache.reconnectingAttempts++;\n        this._ws = getWebSocket(this._url, this._protocols, this._options.ws);\n        this._initWsCallbacks();\n    }\n\n    /**\n     * Resubscribe to topics in case of communication error\n     * @private\n     */\n    _renewSubscriptions () {\n        let i;\n        const subs = this._subscriptions,\n            st = this._subsTopics;\n\n        this._subscriptions = {};\n        this._subsTopics = new Set();\n\n        for (let topic of st) {\n            i = subs[topic].callbacks.length;\n            while (i--) {\n                this.subscribe(topic, subs[topic].callbacks[i]);\n            }\n        }\n    }\n\n    /**\n     * Reregister RPCs in case of communication error\n     * @private\n     */\n    _renewRegistrations () {\n        const rpcs = this._rpcRegs,\n            rn = this._rpcNames;\n\n        this._rpcRegs = {};\n        this._rpcNames = new Set();\n\n        for (let rpcName of rn) {\n            this.register(rpcName, { rpc: rpcs[rpcName].callbacks[0] });\n        }\n    }\n\n    /* Wampy public API */\n\n    /**\n     * Get or set Wampy options\n     *\n     * To get options - call without parameters\n     * To set options - pass hash-table with options values\n     *\n     * @param {object} [opts]\n     * @returns {*}\n     */\n    options (opts) {\n        if (typeof (opts) === 'undefined') {\n            return this._options;\n        } else if (this._isPlainObject(opts)) {\n            this._options = this._merge(this._options, opts);\n            return this;\n        }\n    }\n\n    /**\n     * Get the status of last operation\n     *\n     * @returns {object} with 2 fields: code, description\n     *      code: 0 - if operation was successful\n     *      code > 0 - if error occurred\n     *      description contains details about error\n     *      reqId: last send request ID\n     */\n    getOpStatus () {\n        return this._cache.opStatus;\n    }\n\n    /**\n     * Get the WAMP Session ID\n     *\n     * @returns {string} Session ID\n     */\n    getSessionId () {\n        return this._cache.sessionId;\n    }\n\n    /**\n     * Connect to server\n     * @param {string} [url] New url (optional)\n     * @returns {Wampy}\n     */\n    connect (url) {\n        if (url) {\n            this._url = url;\n        }\n\n        if (this._options.realm) {\n\n            const authp = (this._options.authid ? 1 : 0) +\n                ((this._isArray(this._options.authmethods) && this._options.authmethods.length) ? 1 : 0) +\n                (typeof this._options.onChallenge === 'function' ? 1 : 0);\n\n            if (authp > 0 && authp < 3) {\n                this._cache.opStatus = WAMP_ERROR_MSG.NO_CRA_CB_OR_ID;\n                return this;\n            }\n\n            this._setWsProtocols();\n            this._ws = getWebSocket(this._url, this._protocols, this._options.ws);\n            if (!this._ws) {\n                this._cache.opStatus = WAMP_ERROR_MSG.NO_WS_OR_URL;\n                return this;\n            }\n            this._initWsCallbacks();\n\n        } else {\n            this._cache.opStatus = WAMP_ERROR_MSG.NO_REALM;\n        }\n\n        return this;\n    }\n\n    /**\n     * Disconnect from server\n     * @returns {Wampy}\n     */\n    disconnect () {\n        if (this._cache.sessionId) {\n            // need to send goodbye message to server\n            this._cache.isSayingGoodbye = true;\n            this._send([WAMP_MSG_SPEC.GOODBYE, {}, 'wamp.error.system_shutdown']);\n        } else if (this._ws) {\n            this._ws.close();\n        }\n\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n\n        return this;\n    }\n\n    /**\n     * Abort WAMP session establishment\n     *\n     * @returns {Wampy}\n     */\n    abort () {\n\n        if (!this._cache.sessionId && this._ws.readyState === 1) {\n            this._send([WAMP_MSG_SPEC.ABORT, {}, 'wamp.error.abort']);\n            this._cache.sessionId = null;\n        }\n\n        this._ws.close();\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n\n        return this;\n    }\n\n    /**\n     * Subscribe to a topic on a broker\n     *\n     * @param {string} topicURI\n     * @param {function|object} callbacks - if it is a function - it will be treated as published event callback\n     *                          or it can be hash table of callbacks:\n     *                          { onSuccess: will be called when subscribe would be confirmed\n     *                            onError: will be called if subscribe would be aborted\n     *                            onEvent: will be called on receiving published event }\n     *\n     * @returns {Wampy}\n     */\n    subscribe (topicURI, callbacks) {\n        let reqId;\n\n        if (!this._preReqChecks(topicURI, 'broker', callbacks)) {\n            return this;\n        }\n\n        if (typeof callbacks === 'function') {\n            callbacks = { onEvent: callbacks };\n        } else if (!this._isPlainObject(callbacks) || typeof (callbacks.onEvent) === 'undefined') {\n            this._cache.opStatus = WAMP_ERROR_MSG.NO_CALLBACK_SPEC;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        if (!this._subscriptions[topicURI] || !this._subscriptions[topicURI].callbacks.length) {\n            // no such subscription or processing unsubscribing\n\n            reqId = this._getReqId();\n\n            this._requests[reqId] = {\n                topic: topicURI,\n                callbacks: callbacks\n            };\n\n            // WAMP SPEC: [SUBSCRIBE, Request|id, Options|dict, Topic|uri]\n            this._send([WAMP_MSG_SPEC.SUBSCRIBE, reqId, {}, topicURI]);\n\n        } else {    // already have subscription to this topic\n            // There is no such callback yet\n            if (this._subscriptions[topicURI].callbacks.indexOf(callbacks.onEvent) < 0) {\n                this._subscriptions[topicURI].callbacks.push(callbacks.onEvent);\n            }\n\n            if (callbacks.onSuccess) {\n                callbacks.onSuccess();\n            }\n        }\n\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n        return this;\n    }\n\n    /**\n     * Unsubscribe from topic\n     * @param {string} topicURI\n     * @param {function|object} callbacks - if it is a function - it will be treated as\n     *                          published event callback to remove or it can be hash table of callbacks:\n     *                          { onSuccess: will be called when unsubscribe would be confirmed\n     *                            onError: will be called if unsubscribe would be aborted\n     *                            onEvent: published event callback to remove }\n     * @returns {Wampy}\n     */\n    unsubscribe (topicURI, callbacks) {\n        let reqId, i = -1;\n\n        if (!this._preReqChecks(null, 'broker', callbacks)) {\n            return this;\n        }\n\n        if (this._subscriptions[topicURI]) {\n\n            reqId = this._getReqId();\n\n            if (typeof (callbacks) === 'undefined') {\n                this._subscriptions[topicURI].callbacks = [];\n                callbacks = {};\n            } else if (typeof callbacks === 'function') {\n                i = this._subscriptions[topicURI].callbacks.indexOf(callbacks);\n                callbacks = {};\n            } else if (callbacks.onEvent && typeof callbacks.onEvent === 'function') {\n                i = this._subscriptions[topicURI].callbacks.indexOf(callbacks.onEvent);\n            } else {\n                this._subscriptions[topicURI].callbacks = [];\n            }\n\n            if (i >= 0) {\n                this._subscriptions[topicURI].callbacks.splice(i, 1);\n            }\n\n            if (this._subscriptions[topicURI].callbacks.length) {\n                // There are another callbacks for this topic\n                this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n                return this;\n            }\n\n            this._requests[reqId] = {\n                topic: topicURI,\n                callbacks: callbacks\n            };\n\n            // WAMP_SPEC: [UNSUBSCRIBE, Request|id, SUBSCRIBED.Subscription|id]\n            this._send([WAMP_MSG_SPEC.UNSUBSCRIBE, reqId, this._subscriptions[topicURI].id]);\n\n        } else {\n            this._cache.opStatus = WAMP_ERROR_MSG.NON_EXIST_UNSUBSCRIBE;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n        return this;\n    }\n\n    /**\n     * Publish a event to topic\n     * @param {string} topicURI\n     * @param {string|number|Array|object} payload - optional parameter.\n     * @param {object} [callbacks] - optional hash table of callbacks:\n     *                          { onSuccess: will be called when publishing would be confirmed\n     *                            onError: will be called if publishing would be aborted }\n     * @param {object} advancedOptions - optional parameter. Must include any or all of the options:\n     *                          { exclude: integer|array WAMP session id(s) that won't receive a published event,\n     *                                      even though they may be subscribed\n     *                            exclude_authid: string|array Authentication id(s) that won't receive\n     *                                      a published event, even though they may be subscribed\n     *                            exclude_authrole: string|array Authentication role(s) that won't receive\n     *                                      a published event, even though they may be subscribed\n     *                            eligible: integer|array WAMP session id(s) that are allowed\n     *                                      to receive a published event\n     *                            eligible_authid: string|array Authentication id(s) that are allowed\n     *                                      to receive a published event\n     *                            eligible_authrole: string|array Authentication role(s) that are allowed\n     *                                      to receive a published event\n     *                            exclude_me: bool flag of receiving publishing event by initiator\n     *                            disclose_me: bool flag of disclosure of publisher identity (its WAMP session ID)\n     *                                      to receivers of a published event }\n     * @returns {Wampy}\n     */\n    publish (topicURI, payload, callbacks, advancedOptions) {\n        let reqId, msg, err = false, hasPayload = false;\n        const options = {};\n\n        if (!this._preReqChecks(topicURI, 'broker', callbacks)) {\n            return this;\n        }\n\n        if (this._isPlainObject(callbacks)) {\n            options.acknowledge = true;\n        }\n\n        if (typeof (advancedOptions) !== 'undefined') {\n\n            if (this._isPlainObject(advancedOptions)) {\n                if (advancedOptions.exclude) {\n                    if (this._isArray(advancedOptions.exclude) && advancedOptions.exclude.length) {\n                        options.exclude = advancedOptions.exclude;\n                    } else if (typeof advancedOptions.exclude === 'number') {\n                        options.exclude = [advancedOptions.exclude];\n                    } else {\n                        err = true;\n                    }\n                }\n\n                if (advancedOptions.exclude_authid) {\n                    if (this._isArray(advancedOptions.exclude_authid) && advancedOptions.exclude_authid.length) {\n                        options.exclude_authid = advancedOptions.exclude_authid;\n                    } else if (typeof advancedOptions.exclude_authid === 'string') {\n                        options.exclude_authid = [advancedOptions.exclude_authid];\n                    } else {\n                        err = true;\n                    }\n                }\n\n                if (advancedOptions.exclude_authrole) {\n                    if (this._isArray(advancedOptions.exclude_authrole) && advancedOptions.exclude_authrole.length) {\n                        options.exclude_authrole = advancedOptions.exclude_authrole;\n                    } else if (typeof advancedOptions.exclude_authrole === 'string') {\n                        options.exclude_authrole = [advancedOptions.exclude_authrole];\n                    } else {\n                        err = true;\n                    }\n                }\n\n                if (advancedOptions.eligible) {\n                    if (this._isArray(advancedOptions.eligible) && advancedOptions.eligible.length) {\n                        options.eligible = advancedOptions.eligible;\n                    } else if (typeof advancedOptions.eligible === 'number') {\n                        options.eligible = [advancedOptions.eligible];\n                    } else {\n                        err = true;\n                    }\n                }\n\n                if (advancedOptions.eligible_authid) {\n                    if (this._isArray(advancedOptions.eligible_authid) && advancedOptions.eligible_authid.length) {\n                        options.eligible_authid = advancedOptions.eligible_authid;\n                    } else if (typeof advancedOptions.eligible_authid === 'string') {\n                        options.eligible_authid = [advancedOptions.eligible_authid];\n                    } else {\n                        err = true;\n                    }\n                }\n\n                if (advancedOptions.eligible_authrole) {\n                    if (this._isArray(advancedOptions.eligible_authrole) && advancedOptions.eligible_authrole.length) {\n                        options.eligible_authrole = advancedOptions.eligible_authrole;\n                    } else if (typeof advancedOptions.eligible_authrole === 'string') {\n                        options.eligible_authrole = [advancedOptions.eligible_authrole];\n                    } else {\n                        err = true;\n                    }\n                }\n\n                if (advancedOptions.hasOwnProperty('exclude_me')) {\n                    options.exclude_me = advancedOptions.exclude_me !== false;\n                }\n\n                if (advancedOptions.hasOwnProperty('disclose_me')) {\n                    options.disclose_me = advancedOptions.disclose_me === true;\n                }\n\n            } else {\n                err = true;\n            }\n\n            if (err) {\n                this._cache.opStatus = WAMP_ERROR_MSG.INVALID_PARAM;\n\n                if (this._isPlainObject(callbacks) && callbacks.onError) {\n                    callbacks.onError({ error: this._cache.opStatus.description });\n                }\n\n                return this;\n            }\n        }\n\n        reqId = this._getReqId();\n\n        switch (arguments.length) {\n            case 1:\n                break;\n            case 2:\n                hasPayload = true;\n                break;\n            default:\n                this._requests[reqId] = {\n                    topic: topicURI,\n                    callbacks: callbacks\n                };\n                hasPayload = true;\n                break;\n        }\n\n        // WAMP_SPEC: [PUBLISH, Request|id, Options|dict, Topic|uri]\n        msg = [WAMP_MSG_SPEC.PUBLISH, reqId, options, topicURI];\n\n        if (hasPayload) {\n            // WAMP_SPEC: [PUBLISH, Request|id, Options|dict, Topic|uri, Arguments|list (, ArgumentsKw|dict)]\n            if (this._isArray(payload)) {\n                msg.push(payload);\n            } else if (this._isPlainObject(payload)) {\n                // It's a wampy unified form of payload passing\n                if (payload.argsList || payload.argsDict) {\n                    if (payload.argsList) {\n                        msg.push(payload.argsList);\n                    }\n\n                    if (payload.argsDict) {\n                        if (msg.length === 4) {\n                            msg.push([]);\n                        }\n                        msg.push(payload.argsDict);\n                    }\n                } else {\n                    msg.push([], payload);\n                }\n            } else {    // assume it's a single value\n                msg.push([payload]);\n            }\n        }\n\n        this._send(msg);\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n        return this;\n    }\n\n    /**\n     * Remote Procedure Call\n     * @param {string} topicURI\n     * @param {string|number|Array|object} payload - can be either a value of any type or null\n     * @param {function|object} callbacks - if it is a function - it will be treated as result callback function\n     *                          or it can be hash table of callbacks:\n     *                          { onSuccess: will be called with result on successful call\n     *                            onError: will be called if invocation would be aborted }\n     * @param {object} advancedOptions - optional parameter. Must include any or all of the options:\n     *                          { disclose_me: bool flag of disclosure of Caller identity (WAMP session ID)\n     *                                  to endpoints of a routed call\n     *                            receive_progress: bool flag for receiving progressive results. In this case\n     *                                  onSuccess function will be called every time on receiving result\n     *                            timeout: integer timeout (in ms) for the call to finish }\n     * @returns {Wampy}\n     */\n    call (topicURI, payload, callbacks, advancedOptions) {\n        let reqId, msg, err = false;\n        const options = {};\n\n        if (!this._preReqChecks(topicURI, 'dealer', callbacks)) {\n            return this;\n        }\n\n        if (typeof callbacks === 'function') {\n            callbacks = { onSuccess: callbacks };\n        } else if (!this._isPlainObject(callbacks) || typeof (callbacks.onSuccess) === 'undefined') {\n            this._cache.opStatus = WAMP_ERROR_MSG.NO_CALLBACK_SPEC;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        if (typeof (advancedOptions) !== 'undefined') {\n\n            if (this._isPlainObject(advancedOptions)) {\n                if (advancedOptions.hasOwnProperty('disclose_me')) {\n                    options.disclose_me = advancedOptions.disclose_me === true;\n                }\n\n                if (advancedOptions.hasOwnProperty('receive_progress')) {\n                    options.receive_progress = advancedOptions.receive_progress === true;\n                }\n\n                if (advancedOptions.hasOwnProperty('timeout')) {\n                    if (typeof advancedOptions.timeout === 'number') {\n                        options.timeout = advancedOptions.timeout;\n                    } else {\n                        err = true;\n                    }\n                }\n\n            } else {\n                err = true;\n            }\n\n            if (err) {\n                this._cache.opStatus = WAMP_ERROR_MSG.INVALID_PARAM;\n\n                if (this._isPlainObject(callbacks) && callbacks.onError) {\n                    callbacks.onError({ error: this._cache.opStatus.description });\n                }\n\n                return this;\n            }\n        }\n\n        do {\n            reqId = this._getReqId();\n        } while (reqId in this._calls);\n\n        this._calls[reqId] = callbacks;\n\n        // WAMP SPEC: [CALL, Request|id, Options|dict, Procedure|uri, (Arguments|list, ArgumentsKw|dict)]\n        msg = [WAMP_MSG_SPEC.CALL, reqId, options, topicURI];\n\n        if (payload !== null) {\n            if (this._isArray(payload)) {\n                msg.push(payload);\n            } else if (this._isPlainObject(payload)) {\n                // It's a wampy unified form of payload passing\n                if (payload.argsList || payload.argsDict) {\n                    if (payload.argsList) {\n                        msg.push(payload.argsList);\n                    }\n\n                    if (payload.argsDict) {\n                        if (msg.length === 4) {\n                            msg.push([]);\n                        }\n                        msg.push(payload.argsDict);\n                    }\n                } else {\n                    msg.push([], payload);\n                }\n            } else {    // assume it's a single value\n                msg.push([payload]);\n            }\n        }\n\n        this._send(msg);\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n        return this;\n    }\n\n    /**\n     * RPC invocation cancelling\n     *\n     * @param {int} reqId RPC call request ID\n     * @param {function|object} callbacks - if it is a function - it will be called if successfully\n     *                          sent canceling message or it can be hash table of callbacks:\n     *                          { onSuccess: will be called if successfully sent canceling message\n     *                            onError: will be called if some error occurred }\n     * @param {object} advancedOptions - optional parameter. Must include any or all of the options:\n     *                          { mode: string|one of the possible modes:\n     *                                  \"skip\" | \"kill\" | \"killnowait\". Skip is default.\n     *                          }\n     *\n     * @returns {Wampy}\n     */\n    cancel (reqId, callbacks, advancedOptions) {\n        const options = { mode: 'skip' };\n\n        if (!this._preReqChecks(null, 'dealer', callbacks)) {\n            return this;\n        }\n\n        if (!reqId || !this._calls[reqId]) {\n            this._cache.opStatus = WAMP_ERROR_MSG.NON_EXIST_RPC_REQ_ID;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        if ((typeof (advancedOptions) !== 'undefined') &&\n            (this._isPlainObject(advancedOptions)) &&\n            (advancedOptions.hasOwnProperty('mode'))) {\n\n            options.mode = /skip|kill|killnowait/.test(advancedOptions.mode) ? advancedOptions.mode : 'skip';\n        }\n\n        // WAMP SPEC: [CANCEL, CALL.Request|id, Options|dict]\n        this._send([WAMP_MSG_SPEC.CANCEL, reqId, options]);\n        this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n        this._cache.opStatus.reqId = reqId;\n\n        callbacks.onSuccess && callbacks.onSuccess();\n\n        return this;\n    }\n\n    /**\n     * RPC registration for invocation\n     * @param {string} topicURI\n     * @param {function|object} callbacks - if it is a function - it will be treated as rpc itself\n     *                          or it can be hash table of callbacks:\n     *                          { rpc: registered procedure\n     *                            onSuccess: will be called on successful registration\n     *                            onError: will be called if registration would be aborted }\n     * @returns {Wampy}\n     */\n    register (topicURI, callbacks) {\n        let reqId;\n\n        if (!this._preReqChecks(topicURI, 'dealer', callbacks)) {\n            return this;\n        }\n\n        if (typeof callbacks === 'function') {\n            callbacks = { rpc: callbacks };\n        } else if (!this._isPlainObject(callbacks) || typeof (callbacks.rpc) === 'undefined') {\n            this._cache.opStatus = WAMP_ERROR_MSG.NO_CALLBACK_SPEC;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n            return this;\n        }\n\n        if (!this._rpcRegs[topicURI] || !this._rpcRegs[topicURI].callbacks.length) {\n            // no such registration or processing unregistering\n\n            reqId = this._getReqId();\n\n            this._requests[reqId] = {\n                topic: topicURI,\n                callbacks: callbacks\n            };\n\n            // WAMP SPEC: [REGISTER, Request|id, Options|dict, Procedure|uri]\n            this._send([WAMP_MSG_SPEC.REGISTER, reqId, {}, topicURI]);\n            this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n            this._cache.opStatus.reqId = reqId;\n        } else {    // already have registration with such topicURI\n            this._cache.opStatus = WAMP_ERROR_MSG.RPC_ALREADY_REGISTERED;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n        }\n\n        return this;\n\n    }\n\n    /**\n     * RPC unregistration for invocation\n     * @param {string} topicURI\n     * @param {function|object} callbacks - if it is a function, it will be called on successful unregistration\n     *                          or it can be hash table of callbacks:\n     *                          { onSuccess: will be called on successful unregistration\n     *                            onError: will be called if unregistration would be aborted }\n     * @returns {Wampy}\n     */\n    unregister (topicURI, callbacks) {\n        let reqId;\n\n        if (!this._preReqChecks(topicURI, 'dealer', callbacks)) {\n            return this;\n        }\n\n        if (typeof callbacks === 'function') {\n            callbacks = { onSuccess: callbacks };\n        }\n\n        if (this._rpcRegs[topicURI]) {   // there is such registration\n\n            reqId = this._getReqId();\n\n            this._requests[reqId] = {\n                topic: topicURI,\n                callbacks: callbacks\n            };\n\n            // WAMP SPEC: [UNREGISTER, Request|id, REGISTERED.Registration|id]\n            this._send([WAMP_MSG_SPEC.UNREGISTER, reqId, this._rpcRegs[topicURI].id]);\n            this._cache.opStatus = WAMP_ERROR_MSG.SUCCESS;\n            this._cache.opStatus.reqId = reqId;\n        } else {    // there is no registration with such topicURI\n            this._cache.opStatus = WAMP_ERROR_MSG.NON_EXIST_RPC_UNREG;\n\n            if (this._isPlainObject(callbacks) && callbacks.onError) {\n                callbacks.onError({ error: this._cache.opStatus.description });\n            }\n\n        }\n\n        return this;\n    }\n}\n\nexport default Wampy;\nexport {Wampy};\n"]}
>>>>>>> fd31f7048c6baae69859a52b1fbba8022d558ec9
