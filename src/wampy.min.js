!function(window,undefined){function getServerUrl(url){var scheme,port,path;return url?/^ws/.test(url)?url:/:\d{1,5}/.test(url)?(scheme="https:"===window.location.protocol?"wss://":"ws://",scheme+url):(scheme="https:"===window.location.protocol?"wss://":"ws://",port=""!==window.location.port?":"+window.location.port:"",path="/"===url[0]?url:"/"+url,scheme+window.location.hostname+port+path):(scheme="https:"===window.location.protocol?"wss://":"ws://",port=""!==window.location.port?":"+window.location.port:"",scheme+window.location.hostname+port+"/ws")}function generateId(){for(var keyChars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",keyLen=16,key="",l=keyChars.length;keyLen--;)key+=keyChars.charAt(Math.floor(Math.random()*l));return key}function getWebSocket(url,protocols){var parsedUrl=getServerUrl(url);return"WebSocket"in window?protocols?new WebSocket(parsedUrl,protocols):new WebSocket(parsedUrl):"MozWebSocket"in window?protocols?new MozWebSocket(parsedUrl,protocols):new MozWebSocket(parsedUrl):null}var WAMP_SPEC={TYPE_ID_WELCOME:0,TYPE_ID_PREFIX:1,TYPE_ID_CALL:2,TYPE_ID_CALLRESULT:3,TYPE_ID_CALLERROR:4,TYPE_ID_SUBSCRIBE:5,TYPE_ID_UNSUBSCRIBE:6,TYPE_ID_PUBLISH:7,TYPE_ID_EVENT:8},prefixMap=function(){this._pref2uri={},this._uri2pref={}};prefixMap.prototype.get=function(prefix){return this._pref2uri[prefix]},prefixMap.prototype.set=function(prefix,uri){this._pref2uri[prefix]=uri,this._uri2pref[prefix]=uri},prefixMap.prototype.remove=function(prefix){this._pref2uri[prefix]&&(delete this._uri2pref[this._pref2uri[prefix]],delete this._pref2uri[prefix])},prefixMap.prototype.reset=function(){this._pref2uri={},this._uri2pref={}},prefixMap.prototype.resolve=function(uri){var prefix,isSchema=/^http(s)?:\/\//.test(uri),i=uri.indexOf(":");return!isSchema&&i>=0?(prefix=uri.substring(0,i),this._pref2uri[prefix]?this._pref2uri[prefix]+uri.substring(i+1):null):uri};var Wampy=function(url){switch(this.version="v0.1.0",this._url=url,this._protocols=[],this._cache={sessionId:null,protocolVersion:1,timer:null,reconnectingAttempts:0,welcome:!1,onConnect:null,onClose:null,onError:null,onReconnect:null},this._serverIdent=null,this._ws=null,this._queue=[],this._calls={},this._subscriptions={},this._isInitialized=!1,this._options={autoReconnect:!0,reconnectInterval:2e3,maxRetries:25},this._prefixMap=new prefixMap,arguments.length){case 1:"string"==typeof arguments[0]?this._ws=getWebSocket(arguments[0]):this._options=this._merge(this._options,arguments[0]);break;case 2:"string"==typeof arguments[0]&&arguments[1]instanceof Array?(this._protocols=arguments[1],this._ws=getWebSocket(arguments[0],arguments[1])):(this._ws=getWebSocket(arguments[0]),this._options=this._merge(this._options,arguments[1]));break;case 3:this._protocols=arguments[1],this._ws=getWebSocket(arguments[0],arguments[1]),this._options=this._merge(this._options,arguments[2])}this._initWsCallbacks()};Wampy.prototype._merge=function(){var i,attr,obj={},l=arguments.length;for(i=0;l>i;i++)for(attr in arguments[i])obj[attr]=arguments[i][attr];return obj},Wampy.prototype._send=function(msg){if(msg&&this._queue.push(JSON.stringify(msg)),this._isInitialized&&1===this._ws.readyState)for(;this._queue.length;)this._ws.send(this._queue.shift())},Wampy.prototype._initWsCallbacks=function(){var self=this;this._ws.onopen=function(){self._wsOnOpen.call(self)},this._ws.onclose=function(event){self._wsOnClose.call(self,event)},this._ws.onmessage=function(event){self._wsOnMessage.call(self,event)},this._ws.onerror=function(error){self._wsOnError.call(self,error)}},Wampy.prototype._wsOnOpen=function(){console.log("[wampy] websocket connected")},Wampy.prototype._wsOnClose=function(){var self=this;console.log("[wampy] websocket disconnected"),this._cache.welcome=!1,this._isInitialized&&this._options.autoReconnect&&this._cache.reconnectingAttempts<this._options.maxRetries?this._cache.timer=window.setTimeout(function(){self._wsReconnect.call(self)},this._options.reconnectInterval):(this._options.onClose&&this._options.onClose(),this.disconnect())},Wampy.prototype._wsOnMessage=function(event){var data,i,uri;switch(console.log("[wampy] websocket message received: ",event.data),data=JSON.parse(event.data),data[0]){case WAMP_SPEC.TYPE_ID_WELCOME:this._cache.sessionId=data[1],this._cache.protocolVersion=data[2],this._serverIdent=data[3],this._isInitialized=!0,this._options.onConnect&&this._options.onConnect(),this._send();break;case WAMP_SPEC.TYPE_ID_CALLRESULT:this._calls[data[1]]&&this._calls[data[1]].callRes&&this._calls[data[1]].callRes(data[2]);break;case WAMP_SPEC.TYPE_ID_CALLERROR:this._calls[data[1]]&&this._calls[data[1]].callErr&&this._calls[data[1]].callErr(data[3],data[4]);break;case WAMP_SPEC.TYPE_ID_EVENT:if(uri=this._prefixMap.resolve(data[1]),this._subscriptions[uri])for(i=this._subscriptions[uri].length;i--;)this._subscriptions[uri][i](data[2])}},Wampy.prototype._wsOnError=function(){console.log("[wampy] websocket error"),this._options.onError&&this._options.onError()},Wampy.prototype._wsReconnect=function(){console.log("[wampy] websocket reconnecting..."),this._options.onReconnect&&this._options.onReconnect(),this._cache.reconnectingAttempts++,this._ws=getWebSocket(this._url,this._protocols),this._initWsCallbacks()},Wampy.prototype.options=function(opts){return opts===undefined?this._options:"object"==typeof opts?(this._options=this._merge(this._options,opts),this):void 0},Wampy.prototype.connect=function(url,protocols){return url&&(this._url=url),this._protocols=protocols instanceof Array?protocols:[],this._ws=getWebSocket(this._url,this._protocols),this},Wampy.prototype.disconnect=function(){return this._isInitialized&&(this._isInitialized=!1,this._ws.close(),this._serverIdent=null,this._prefixMap.reset(),this._ws=null,this._queue=[],this._subscriptions={},this._calls={},this._cache={protocolVersion:1,reconnectingAttempts:0}),this},Wampy.prototype.prefix=function(prefix,uri){return this._prefixMap.set(prefix,uri),this._send([WAMP_SPEC.TYPE_ID_PREFIX,prefix,uri]),this},Wampy.prototype.unprefix=function(prefix){return this._prefixMap.remove(prefix),this},Wampy.prototype.call=function(procURI,callbacks){for(var i,callId=generateId(),l=arguments.length,msg=[WAMP_SPEC.TYPE_ID_CALL];callId in this._calls;)callId=generateId();for(this._calls[callId]=callbacks,msg.push(callId),msg.push(procURI),i=2;l>i;i++)msg.push(arguments[i]);return this._send(msg),this},Wampy.prototype.subscribe=function(topicURI,callback){var uri=this._prefixMap.resolve(topicURI);return this._subscriptions[uri]||(this._subscriptions[uri]=[],this._send([WAMP_SPEC.TYPE_ID_SUBSCRIBE,topicURI])),this._subscriptions[uri].indexOf(callback)<0&&this._subscriptions[uri].push(callback),this},Wampy.prototype.unsubscribe=function(topicURI,callback){var i,uri=this._prefixMap.resolve(topicURI);if(this._subscriptions[uri]){if(callback!==undefined&&(i=this._subscriptions[uri].indexOf(callback),i>=0&&this._subscriptions[uri].splice(i,1),this._subscriptions[uri].length))return this;this._send([WAMP_SPEC.TYPE_ID_UNSUBSCRIBE,topicURI]),delete this._subscriptions[uri]}return this},Wampy.prototype.publish=function(topicURI,event,exclude,eligible){var msg=[WAMP_SPEC.TYPE_ID_PUBLISH,topicURI,event];switch(arguments.length){case 2:this._send(msg);break;case 3:("boolean"==typeof exclude||exclude instanceof Array)&&(msg.push(exclude),this._send(msg));break;case 4:exclude instanceof Array&&eligible instanceof Array&&(msg.push(exclude),msg.push(eligible),this._send(msg))}return this},window.Wampy=Wampy}(window);